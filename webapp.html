<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Yo Store - Магазин электроники</title>
    <meta name="app-version" content="20241105-001">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #333;
            overflow-x: hidden;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        
        html {
            width: 100%;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }
        
        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            padding: 0 20px 20px 20px; /* шапка примыкает к верху */
            box-sizing: border-box;
            flex: 1 0 auto; /* растягиваем контент, чтобы футер был внизу */
        }
        
        /* Убираем лишние отступы сверху на мобильных */
        @media (max-width: 480px) {
            body {
                padding-top: 0;
                margin-top: 0;
            }
            
            .container {
                padding-top: 0;
                margin-top: 0;
            }
            
            .header {
                margin-top: 20px;
                margin-bottom: 0;
            }
            
            .catalog-btn {
                padding: 8px;
                font-size: 0;
                gap: 0;
                min-width: 40px;
                width: 40px;
                justify-content: center;
            }
            
            .catalog-btn .dropdown-arrow {
                display: none;
            }
            
            .catalog-btn svg:first-of-type {
                width: 20px;
                height: 20px;
            }
            
            .catalog-btn span,
            .catalog-btn .catalog-text {
                display: none;
            }
            
            .catalog-dropdown-menu {
                width: 85vw;
            }
            
            .catalog-dropdown-item {
                padding: 10px 12px;
            }
            
            .catalog-dropdown-item .category-icon {
                width: 28px;
                height: 28px;
            }
        }
        
        /* Мобильные устройства */
        @media screen and (max-width: 768px) {
            .container {
                padding: 15px;
                width: 100%;
                max-width: none;
            }
            
            body {
                width: 100vw;
                overflow-x: hidden;
            }
            
            html {
                width: 100vw;
                overflow-x: hidden;
            }
            
            .header-desktop {
                display: none !important;
            }
            
            .header-mobile {
                display: block !important;
            }
            
            .header {
                padding: 10px 0;
            }
            
            .catalog-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
                gap: 4px;
                background: transparent !important;
                color: #374151 !important;
                border: 1px solid rgba(0, 0, 0, 0.1) !important;
            }
            
            .catalog-btn:hover {
                background: rgba(0, 0, 0, 0.05) !important;
                border-color: rgba(0, 0, 0, 0.15) !important;
            }
            
            .catalog-btn:active {
                background: rgba(0, 0, 0, 0.1) !important;
            }
            
            .catalog-btn svg {
                width: 16px;
                height: 16px;
                stroke: #2d6cdf !important;
            }
            
            .catalog-dropdown-menu {
                width: 85vw;
            }
            
            .search-bar {
                max-width: none;
                flex: 1;
            }
            
            .logo {
                width: 40px;
                height: 40px;
            }
            
            .header-top-mobile {
                position: relative;
            }
            
            .header-top-mobile h1 {
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
                margin: 0;
                z-index: 1;
            }
            
            .header-top-mobile .catalog-dropdown {
                flex-shrink: 0;
                z-index: 2;
            }
            
            .header-top-mobile .cart-icon-btn-header {
                flex-shrink: 0;
                margin-left: auto;
                z-index: 2;
            }
            
            
            .cart-icon-btn {
                top: 20px !important;
                right: 15px !important;
                left: auto !important;
                width: 48px;
                height: 48px;
            }
            
            .cart-icon-btn svg {
                width: 20px;
                height: 20px;
            }
            
            .catalog-icon-btn {
                top: 20px !important;
                left: 15px !important;
                right: auto !important;
                width: 48px;
                height: 48px;
            }
            
            .catalog-icon-btn svg {
                width: 20px;
                height: 20px;
            }
            
            .search-bar-mobile {
                width: 100%;
            }
            
            .search-bar-mobile .search-input {
                width: 100%;
                border: none;
                outline: none;
                background: transparent;
                font-size: 0.9rem;
            }
            
            .search-bar-mobile .search-icon-btn {
                position: absolute;
                right: 8px;
                top: 50%;
                transform: translateY(-50%);
                background: transparent;
                border: none;
                cursor: pointer;
                padding: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .quick-menu-mobile {
                display: flex !important;
                padding: 6px 8px;
                margin-bottom: 6px;
                gap: 4px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .quick-menu-mobile::-webkit-scrollbar {
                display: none;
            }
            
            .quick-menu-mobile .quick-menu-item {
                font-size: 0.7rem;
                padding: 4px 6px;
                flex-shrink: 0;
                white-space: nowrap;
            }
        }
        
        .header {
            color: #111827;
            background: transparent;
            border-bottom: none;
            border-radius: 0;
            margin: 20px 0;
            padding: 10px 0;
        }
        
        .header-desktop {
            display: block;
        }
        
        .header-mobile {
            display: none;
        }
        
        .header-top-links {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding-bottom: 8px;
            margin-bottom: 8px;
            border-bottom: 1px solid rgba(45, 108, 223, 0.2);
        }
        
        .header-top-links a {
            font-size: 0.875rem;
            color: #374151;
            text-decoration: none;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .header-top-links a:hover {
            color: #2d6cdf;
        }
        
        .header-main {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 15px;
        }
        
        .header-top-mobile {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .search-bar-mobile {
            background: white;
            border-radius: 14px;
            padding: 6px 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            position: relative;
            padding-right: 36px;
            display: flex;
            align-items: center;
            border: 1.5px solid rgba(45, 108, 223, 0.4);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .search-bar-mobile:focus-within {
            border-color: rgba(45, 108, 223, 0.6);
            box-shadow: 0 2px 15px rgba(45, 108, 223, 0.15);
        }
        
        .cart-icon-btn-header {
            position: relative;
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            margin-left: auto;
        }
        
        .cart-icon-btn-header:hover {
            background: #2d6cdf;
            border-color: #2d6cdf;
            color: white;
        }
        
        .cart-icon-btn-header svg {
            width: 20px;
            height: 20px;
        }
        
        .cart-icon-btn-header .cart-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #ef4444;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.7rem;
            font-weight: 600;
            min-width: 18px;
            text-align: center;
        }
        
        /* Показываем старую кнопку корзины только когда верхняя не видна */
        .cart-icon-btn.visible {
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        .header h1 {
            margin: 0;
            margin-left: 0;
            padding-left: 0;
            display: flex;
            align-items: center;
            justify-content: flex-start; /* логотип слева */
            flex-shrink: 0; /* не сжимается */
        }
        
        .logo {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            object-fit: cover;
        }
        
        /* Мобильная версия - размер логотипа как в планшете */
        @media (max-width: 480px) {
            .logo {
                width: 40px !important;
                height: 40px !important;
            }
        }
        
        .logo-link {
            text-decoration: none;
            display: inline-block;
            transition: transform 0.2s ease;
            cursor: pointer;
        }
        
        .logo-link:hover {
            transform: scale(1.05);
        }
        
        .catalog-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: #2d6cdf;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .catalog-btn:hover {
            background: #1f56bf;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(45, 108, 223, 0.3);
        }
        
        .catalog-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(45, 108, 223, 0.2);
        }
        
        .catalog-btn svg {
            flex-shrink: 0;
        }
        
        .catalog-btn .dropdown-arrow {
            margin-left: 4px;
            transition: transform 0.2s ease;
        }
        
        .catalog-dropdown {
            position: relative;
        }
        
        .catalog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .catalog-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        
            .catalog-dropdown-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 320px;
            max-width: 85vw;
            height: 100vh;
            background: white;
            box-shadow: 4px 0 24px rgba(0,0,0,0.15);
            z-index: 1000;
            padding: 0;
            border: none;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .catalog-dropdown-menu.show {
            transform: translateX(0);
        }
        
        .catalog-dropdown-header {
            padding: 20px;
            border-bottom: 1px solid rgba(45, 108, 223, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        
        .catalog-dropdown-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
            color: #111827;
        }
        
        .catalog-dropdown-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            transition: color 0.2s ease;
            border-radius: 8px;
        }
        
        .catalog-dropdown-close:hover {
            color: #111827;
            background: #f3f4f6;
        }
        
        .catalog-dropdown-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }
        
        .catalog-dropdown-menu .catalog-dropdown-item {
            opacity: 1;
        }
        
        .catalog-dropdown-loading {
            padding: 20px;
            text-align: center;
            color: #6b7280;
            font-size: 14px;
        }
        
        .catalog-dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #111827;
            text-decoration: none;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
                opacity: 1;
        }
        
        .catalog-dropdown-item:hover {
            background: #f3f4f6;
            color: #2d6cdf;
        }
        
        .catalog-dropdown-item .category-icon {
            width: 32px;
            height: 32px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .catalog-dropdown-item .category-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 6px;
        }
        
        .catalog-dropdown-item .category-info {
            flex: 1;
            min-width: 0;
        }
        
        .catalog-dropdown-item .category-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .catalog-dropdown-item .category-count {
            font-size: 12px;
            color: #6b7280;
        }
        
        .catalog-section-item {
            padding: 8px 16px !important;
        }
        
        .catalog-section-item .category-icon {
            width: 20px !important;
            height: 20px !important;
        }
        
        .catalog-section-item .category-name {
            font-size: 13px !important;
            font-weight: 500 !important;
        }
        
        .header p { display: none; }
        
        .search-bar {
            background: white;
            border-radius: 14px;
            padding: 6px 12px;
            margin-bottom: 0; /* убираем нижний отступ, так как теперь в header */
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            position: relative; /* для иконки справа */
            padding-right: 36px; /* место под кнопку */
            flex: 1; /* занимает оставшееся пространство */
            min-width: 0; /* позволяет сжиматься при необходимости */
            display: flex;
            align-items: center;
            border: 1.5px solid rgba(45, 108, 223, 0.4);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .search-bar:focus-within {
            border-color: rgba(45, 108, 223, 0.6);
            box-shadow: 0 2px 15px rgba(45, 108, 223, 0.15);
        }
        
        .search-input {
            width: 100%;
            border: none;
            outline: none;
            font-size: 0.85rem;
            background: transparent;
            line-height: 1.5;
            padding: 0;
            vertical-align: middle;
        }

        .search-icon-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 22px;
            height: 22px;
            display: grid;
            place-items: center;
            background: transparent;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            color: #6b7280; /* slate-500 */
        }
        .search-icon-btn:hover { color: #2d6cdf; background: #f3f4f6; }
        
        .quick-menu {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .quick-menu.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        .quick-menu-item {
            font-size: 1rem;
            color: #4b5563;
            text-decoration: none;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .quick-menu-item:hover {
            background: #f3f4f6;
            color: #2d6cdf;
        }
        
        .quick-menu-mobile {
            display: none;
        }
        
        .promo-banners-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            background: transparent;
        }
        
        .promo-banner {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            border-radius: 12px;
            padding: 0;
            color: white;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            opacity: 0;
            transform: translateY(30px);
            animation: fadeInUp 0.6s ease 0.1s forwards;
            display: flex;
            align-items: center;
            min-height: 90px;
        }
        
        .promo-banner-iphone17 {
            background: #000000 !important;
        }
        
        .promo-banner-iphone17:hover {
            background: #000000 !important;
        }
        
        .promo-banner-iphone17::before {
            background: transparent !important;
        }
        
        .promo-banner-iphone17::after {
            background: transparent !important;
        }
        
        .promo-banner-2 {
            background: #FFFFFF !important;
        }
        
        .promo-banner-2::before {
            background: transparent !important;
        }
        
        .promo-banner-2::after {
            background: transparent !important;
        }
        
        .promo-banner-2:hover {
            background: #FFFFFF !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(0, 0, 0, 0.05);
        }
        
        .promo-banner-2 .promo-image {
            border-radius: 0 12px 12px 0;
        }
        
        .promo-banner-2 .promo-image img,
        .promo-banner-2 .promo-image video {
            filter: none !important;
        }
        
        .promo-banner-2 .promo-text {
            color: #111827;
        }
        
        .promo-banner-2 .promo-title {
            font-family: "SF Pro Display", "SF Pro Icons", "Helvetica Neue", "Helvetica", "Arial", sans-serif;
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 50%, #374151 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 22px;
            font-weight: 530;
            margin-bottom: 6px;
            line-height: 1.07143;
            letter-spacing: -0.005em;
        }
        
        .promo-banner-2 .promo-subtitle {
            color: rgba(17, 24, 39, 0.75);
            font-weight: 500;
            letter-spacing: 0.2px;
        }
        
        .promo-banner-2 .promo-badge {
            background: linear-gradient(135deg, rgba(17, 24, 39, 0.08) 0%, rgba(17, 24, 39, 0.12) 100%);
            color: #111827;
            border: 1px solid rgba(17, 24, 39, 0.15);
            backdrop-filter: blur(10px);
            font-weight: 700;
        }
        
        .promo-banner-iphone17 .promo-title {
            font-family: "SF Pro Display", "SF Pro Icons", "Helvetica Neue", "Helvetica", "Arial", sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 50%, #e8edff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 22px;
            font-weight: 530;
            margin-bottom: 6px;
            line-height: 1.07143;
            letter-spacing: -0.005em;
            text-shadow: none;
        }
        
        .promo-banner-iphone17 .promo-subtitle {
            color: rgba(255, 255, 255, 0.85);
            font-weight: 500;
            letter-spacing: 0.2px;
        }
        
        .promo-banner-iphone17 .promo-badge {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.15) 100%);
            color: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.25);
        }
        
        .promo-banner::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.15) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }
        
        .promo-banner::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.3; }
            50% { transform: scale(1.2) rotate(180deg); opacity: 0.6; }
        }
        
        .promo-banner:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.2);
        }
        
        .promo-banner-content {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            width: 100%;
            padding: 10px 15px;
            gap: 15px;
        }
        
        .promo-text {
            flex: 1;
            max-width: 50%;
            align-self: flex-start;
            padding-top: 0;
        }
        
        .promo-badge {
            display: inline-block;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.15) 100%);
            backdrop-filter: blur(20px);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.55rem;
            font-weight: 700;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            color: rgba(255, 255, 255, 0.95);
        }
        
        .promo-title {
            font-family: "SF Pro Display", "SF Pro Icons", "Helvetica Neue", "Helvetica", "Arial", sans-serif;
            font-size: 22px;
            font-weight: 530;
            margin-bottom: 6px;
            text-shadow: none;
            background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 50%, #e0e7ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.07143;
            letter-spacing: -0.005em;
        }
        
        .promo-subtitle {
            font-size: 0.85rem;
            opacity: 0.95;
            font-weight: 500;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.9);
            letter-spacing: 0.2px;
        }
        
        .promo-image {
            flex: 1;
            max-width: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .promo-image img,
        .promo-image video {
            max-width: 100%;
            height: auto;
            max-height: 180px;
            object-fit: contain;
            filter: drop-shadow(0 20px 40px rgba(0, 0, 0, 0.4));
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .promo-banner:hover .promo-image img,
        .promo-banner:hover .promo-image video {
            transform: scale(1.05) rotate(-2deg);
        }
        
        /* Карусель для мобильной версии */
        .promo-carousel-wrapper {
            position: relative;
            margin-bottom: 15px;
            background: transparent;
        }
        
        .promo-carousel-indicators {
            display: none;
            justify-content: center;
            align-items: center;
            gap: 6px;
            padding: 0;
            position: absolute;
            bottom: 8px;
            left: 0;
            right: 0;
            z-index: 10;
            pointer-events: none;
        }
        
        .promo-carousel-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            padding: 0;
            pointer-events: auto;
        }
        
        .promo-carousel-indicator.active {
            background: rgba(255, 255, 255, 0.9);
            width: 16px;
            border-radius: 3px;
        }
        
        @media (max-width: 968px) {
            .promo-banners-container {
                display: flex;
                overflow-x: auto;
                scroll-snap-type: x mandatory;
                scroll-behavior: smooth;
                gap: 12px;
                background: transparent;
                -webkit-overflow-scrolling: touch;
                padding: 0;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .promo-banners-container::-webkit-scrollbar {
                display: none;
            }
            
            .promo-carousel-indicators {
                display: flex;
            }
            
            .promo-banner {
                min-width: 100%;
                width: 100%;
                flex-shrink: 0;
                scroll-snap-align: start;
                min-height: 240px;
                border-radius: 12px;
                margin-right: 0;
                box-shadow: none;
                position: relative;
            }
            
            .promo-banner::before,
            .promo-banner::after {
                display: none;
            }
            
            .promo-banner-content {
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 10px 12px;
                gap: 8px;
                text-align: center;
            }
            
            .promo-text {
                max-width: 100%;
                align-self: center;
                text-align: center;
            }
            
            .promo-image {
                max-width: 100%;
            }
            
            .promo-title {
                font-size: 14px;
                line-height: 1.07143;
                letter-spacing: -0.005em;
            }
            
            .promo-subtitle {
                font-size: 0.8rem;
            }
            
            .promo-badge {
                font-size: 0.55rem;
                padding: 3px 10px;
            }
            
            .promo-image img,
            .promo-image video {
                max-height: 180px;
            }
        }
        
        @media (max-width: 768px) {
            .promo-banners-container {
                display: flex;
                overflow-x: auto;
                scroll-snap-type: x mandatory;
                scroll-behavior: smooth;
                gap: 12px;
                background: transparent;
                -webkit-overflow-scrolling: touch;
                padding: 0;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .promo-banners-container::-webkit-scrollbar {
                display: none;
            }
            
            .promo-carousel-indicators {
                display: flex;
            }
            
            .promo-banner {
                min-width: 100%;
                width: 100%;
                flex-shrink: 0;
                scroll-snap-align: start;
                min-height: 220px;
                border-radius: 10px;
                margin-bottom: 0;
                box-shadow: none;
                position: relative;
            }
            
            .promo-banner::before,
            .promo-banner::after {
                display: none;
            }
            
            .promo-banner-content {
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 8px 10px;
                gap: 6px;
                text-align: center;
            }
            
            .promo-text {
                max-width: 100%;
                align-self: center;
                text-align: center;
            }
            
            .promo-title {
                font-size: 12px;
                line-height: 1.07143;
                letter-spacing: -0.005em;
            }
            
            .promo-subtitle {
                font-size: 0.7rem;
            }
            
            .promo-badge {
                font-size: 0.5rem;
                padding: 3px 8px;
            }
            
            .promo-image img,
            .promo-image video {
                max-height: 150px;
            }
        }
        
        .categories {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 30px;
        }
        
        .category-card {
            background: white;
            border-radius: 12px;
            padding: 8px 12px 12px 12px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            opacity: 0;
            transform: translateY(20px);
        }
        
        .category-card.animate-in {
            animation: fadeInUp 0.5s ease forwards;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        /* Стили для заголовка категории */
        .category-header {
            cursor: pointer;
            padding: 0;
            border-radius: 8px;
            transition: background-color 0.2s ease;
            background-color: white !important;
            margin-bottom: 0;
        }
        
        /* Стили для контейнера брендов */
        .brands-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 0;
            padding: 6px;
            background: transparent;
            border-radius: 12px;
            border: none;
            box-shadow: none;
            max-height: 60px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .category-card.expanded .brands-container {
            max-height: 500px;
            padding: 16px;
            gap: 12px;
        }
        
        /* Стили для кнопок брендов - изначально маленькие */
        .brand-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 4px 8px;
            background: #f8f9fa;
            color: #333;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.7rem;
            font-weight: 500;
            box-shadow: none;
            min-width: auto;
            position: relative;
            overflow: visible;
            transform: scale(0.8);
            opacity: 0.7;
        }
        
        .brand-button img {
            width: 16px;
            height: 16px;
        }
        
        /* При expanded - большие бренды */
        .category-card.expanded .brand-button {
            padding: 16px 24px;
            font-size: 0.875rem;
            border-radius: 12px;
            transform: scale(1);
            opacity: 1;
            min-width: 120px;
        }
        
        .category-card.expanded .brand-button img {
            width: 28px;
            height: 28px;
        }
        
        .category-card.expanded .brand-button:hover {
            transform: scale(1.05);
            background: #2d6cdf;
            color: white;
            border-color: #2d6cdf;
            box-shadow: 0 4px 12px rgba(45, 108, 223, 0.3);
            z-index: 10;
        }
        
        .category-card.expanded .brand-button:hover img {
            filter: brightness(0) invert(1);
        }
        
        .brand-button:hover {
            background: #007AFF;
            color: white;
            border-color: #007AFF;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,122,255,0.2);
        }
        
        .brand-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 4px rgba(0,122,255,0.15);
        }
        
        .brand-icon {
            font-size: 1rem;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }
        
        .brand-button:hover .brand-icon {
            opacity: 1;
        }
        
        .brand-button img {
            height: 28px;
            width: auto;
            max-width: 100px;
            object-fit: contain;
            display: block;
        }
        
        .brand-name {
            font-weight: 500;
            letter-spacing: 0;
        }
        
        .subcategory-name img {
            height: 40px;
            width: auto;
            object-fit: contain;
            display: block;
        }
        
        .brand-count {
            background: rgba(0,122,255,0.1);
            color: #007AFF;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 4px;
            transition: all 0.2s ease;
            border: none;
        }
        
        .brand-button:hover .brand-count {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        /* Стили для подкатегорий */
        .subcategories {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        
        .subcategory-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin: 5px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }
        
        .subcategory-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(5px);
        }
        
        .subcategory-icon {
            margin-right: 8px;
            font-size: 1.1em;
        }
        
        .subcategory-name {
            flex: 1;
            font-weight: 500;
        }
        
        /* Tablet: use two larger cards per row */
        @media (max-width: 768px) {
            .categories {
                grid-template-columns: repeat(2, 1fr) !important; /* 2 карточки в ряд на планшетах */
                gap: 12px !important;
            }
            .category-card { padding: 10px 18px 18px 18px !important; }
            
            /* Уменьшаем логотип Яндекс в мобильной версии */
            .yandex-brand-icon {
                height: 16px !important;
                max-width: 60px !important;
            }
            .about-footer {
                padding: 30px 20px !important;
                margin-top: 30px !important;
            }
            .about-footer .grid {
                gap: 25px !important;
            }
        }

        /* Mobile: 1 column for iPhone (including iPhone 16 Pro Max) */
        @media (max-width: 480px) {
            body {
                padding-top: 0 !important;
                margin-top: 0 !important;
            }
            
            .container {
                padding-top: 0 !important;
                margin-top: 0 !important;
                padding-left: 10px;
                padding-right: 10px;
                padding-bottom: 15px;
            }
            
            .header {
                flex-direction: row;
                align-items: center;
                padding: 10px 0;
                gap: 10px;
            }
            
            .header h1 {
                margin-left: 0;
                padding-left: 0;
            }
            
            .logo {
                width: 40px;
                height: 40px;
            }
            
            .search-bar {
                max-width: none;
                flex: 1;
            }
            
            .cart-icon-btn {
                bottom: 20px;
                left: 20px;
                width: 52px;
                height: 52px;
            }
            
            .cart-icon-btn svg {
                width: 24px;
                height: 24px;
            }
            
            .categories {
                grid-template-columns: repeat(1, 1fr) !important; /* 1 card per row on mobile */
                gap: 12px !important;
            }
            .category-card {
                padding: 6px 8px 8px 8px !important;
                border-radius: 8px !important;
            }
            .category-name {
                font-size: 0.8rem !important;
                margin-bottom: 4px !important;
            }
            .category-count {
                font-size: 0.7rem !important;
            }
            .category-icon {
                font-size: 1.2rem !important;
                margin-bottom: 4px !important;
            }
            .brands-container {
                padding: 6px !important;
                gap: 4px !important;
                margin-top: 6px !important;
            }
            .brand-button {
                padding: 4px 6px !important;
                font-size: 0.75rem !important;
            }
            .brand-icon {
                font-size: 0.8rem !important;
            }
            .brand-button img {
                height: 32px !important;
            }
            .brand-name {
                font-size: 0.75rem !important;
            }
            .brand-count {
                font-size: 0.65rem !important;
            }
            .subcategory-item { font-size: 0.9rem !important; }
            .about-footer {
                padding: 25px 15px !important;
                margin-top: 25px !important;
                border-radius: 15px 15px 0 0 !important;
            }
            .about-footer .grid {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }
            .about-footer h4 {
                font-size: 15px !important;
                margin-bottom: 12px !important;
            }
            .about-footer .about-list,
            .about-footer .about-kv {
                font-size: 13px !important;
            }
            .about-footer .phone-link {
                font-size: 18px !important;
            }
        }
        
        /* Extra small screens - 1 column */
        @media (max-width: 360px) {
            .categories {
                grid-template-columns: repeat(1, 1fr) !important;
                gap: 10px !important;
            }
            .category-card {
                padding: 6px !important;
            }
            .category-name {
                font-size: 0.75rem !important;
                margin-bottom: 2px !important;
            }
            .category-count {
                font-size: 0.65rem !important;
            }
            .category-icon {
                font-size: 1rem !important;
                margin-bottom: 2px !important;
            }
            .brands-container {
                padding: 4px !important;
                gap: 2px !important;
                margin-top: 4px !important;
            }
            .brand-button {
                padding: 3px 4px !important;
                font-size: 0.7rem !important;
            }
            .brand-icon {
                font-size: 0.7rem !important;
            }
            .brand-button img {
                height: 28px !important;
            }
            .brand-name {
                font-size: 0.7rem !important;
            }
            .brand-count {
                font-size: 0.6rem !important;
            }
        }

        .subcategory-count {
            font-size: 0.8em;
            opacity: 0.8;
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        /* Стили для хлебных крошек */
        .breadcrumbs {
            margin: 8px 0 12px 0;
            padding: 6px 12px;
            background: transparent;
        }
        
        .breadcrumb-trail {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 4px;
            font-size: 13px;
            color: #6c757d;
            opacity: 0.8;
        }
        
        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .breadcrumb-link {
            color: #667eea;
            text-decoration: none;
            padding: 2px 4px;
            border-radius: 2px;
            transition: all 0.2s ease;
            font-size: 13px;
        }
        
        .breadcrumb-link:hover {
            background: #667eea;
            color: white;
            opacity: 1;
        }
        
        .breadcrumb-current {
            color: #495057;
            font-weight: 400;
            padding: 2px 4px;
            background: transparent;
            border-radius: 2px;
            font-size: 13px;
        }
        
        .breadcrumb-separator {
            color: #adb5bd;
            margin: 0 2px;
            font-size: 12px;
            opacity: 0.6;
        }
        
        .category-header {
            text-align: center;
            margin-bottom: 0;
            padding: 1rem;
            background: white !important;
            border-radius: 15px;
            color: #333;
        }
        
        .category-header h2 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .category-header p {
            margin: 8px 0 0 0;
            opacity: 0.9;
            font-size: 1rem;
        }
        
        .category-welcome {
            text-align: center;
            margin: 16px 0 20px 0;
            padding: 0;
        }
        
        .category-welcome-title {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
            color: #333;
        }
        
        .category-welcome-subtitle {
            margin: 8px 0 0 0;
            font-size: 1rem;
            color: #666;
            opacity: 0.9;
        }
        
        .subcategories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
            padding: 0;
        }
        
        .subcategory-card {
            background: white;
            border-radius: 12px;
            padding: 20px 16px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.5s ease forwards;
        }
        
        .subcategory-card.animate-in {
            animation: fadeInUp 0.5s ease forwards;
        }
        
        .subcategory-card {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: 1px solid #f0f0f0;
            position: relative;
            overflow: hidden;
        }
        
        .subcategory-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #007AFF, #0056CC);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }
        
        .subcategory-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 122, 255, 0.15);
            border-color: #007AFF;
        }
        
        .subcategory-card:hover::before {
            transform: scaleX(1);
        }
        
        .subcategory-card .subcategory-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            display: block;
        }
        
        .subcategory-card .subcategory-name {
            font-size: 1rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
            letter-spacing: -0.01em;
        }
        
        .subcategory-card .subcategory-count {
            font-size: 0.75rem;
            color: #666;
            background: #f5f5f7;
            padding: 4px 10px;
            border-radius: 12px;
            display: inline-block;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .subcategory-card:hover .subcategory-count {
            background: rgba(0, 122, 255, 0.1);
            color: #007AFF;
        }
        
        .product-description-spoiler, .product-specifications-spoiler {
            margin: 10px 0;
        }
        
        .spoiler-header {
            cursor: pointer;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        
        .spoiler-header:hover {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 8px 10px;
            margin: 0 -10px;
        }
        
        .spoiler-title {
            font-weight: 600;
            color: #333;
            font-size: 0.8rem;
        }
        
        .spoiler-arrow {
            color: #667eea;
            font-size: 0.7rem;
            transition: transform 0.2s ease;
        }
        
        .spoiler-content {
            padding: 10px 0;
            margin-top: 5px;
        }
        
        .product-description {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }
        
        .specifications {
            font-size: 0.8rem;
        }
        
        .spec-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .spec-key {
            font-weight: 600;
            color: #333;
            font-size: 0.8rem;
        }
        
        .spec-value {
            color: #666;
            text-align: right;
            max-width: 60%;
            font-size: 0.8rem;
        }
        
        .product-variants {
            margin: 12px 0;
            padding: 12px;
            padding-top: 0px;
            background: transparent;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }
        
        .variant-group {
            margin-bottom: 8px;
        }
        
        .variant-group:last-child {
            margin-bottom: 0;
        }
        
        .variant-group label {
            display: block;
            font-weight: 600;
            color: #555;
            font-size: 0.8rem;
            margin-bottom: 8px;
            opacity: 0.8;
        }
        
        .variant-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .product-variants .variant-buttons {
            gap: 8px;
        }
        
        .variant-btn {
            position: relative;
            padding: 8px 14px;
            border: 2px solid rgba(45, 108, 223, 0.3);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
            font-weight: 500;
            color: #374151;
            white-space: nowrap;
            text-align: center;
        }
        
        .variant-btn:hover {
            border-color: rgba(45, 108, 223, 0.6);
            box-shadow: 0 2px 8px rgba(45, 108, 223, 0.15);
        }
        
        .variant-btn.active {
            border-color: #2d6cdf;
            background: #2d6cdf;
            color: white;
        }
        
        .variant-btn.active:hover {
            border-color: #2d6cdf;
            background: #2d6cdf;
        }
        
        /* Special styles for color buttons */
        .color-btn {
            width: 28px;
            height: 28px;
            padding: 0;
            border-radius: 50%;
            border: 3px solid rgba(45, 108, 223, 0.3) !important;
            position: relative;
            transition: all 0.2s ease;
            cursor: pointer;
            min-width: 28px;
            box-sizing: border-box;
        }
        
        .color-btn:hover {
            border-color: rgba(45, 108, 223, 0.6);
            transform: scale(1.05);
        }
        
        .color-btn.active {
            border-color: #2d6cdf;
            border-width: 4px;
            box-shadow: 0 0 0 2px rgba(45, 108, 223, 0.2);
        }
        
        /* Tooltip for color button */
        .color-btn[data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: #fff;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 400;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.1s ease-in-out;
            z-index: 5;
        }
        
        .color-btn[data-tooltip]:hover::after,
        .color-btn[data-tooltip]:focus::after {
            opacity: 1;
        }
        
        .color-btn.no-tooltip::after {
            opacity: 0 !important;
        }
        
        
        /* Стили для групп вариантов */
        .variant-group {
            margin: 15px 0;
        }
        
        .variant-group label {
            display: block;
            font-weight: 600;
            color: #555;
            font-size: 0.8rem;
            margin-bottom: 8px;
            opacity: 0.8;
        }
        
        /* Стили для кнопок памяти и SIM */
        .memory-btn, .sim-btn {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            color: #495057;
        }
        
        .memory-btn:hover, .sim-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .memory-btn.active, .sim-btn.active {
            background: white;
            color: #667eea;
            border-color: #667eea;
            border-width: 2px;
            font-weight: 600;
        }
        /* Help (About) floating button */
        .help-fab {
            position: fixed;
            top: 18px;
            right: 18px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #2d6cdf;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1100;
        }
        .help-fab:hover { background: #1f56bf; }
        .about-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1099;
        }
        .about-modal { background: #fff; width: min(720px, 92vw); max-height: 86vh; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
        .about-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 18px; border-bottom: 1px solid #eee; }
        .about-title { font-size: 18px; font-weight: 700; }
        .about-close { background: transparent; border: none; font-size: 20px; cursor: pointer; color: #666; }
        .about-content { padding: 16px 18px 20px 18px; overflow: auto; max-height: 70vh; }
        .about-section { 
            margin-bottom: 24px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease forwards;
        }
        
        .about-section.animate-in {
            animation: fadeInUp 0.6s ease forwards;
        }
        .about-section h4 { 
            margin: 0 0 16px 0; 
            font-size: 18px; 
            font-weight: 700;
            color: #111827;
            letter-spacing: -0.02em;
            position: relative;
            padding-bottom: 12px;
        }
        .about-section h4::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 3px;
            background: linear-gradient(90deg, #2d6cdf, transparent);
            border-radius: 2px;
        }
        .about-section h4[style*="text-align: center"]::after {
            left: 50%;
            transform: translateX(-50%);
        }
        .about-section p {
            color: #4b5563;
            line-height: 1.8;
            margin-bottom: 12px;
            font-size: 14px;
        }
        .about-list { 
            margin: 0; 
            padding-left: 20px; 
            color: #4b5563;
            line-height: 1.8;
            font-size: 14px;
        }
        .about-list li {
            margin-bottom: 10px;
            position: relative;
        }
        .about-list li::marker {
            color: #2d6cdf;
        }
        .about-kv { color: #4b5563; }
        .about-kv div { margin: 4px 0; }
        
        /* Стильные карточки для доставки и оплаты */
        .info-card {
            padding: 20px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .info-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #2d6cdf, #1f56bf);
        }
        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(45, 108, 223, 0.12);
            border-color: #2d6cdf;
        }
        .info-card h5 {
            margin: 0 0 12px 0;
            font-size: 15px;
            font-weight: 700;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .info-card h5 span {
            font-size: 24px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        .info-card p {
            margin: 0;
            font-size: 14px;
            line-height: 1.7;
            color: #4b5563;
        }

        /* About footer at bottom */
        .about-footer {
            margin-top: 40px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-top: 2px solid #e5e7eb;
            padding: 40px 30px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }
        .about-footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #2d6cdf 0%, #1f56bf 50%, #2d6cdf 100%);
        }
        .about-footer .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 30px;
            position: relative;
            z-index: 1;
        }
        .about-footer h4 { 
            margin: 0 0 16px 0; 
            font-size: 16px; 
            font-weight: 700; 
            color: #111827;
            letter-spacing: -0.02em;
            position: relative;
            padding-bottom: 10px;
        }
        .about-footer h4::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 40px;
            height: 2px;
            background: linear-gradient(90deg, #2d6cdf, transparent);
            border-radius: 2px;
        }
        .about-footer .about-list { 
            font-size: 14px; 
            line-height: 1.8; 
            list-style: none;
            padding-left: 0;
        }
        .about-footer .about-list li {
            margin-bottom: 10px;
            transition: transform 0.2s ease;
        }
        .about-footer .about-list li:hover {
            transform: translateX(4px);
        }
        .about-footer .about-kv { 
            font-size: 14px; 
            line-height: 1.8; 
            color: #4b5563;
        }
        .about-footer .about-kv div {
            margin-bottom: 8px;
        }
        .about-footer a {
            transition: all 0.2s ease;
            position: relative;
            display: inline-block;
        }
        .about-footer a:hover {
            color: #2d6cdf !important;
            text-decoration: none;
            transform: translateX(2px);
        }
        .about-footer a[href*="maps"] svg {
            transition: transform 0.2s ease;
        }
        .about-footer a[href*="maps"]:hover svg {
            transform: scale(1.1);
        }
        .about-footer a[href*="t.me"] svg,
        .about-footer a[href*="mailto"] svg {
            transition: transform 0.2s ease;
        }
        .about-footer a[href*="t.me"]:hover svg,
        .about-footer a[href*="mailto"]:hover svg {
            transform: scale(1.1);
        }
        .about-footer .about-list a {
            color: #4b5563;
            display: inline-block;
            padding: 2px 0;
        }
        .about-footer .about-list a:hover {
            color: #2d6cdf !important;
            transform: translateX(2px);
        }
        .about-footer .about-list a::after {
            content: '→';
            margin-left: 6px;
            opacity: 0;
            transition: all 0.2s ease;
            display: inline-block;
        }
        .about-footer .about-list a:hover::after {
            opacity: 1;
            transform: translateX(2px);
        }
        .about-footer .phone-link {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s ease;
            letter-spacing: 0.02em;
        }
        .about-footer .phone-link:hover {
            color: #2d6cdf;
            transform: scale(1.05);
        }
        
        .category-icon {
            font-size: 2.2rem;
            width: 160px;
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 6px;
        }
        .category-icon svg { width: 28px; height: 28px; display: inline-block; vertical-align: middle; }
        .category-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 6px;
        }
        
        .category-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            font-size: 0.95rem;
        }
        
        .category-count {
            font-size: 0.85rem;
            color: #666;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        /* Стили для иерархических фильтров */
        .hierarchy-filters {
            margin: 12px 0;
            padding: 8px 12px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.7) 0%, rgba(248, 249, 250, 0.7) 100%);
            border-radius: 8px;
            border: 1px solid rgba(229, 231, 235, 0.6);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02), 0 1px 3px rgba(0, 0, 0, 0.04);
        }
        
        .hierarchy-filter-section {
            margin-bottom: 0;
        }
        
        .hierarchy-filter-section > div:first-child {
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .hierarchy-filter-section > div:first-child svg {
            color: #2d6cdf;
        }
        
        .filter-group {
            margin-bottom: 10px;
        }
        
        .filter-group:last-child {
            margin-bottom: 0;
        }
        
        .filter-group h4 {
            margin: 0 0 6px 0;
            font-size: 11px;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .filter-btn {
            padding: 6px 14px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .filter-btn:hover {
            background: linear-gradient(135deg, #2d6cdf 0%, #1e4dd8 100%);
            border-color: #2d6cdf;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(45, 108, 223, 0.3);
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, #2d6cdf 0%, #1e4dd8 100%);
            border-color: #2d6cdf;
            color: white;
            box-shadow: 0 3px 8px rgba(45, 108, 223, 0.4);
            font-weight: 600;
        }
        
        .filter-reset {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 2px solid #e5e7eb;
        }
        
        .reset-btn {
            padding: 6px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
        }
        
        .reset-btn svg {
            width: 12px;
            height: 12px;
        }
        
        .reset-btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(239, 68, 68, 0.4);
        }
        
        /* Стили для индикатора загрузки товаров */
        .loading-products {
            text-align: center;
            padding: 40px 20px;
        }
        
        @keyframes pulse {
            from { opacity: 0.6; }
            to { opacity: 1; }
        }
        
        .product-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.5s ease forwards;
        }
        
        .product-card.animate-in {
            animation: fadeInUp 0.5s ease forwards;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        /* Отключаем кликабельность карточек товаров на мобильных устройствах */
        @media screen and (max-width: 768px) {
            .product-card {
                pointer-events: none;
            }
            
            .product-card * {
                pointer-events: auto;
            }
            
            /* Отключаем hover эффект на мобильных */
            .product-card:hover {
                transform: none;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }
        }
        
        .product-image {
            width: 100%;
            height: 300px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #999;
        }
        
        .product-info {
            padding: 20px;
        }
        
        .product-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .product-brand {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .product-price {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .current-price {
            font-size: 1.4rem;
            font-weight: 400;
            color: #000;
        }
        
        .old-price {
            font-size: 1rem;
            color: #999;
            text-decoration: line-through;
        }
        
        .discount {
            background: #e74c3c;
            color: #333;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        /* Детальная страница продукта */
        .product-detail-page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        
        .product-detail-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 30px;
            color: #111827;
        }
        
        .product-detail-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 20px;
        }
        
        .product-detail-images {
            display: flex;
            flex-direction: column;
            align-self: flex-start;
            width: 100%;
            max-width: 500px;
        }
        
        .product-detail-images-sticky {
            position: sticky;
            top: 20px;
            height: fit-content;
            width: 100%;
            flex-shrink: 0;
        }
        
        .product-detail-images .top-specifications {
            margin-top: 20px;
        }
        
        /* Рекомендации на детальной странице */
        .product-detail-recommendations {
            margin-top: 40px;
            padding-top: 30px;
            padding-bottom: 30px;
            border-top: 1px solid rgba(229, 231, 235, 0.6);
            position: relative;
            width: 100%;
            max-width: 500px;
            min-height: 300px;
        }
        
        .product-detail-recommendations-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #111827;
        }
        
        .product-detail-recommendations-list {
            position: relative;
            overflow: hidden;
        }
        
        .product-detail-recommendations-slider {
            display: flex;
            transition: transform 0.4s ease;
            width: 100%;
        }
        
        .product-detail-recommendations-slide {
            min-width: 100%;
            width: 100%;
            flex-shrink: 0;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            align-items: stretch;
        }
        
        .product-detail-recommendation-item {
            display: flex;
            gap: 10px;
            padding: 8px;
            background: white;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            height: 100%;
            min-height: 80px;
        }
        
        .product-detail-recommendation-item:hover {
            background: white;
            border-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        
        .product-detail-recommendation-image {
            width: 50px;
            height: 50px;
            object-fit: contain;
            border-radius: 6px;
            flex-shrink: 0;
            background: white;
            padding: 3px;
        }
        
        .product-detail-recommendation-info {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex: 1;
            min-width: 0;
            gap: 4px;
        }
        
        .product-detail-recommendation-name {
            font-size: 0.8rem;
            font-weight: 500;
            color: #111827;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .product-detail-recommendation-specs {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        .product-detail-recommendation-price {
            font-size: 0.85rem;
            font-weight: 600;
            color: #007AFF;
        }
        
        .product-detail-recommendations-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
        }
        
        .product-detail-recommendations-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(45, 108, 223, 0.3);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .product-detail-recommendations-dot.active {
            background: #2d6cdf;
            width: 24px;
            border-radius: 4px;
        }
        
        @media (max-width: 640px) {
            /* Ограничиваем ширину страницы и контента */
            .product-detail-page {
                width: 100%;
                max-width: 100vw;
                padding: 15px;
                overflow-x: hidden;
            }
            
            .product-detail-content {
                width: 100%;
                max-width: 100%;
                overflow-x: hidden;
            }
            
            .product-detail-info {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                overflow-x: hidden;
            }
            
            .product-detail-recommendations-slider {
                width: 100%;
                display: flex;
            }
            
            .product-detail-recommendations-slide {
                grid-template-columns: repeat(2, 1fr);
                gap: 5px;
                width: 100%;
                min-width: 100%;
                max-width: 100%;
                flex-shrink: 0;
                box-sizing: border-box;
            }
            
            /* Скрываем рекомендации в .product-detail-images на мобильной версии */
            .product-detail-images .product-detail-recommendations {
                display: none !important;
            }
            
            /* Показываем рекомендации после кнопки "В корзину" на мобильной версии */
            .product-detail-recommendations-mobile {
                display: block !important;
                margin-top: 12px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                overflow-x: hidden;
            }
            
            .product-detail-recommendations-list {
                width: 100%;
                max-width: 100%;
                overflow-x: hidden;
            }
            
            .product-detail-recommendations-slider {
                display: flex;
                transition: transform 0.4s ease;
                width: 100%;
            }
            
            .product-detail-recommendations-slide {
                min-width: 100%;
                width: 100%;
                flex-shrink: 0;
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 5px;
                align-items: stretch;
            }
            
            .product-detail-recommendation-item {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                height: 100%;
                min-height: 90px;
                padding: 8px;
                gap: 10px;
                border-radius: 8px;
            }
            
            .product-detail-recommendations-title {
                font-size: 1.1rem;
                margin-bottom: 12px;
            }
            
            .product-detail-recommendations-mobile {
                min-height: 200px;
            }
            
            .product-detail-recommendation-image {
                width: 60px;
                height: 60px;
                border-radius: 6px;
            }
            
            .product-detail-recommendation-name {
                font-size: 0.9rem;
                white-space: normal;
                line-height: 1.3;
            }
            
            .product-detail-recommendation-specs {
                font-size: 0.8rem;
            }
            
            .product-detail-recommendation-price {
                font-size: 0.9rem;
            }
            
            .product-detail-recommendations-dots {
                margin-top: 6px;
            }
            
            .product-detail-recommendations-dot {
                width: 4px;
                height: 4px;
            }
            
            .product-detail-recommendations-dot.active {
                width: 16px;
            }
        }
        
        /* На десктопе скрываем мобильные рекомендации */
        @media (min-width: 641px) {
            .product-detail-recommendations-mobile {
                display: none !important;
            }
        }
        
        .product-image-carousel-detail {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            flex-shrink: 0;
            min-height: 0;
            min-width: 0;
        }
        
        .product-img-detail {
            width: 85%;
            height: 85%;
            object-fit: contain;
            transition: opacity 0.3s ease;
        }
        
        .product-image-carousel-detail .image-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            color: #666;
            width: auto;
            height: auto;
            border-radius: 0;
            display: flex !important;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 32px;
            padding: 15px 12px;
            font-weight: bold;
            opacity: 1 !important;
            transition: opacity 0.3s ease;
            border: none;
            outline: none;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            z-index: 200 !important;
            visibility: visible !important;
            pointer-events: auto !important;
        }
        
        .product-image-carousel-detail:hover .image-nav {
            opacity: 1 !important;
        }
        
        .product-image-carousel-detail .image-nav.prev {
            left: 10px;
        }
        
        .product-image-carousel-detail .image-nav.next {
            right: 10px;
        }
        
        .product-image-carousel-detail .image-indicators {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 10;
        }
        
        .product-image-carousel-detail .image-indicators .indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .product-image-carousel-detail .image-indicators .indicator.active {
            background: #2d6cdf;
            width: 24px;
            border-radius: 4px;
        }
        
        .product-image-carousel-detail .image-slide-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        .product-image-carousel-detail .image-slide-wrapper {
            display: flex;
            width: 100%;
            height: 100%;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .product-image-carousel-detail .image-slide-item {
            flex: 0 0 100%;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .product-image-carousel-detail .image-slide-item img {
            width: 85%;
            height: 85%;
            object-fit: contain;
            transition: opacity 0.3s ease;
        }
        
        .top-specifications {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(248, 249, 250, 0.7) 0%, rgba(245, 245, 245, 0.7) 100%);
            border-radius: 12px;
            border: 1px solid rgba(229, 231, 235, 0.6);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02), 0 1px 3px rgba(0, 0, 0, 0.04);
        }
        
        .top-spec {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        
        .top-spec svg {
            color: #2d6cdf;
        }
        
        .top-spec span {
            font-size: 0.9rem;
            color: #374151;
            text-align: center;
            font-weight: 500;
        }
        
        .variant-selector {
            margin-bottom: 25px;
        }
        
        .variant-label {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #111827;
        }
        
        .variant-selected {
            font-weight: 700;
            color: #2d6cdf;
        }
        
        .variant-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .variant-button {
            position: relative;
            padding: 6px 12px;
            border: 2px solid rgba(45, 108, 223, 0.3);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
            font-weight: 500;
            color: #374151;
        }
        
        .variant-button:hover {
            border-color: rgba(45, 108, 223, 0.6);
            box-shadow: 0 2px 8px rgba(45, 108, 223, 0.15);
        }
        
        .variant-button.active {
            border-color: #2d6cdf;
            background: #2d6cdf;
            color: white;
        }
        
        .variant-button input[type="radio"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }
        
        .variant-buttons-color {
            gap: 10px;
        }
        
        .variant-button-color {
            width: 36px;
            height: 36px;
            padding: 0;
            border-radius: 50%;
            border: 3px solid rgba(45, 108, 223, 0.3);
            position: relative;
            transition: all 0.2s ease;
        }
        
        .variant-button-color:hover {
            border-color: rgba(45, 108, 223, 0.6);
            transform: scale(1.05);
        }
        
        .variant-button-color.active {
            border-color: #2d6cdf;
            border-width: 4px;
            box-shadow: 0 0 0 2px rgba(45, 108, 223, 0.2);
        }
        
        .variant-button-color.deep-blue {
            background: #1e3a5f;
        }
        
        .variant-button-color.silver {
            background: #c0c0c0;
        }
        
        .variant-button-color.cosmic-orange {
            background: #ff6b35;
        }
        
        .variant-button-color.black {
            background: #000;
        }
        
        .variant-button-color.white {
            background: #fff;
            border-color: #ccc;
        }
        
        .variant-button-color.space-gray {
            background: #4a4a4a;
        }
        
        .variant-button-color.gold {
            background: #ffd700;
        }
        
        .variant-button-color.pink {
            background: #ffb6c1;
        }
        
        .variant-button-color.blue {
            background: #007aff;
        }
        
        .variant-button-color.purple {
            background: #af52de;
        }
        
        .variant-button-color.green {
            background: #34c759;
        }
        
        .variant-button-color.red {
            background: #ff3b30;
        }
        
        .variant-button-color.yellow {
            background: #ffcc00;
        }
        
        .product-detail-price {
            margin: 0 0 30px 0;
            padding: 0px 0;
            border-top: 1px solid rgba(229, 231, 235, 0.6);
            border-bottom: 1px solid rgba(229, 231, 235, 0.6);
        }
        
        .price-main {
            font-size: 2rem;
            font-weight: 700;
            color: #111827;
        }
        
        .price-old {
            font-size: 1.2rem;
            color: #9ca3af;
            text-decoration: line-through;
            margin-left: 15px;
        }
        
        .product-detail-actions {
            margin: 20px 0;
        }
        
        .btn-add-to-cart-detail {
            width: 100%;
            padding: 12px 20px;
            background: #2d6cdf;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 10px rgba(45, 108, 223, 0.2);
            position: relative;
        }
        
        .btn-add-to-cart-detail:hover {
            background: #2563eb;
            box-shadow: 0 4px 15px rgba(45, 108, 223, 0.3);
        }
        
        .btn-add-to-cart-detail svg {
            width: 18px;
            height: 18px;
            transition: opacity 0.3s ease;
        }
        
        .btn-add-to-cart-detail svg.hide-icon {
            opacity: 0;
        }
        
        .btn-add-to-cart-detail-text {
            transition: opacity 0.3s ease;
        }
        
        .btn-add-to-cart-detail-text.fade-out {
            opacity: 0;
        }
        
        .btn-add-to-cart-detail-text.fade-in {
            opacity: 1;
        }
        
        .btn-add-to-cart-detail-text.show-checkmark {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .btn-add-to-cart-detail-text.show-checkmark svg {
            display: block;
        }
        
        .product-detail-description,
        .product-detail-specifications {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid rgba(229, 231, 235, 0.6);
        }
        
        .product-detail-description h3,
        .product-detail-specifications h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: #111827;
        }
        
        .product-detail-description p {
            color: #374151;
            line-height: 1.6;
            font-size: 1rem;
        }
        
        .specifications-list {
            display: grid;
            gap: 12px;
        }
        
        .spec-item {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid rgba(229, 231, 235, 0.4);
        }
        
        .spec-key {
            font-weight: 600;
            color: #374151;
            min-width: 150px;
        }
        
        .spec-value {
            color: #6b7280;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        @media (max-width: 968px) {
            .product-detail-content {
                grid-template-columns: 1fr;
                gap: 30px;
            }
            
            .product-detail-images {
                position: relative;
                top: 0;
            }
            
            .product-detail-title {
                font-size: 2rem;
            }
            
            .top-specifications {
                flex-wrap: wrap;
            }
            
            .product-image-carousel-detail .image-nav {
                width: 36px;
                height: 36px;
                font-size: 24px;
            }
            
            .product-image-carousel-detail .image-nav.prev {
                left: 10px;
            }
            
            .product-image-carousel-detail .image-nav.next {
                right: 10px;
            }
        }
        
        .low-stock-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #e74c3c;
            color: white;
            padding: 4px 9px;
            border-radius: 6px;
            font-size: 0.63rem;
            font-weight: 600;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
            pointer-events: none;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 20px 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            min-width: 320px;
            max-width: 400px;
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid #10b981;
        }
        
        .notification.success {
            border-left-color: #10b981;
        }
        
        .notification.error {
            border-left-color: #e74c3c;
        }
        
        .notification-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .notification-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .notification.success .notification-icon {
            background: #d1fae5;
            color: #10b981;
        }
        
        .notification.error .notification-icon {
            background: #fee2e2;
            color: #e74c3c;
        }
        
        .notification-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            flex: 1;
        }
        
        .notification-message {
            font-size: 0.875rem;
            color: #6b7280;
            line-height: 1.5;
            margin-top: 4px;
        }
        
        .notification-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: transparent;
            border: none;
            cursor: pointer;
            color: #9ca3af;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .notification-close:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .notification.hiding {
            animation: slideOutRight 0.3s ease-out forwards;
        }
        
        .product-description {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #333;
            font-size: 1.2rem;
        }
        .page-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 260px;
            position: relative;
        }
        .page-loading .spinner {
            width: 40px;
            height: 40px;
            animation: spin2 1.5s linear infinite;
        }
        .page-loading .spinner img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 10px;
        }
        @keyframes spin2 {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #333;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .no-products {
            text-align: center;
            padding: 40px;
            color: #333;
            font-size: 1.1rem;
        }
        
        .back-button {
            background: white;
            border: none;
            border-radius: 20px;
            padding: 6px 12px;
            margin-bottom: 12px;
            opacity: 0;
            transform: translateY(-10px);
            animation: fadeInUp 0.4s ease 0.1s forwards;
            cursor: pointer;
            font-weight: 400;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        /* Стили для карусели изображений */
        .product-image-carousel {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
            border-radius: 15px;
            padding: 5%;
            box-sizing: border-box;
            background: white;
        }
        
        .product-img {
            width: 90%;
            height: 90%;
            object-fit: contain;
            border-radius: 15px;
            margin: 5%;
            transition: opacity 0.2s ease-in-out;
        }
        
        .image-placeholder {
            width: 90%;
            height: 90%;
            margin: 5%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            background: #f0f0f0;
            border-radius: 15px;
        }
        
        .loading-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            margin: 0;
            background: transparent;
            animation: spin 1.5s linear infinite;
            display: none; /* по умолчанию скрыт, показываем через JS */
            align-items: center;
            justify-content: center;
        }
        
        .loading-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 10px;
        }
        
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .image-indicators {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }
        
        .indicator {
            width: 3px;
            height: 3px;
            border-radius: 50%;
            background: rgba(150, 150, 150, 0.6);
            cursor: default;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(200, 200, 200, 0.3);
            pointer-events: none;
        }
        
        .indicator.active {
            width: 8px;
            height: 8px;
            background: rgba(60, 60, 60, 0.9);
            border: 1px solid rgba(40, 40, 40, 0.5);
            transform: scale(1.2);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .image-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            color: #666;
            width: auto;
            height: auto;
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 32px;
            padding: 15px 12px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
            border: none;
            outline: none;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }
        
        .product-image-carousel:hover .image-nav {
            opacity: 1;
        }
        
        .image-nav.prev {
            left: 10px;
        }
        
        .image-nav.next {
            right: 10px;
        }
        
        /* Стили для анимации слайда изображений */
        .product-image-carousel {
            position: relative;
        }
        
        .image-slide-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        .image-slide-wrapper {
            display: flex;
            width: 100%;
            height: 100%;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .image-slide-item {
            flex: 0 0 100%;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-slide-item img {
            width: 90%;
            height: 90%;
            object-fit: contain;
            border-radius: 10px;
            transition: opacity 0.3s ease-in-out;
        }
        
        /* Анимация появления изображения */
        .image-slide-item.fade-in {
            animation: fadeInSlide 0.4s ease-in-out;
        }
        
        @keyframes fadeInSlide {
            0% {
                opacity: 0;
                transform: translateX(20px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* Анимация исчезновения изображения */
        .image-slide-item.fade-out {
            animation: fadeOutSlide 0.3s ease-in-out;
        }
        
        @keyframes fadeOutSlide {
            0% {
                opacity: 1;
                transform: translateX(0);
            }
            100% {
                opacity: 0;
                transform: translateX(-20px);
            }
        }
        
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .logo {
                width: 40px;
                height: 40px;
            }
            
            .categories {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .product-image {
                height: 250px;
            }
            
            .product-image-carousel {
                height: 250px;
            }
            
            .product-img {
                width: 92%;
                height: 92%;
                margin: 4%;
            }
            
            /* Улучшения для свайпа на мобильных устройствах */
            .product-image-carousel {
                touch-action: pan-x pan-y;
                -webkit-overflow-scrolling: touch;
            }
            
            .image-nav {
                display: none !important; /* Скрываем стрелки на мобильных */
            }
        }
        
        @media (max-width: 480px) {
            .product-image {
                height: 220px;
            }
            
            .product-image-carousel {
                height: 220px;
            }
            
            .product-img {
                width: 94%;
                height: 94%;
                margin: 3%;
            }
        }
        
        /* Cart Styles */
        .cart-icon-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            left: auto;
            background: white;
            color: #333;
            opacity: 0;
            pointer-events: none;
            border: 1px solid #e5e7eb;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            padding: 0;
            font-size: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }
        
        .cart-icon-btn:hover {
            background: #f9fafb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .cart-icon-btn svg {
            width: 24px;
            height: 24px;
            stroke: #374151;
        }
        
        .cart-icon-btn span:not(.cart-badge) {
            display: none;
        }
        
        .cart-badge {
            background: #FF3B30;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            position: absolute;
            top: -4px;
            right: -4px;
            border: 2px solid white;
        }
        
        /* Catalog Floating Button */
        .catalog-icon-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            right: auto;
            background: #2d6cdf;
            color: white;
            opacity: 0;
            pointer-events: none;
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            padding: 0;
            font-size: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(45, 108, 223, 0.3);
            transition: opacity 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .catalog-icon-btn:hover {
            background: #1f56bf;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(45, 108, 223, 0.4);
        }
        
        .catalog-icon-btn svg {
            width: 24px;
            height: 24px;
            stroke: white;
        }
        
        .catalog-icon-btn.visible {
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        /* Скрываем кнопку каталога на десктопе */
        @media screen and (min-width: 769px) {
            .catalog-icon-btn {
                display: none !important;
                opacity: 0 !important;
                pointer-events: none !important;
            }
            
            .catalog-icon-btn.visible {
                display: none !important;
                opacity: 0 !important;
                pointer-events: none !important;
            }
        }
        
        .cart-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            overflow-y: auto;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
        }
        
        .cart-modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .cart-container {
            background: white;
            border-radius: 15px;
            width: 95%;
            max-width: 900px;
            margin: 20px auto;
            padding: 30px 30px 50px 30px;
            display: flex;
            gap: 30px;
            flex-direction: row;
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
            transform: scale(0.95) translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .cart-modal.active .cart-container {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
        
        .cart-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        
        .cart-form-section {
            flex: 1;
            min-width: 320px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .cart-items-section {
            flex: 1;
            min-width: 320px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .cart-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #f3f4f6;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .cart-close-btn:hover {
            background: #e5e7eb;
            transform: rotate(90deg);
        }
        
        .cart-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: #111827;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-bottom: 16px;
        }
        
        .form-group:last-of-type {
            margin-bottom: 0;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select:not(.form-select) {
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            width: 100%;
            font-family: inherit;
            background: white;
        }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #9ca3af;
            opacity: 1;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:not(.form-select):focus {
            outline: none;
            border-color: #007AFF;
        }
        
        .form-group textarea {
            resize: none;
            min-height: 60px;
        }
        
        .form-group select {
            color: #111827;
        }
        
        .form-group select:invalid {
            color: #9ca3af;
        }
        
        .form-group select option {
            color: #111827;
        }
        
        .form-group select option:first-child {
            color: #9ca3af;
        }
        
        .form-group-title {
            font-weight: 600;
            color: #374151;
            font-size: 0.95rem;
            margin-bottom: 12px;
            display: block;
        }
        
        .form-select {
            padding: 12px 44px 12px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            width: 100%;
            font-family: inherit;
            background-color: white;
            background-image: url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M6 9l6 6 6-6' stroke='%23374151' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px 16px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            color: #111827;
            font-weight: 500;
        }
        
        .form-select:hover {
            border-color: #9ca3af;
        }
        
        .form-select:focus {
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .form-select:invalid {
            color: #9ca3af;
        }
        
        .form-select option {
            color: #111827;
            padding: 8px;
            background: white;
        }
        
        .form-select option:first-child {
            color: #9ca3af;
        }
        
        .shipping-switch {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }
        
        .shipping-option {
            flex: 1;
            cursor: pointer;
        }
        
        .shipping-option input[type="radio"] {
            display: none;
        }
        
        .shipping-label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .shipping-option input[type="radio"]:checked + .shipping-label {
            border-color: #007AFF;
            background: #f0f7ff;
        }
        
        .shipping-icon {
            width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .shipping-icon svg {
            width: 100%;
            height: 100%;
            stroke: currentColor;
            fill: none;
        }
        
        .shipping-text {
            font-weight: 500;
            color: #374151;
        }
        
        .shipping-options-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }
        
        .shipping-option-item {
            cursor: pointer;
        }
        
        .shipping-option-item input[type="radio"] {
            display: none;
        }
        
        .shipping-option-box {
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: white;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .shipping-option-item input[type="radio"]:checked + .shipping-option-box {
            border-color: #007AFF;
            background: rgba(0, 122, 255, 0.03);
        }
        
        .shipping-option-title {
            font-weight: 600;
            color: #111827;
            font-size: 0.9rem;
        }
        
        .shipping-option-desc {
            font-size: 0.8rem;
            color: #6b7280;
        }
        
        .shipping-option-price {
            font-size: 0.8rem;
            color: #007AFF;
            font-weight: 600;
            margin-top: 2px;
        }
        
        .pickup-address {
            padding: 16px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-weight: 500;
            color: #111827;
            margin-top: 8px;
        }
        
        .pickup-hours {
            margin-top: 8px;
            font-size: 0.9rem;
            color: #6b7280;
        }
        
        .cart-items-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        
        .cart-recommendations-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 12px;
        }
        
        .cart-recommendations-list {
            position: relative;
            overflow: hidden;
        }
        
        .cart-recommendations-slider {
            display: flex;
            transition: transform 0.3s ease;
        }
        
        .cart-recommendations-slide {
            min-width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .cart-recommendations-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
        }
        
        .cart-recommendations-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #d1d5db;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .cart-recommendations-dot.active {
            background: #3b82f6;
            width: 18px;
            border-radius: 3px;
        }
        
        .cart-recommendation-item {
            display: flex;
            gap: 10px;
            padding: 8px;
            background: transparent;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .cart-recommendation-item:hover {
            background: transparent;
            border-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        
        .cart-recommendation-image {
            width: 50px;
            height: 50px;
            object-fit: contain;
            border-radius: 6px;
            flex-shrink: 0;
            background: white;
            padding: 3px;
        }
        
        .cart-recommendation-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }
        
        .cart-recommendation-name {
            font-size: 0.8rem;
            font-weight: 500;
            color: #111827;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .cart-recommendation-price {
            font-size: 0.85rem;
            font-weight: 600;
            color: #007AFF;
        }
        
        .cart-recommendation-add-btn {
            padding: 5px 10px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            align-self: center;
        }
        
        .cart-recommendation-add-btn:hover {
            background: #0056CC;
            transform: scale(1.05);
        }
        
        .cart-recommendation-add-btn:active {
            transform: scale(0.95);
        }
        
        .cart-item {
            display: flex;
            gap: 12px;
            padding: 10px;
            background: transparent;
            border-radius: 8px;
            border: none;
        }
        
        .cart-item-image {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 6px;
            flex-shrink: 0;
            background: #f9fafb;
            padding: 3px;
        }
        
        .cart-item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .cart-item-main {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }
        
        .cart-item-left {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-width: calc(100% - 120px);
        }
        
        .cart-item-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: #111827;
            word-wrap: break-word;
            word-break: break-word;
            line-height: 1.4;
        }
        
        .cart-item-specs {
            font-size: 0.75rem;
            color: #6b7280;
            line-height: 1.3;
        }
        
        .cart-item-price-qty {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            flex-shrink: 0;
            min-width: 100px;
        }
        
        .cart-item-price-per-unit {
            font-size: 0.75rem;
            font-weight: 400;
            color: #6b7280;
        }
        
        .cart-item-price {
            font-size: 0.95rem;
            font-weight: 600;
            color: #111827;
        }
        
        .qty-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 4px;
            margin-left: auto;
        }
        
        .qty-btn {
            background: none;
            border: none;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 1rem;
            color: #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .qty-btn:hover {
            background: #f3f4f6;
            border-radius: 4px;
        }
        
        .qty-value {
            width: 18px;
            height: 18px;
            text-align: center;
            font-weight: 300;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .cart-item-remove {
            background: #fee2e2;
            color: #dc2626;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .cart-item-remove:hover {
            background: #fecaca;
        }
        
        .cart-total {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .promo-code-section {
            order: 1;
        }
        
        .cart-recommendations {
            margin-top: 0;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
            order: 2; /* В десктопной версии после промокода */
        }
        
        .cart-total-item:not(.cart-total-final) {
            order: 3;
        }
        
        .cart-total-final {
            order: 4; /* Итого после всех в десктопе */
        }
        
        @media (max-width: 768px) {
            .cart-recommendations {
                order: 10; /* В мобильной версии после Итого */
            }
            
            .cart-total-final {
                order: 4; /* Итого перед рекомендациями в мобильной версии */
            }
        }
        
        .cart-total-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cart-total-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #6b7280;
        }
        
        .cart-total-value {
            font-size: 0.9rem;
            font-weight: 500;
            color: #111827;
        }
        
        .cart-total-final {
            margin-top: 4px;
            margin-bottom: 20px;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
        }
        
        .cart-total-final .cart-total-label {
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
        }
        
        .cart-total-price {
            font-size: 1.1rem;
            font-weight: 700;
            color: #007AFF;
        }
        
        .cart-submit-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
        }
        
        .cart-submit-btn:hover {
            background: #0056CC;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,122,255,0.3);
        }
        
        .cart-submit-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .cart-telegram-btn {
            background: #0088cc;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 120px;
            height: 100%;
            box-sizing: border-box;
            white-space: nowrap;
        }
        
        .cart-telegram-btn span {
            display: inline-block;
        }
        
        .cart-telegram-btn:hover {
            background: #006699;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,136,204,0.3);
        }
        
        .cart-telegram-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .clear-cart-btn {
            background: transparent;
            color: #ef4444;
            border: 1px solid #ef4444;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .clear-cart-btn:hover {
            background: #ef4444;
            color: white;
        }
        
        .cart-consent-text {
            font-size: 0.75rem;
            color: #9ca3af;
            text-align: center;
            margin-top: 12px;
            margin-bottom: 20px;
            line-height: 1.4;
        }
        
        .add-to-cart-btn {
            padding: 5px 10px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 18px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            min-width: 100px;
            width: 100px;
            text-align: center;
            color: #333;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .add-to-cart-btn:hover {
            border-color: #667eea;
            background: #f0f3ff;
        }
        
        .add-to-cart-btn:active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .add-to-cart-btn {
            position: relative;
        }
        
        .add-to-cart-btn-text {
            transition: opacity 0.3s ease;
        }
        
        .add-to-cart-btn-text.fade-out {
            opacity: 0;
        }
        
        .add-to-cart-btn-text.fade-in {
            opacity: 1;
        }
        
        .add-to-cart-btn-text.show-checkmark {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .add-to-cart-btn-text.show-checkmark svg {
            display: block;
        }
        
        .add-to-cart-btn svg {
            transition: opacity 0.3s ease;
        }
        
        .add-to-cart-btn svg.hide-icon {
            opacity: 0;
        }
        
        @media (max-width: 968px) {
            .cart-container {
                flex-direction: column;
                padding: 20px;
            }
            
            .cart-form-section {
                min-width: 100%;
                order: 2;
            }
            
            .cart-items-section {
                min-width: 100%;
                order: 1;
            }
            
            .cart-icon-btn {
                bottom: 20px;
                left: 20px;
                width: 52px;
                height: 52px;
            }
            
            .cart-icon-btn svg {
                width: 24px;
                height: 24px;
            }
            
            .catalog-icon-btn {
                bottom: 20px;
                right: 20px;
                left: auto;
                width: 52px;
                height: 52px;
            }
            
            .catalog-icon-btn svg {
                width: 24px;
                height: 24px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
</head>
<body>
    <div class="container">
        <!-- Desktop header -->
        <div class="header header-desktop">
            <div class="header-top-links">
                <a href="#" onclick="goToHomePage(); return false;">Главная</a>
                <a href="#" onclick="loadGuaranteePage(); return false;">Гарантия</a>
                <a href="#" onclick="loadDeliveryPage(); return false;">Доставка и оплата</a>
                <a href="#contacts" onclick="document.querySelector('.about-footer')?.scrollIntoView({behavior: 'smooth'}); return false;">Контакты</a>
                <a href="https://t.me/yo_feedback" target="_blank">Отзывы</a>
                <a href="https://t.me/yo_price" target="_blank">Telegram</a>
            </div>
            <div class="header-main">
                <h1>
                    <a href="#" onclick="goToHomePage()" class="logo-link">
                        <img src="/static/images/logo.jpg" alt="Yo Store" class="logo">
                    </a>
                </h1>
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="Например, 17 Pro Max" id="searchInput">
                    <button class="search-icon-btn" aria-label="Найти" onclick="searchFromIcon()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                            <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/>
                            <line x1="16.65" y1="16.65" x2="21" y2="21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>
                <div class="quick-menu" id="quickMenu">
                    <a href="#" class="quick-menu-item" onclick="loadProductsByBrand('Apple', 'Смартфоны'); return false;">iPhone</a>
                    <a href="#" class="quick-menu-item" onclick="loadProductsByBrand('Apple', 'Ноутбуки'); return false;">MacBook</a>
                    <a href="#" class="quick-menu-item" onclick="searchProducts('AirPods'); return false;">AirPods</a>
                    <a href="#" class="quick-menu-item" onclick="searchProducts('iPad'); return false;">iPad</a>
                    <a href="#" class="quick-menu-item" onclick="searchProducts('Apple Watch'); return false;">Apple Watch</a>
                    <a href="#" class="quick-menu-item" onclick="searchProducts('Dyson'); return false;">Dyson</a>
                    <a href="#" class="quick-menu-item" onclick="searchProducts('Galaxy'); return false;">Galaxy</a>
                    <a href="#" class="quick-menu-item" onclick="searchProducts('Whoop'); return false;">Whoop</a>
                    <a href="#" class="quick-menu-item" onclick="loadProductsByBrand('Sony', 'Игровые приставки'); return false;">Playstation</a>
                </div>
                <button class="cart-icon-btn-header" onclick="openCart()" aria-label="Корзина">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <path d="M16 10a4 4 0 0 1-8 0"></path>
                    </svg>
                    <span class="cart-badge" id="cartBadge" style="display: none;">0</span>
                </button>
            </div>
        </div>
        
        <!-- Mobile header -->
        <div class="header header-mobile">
            <div class="header-top-mobile">
                <div class="catalog-dropdown">
                    <button class="catalog-btn" onclick="toggleCatalogDropdown(event)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <div class="catalog-overlay" id="catalogOverlay" onclick="closeCatalogDropdown()"></div>
                    <div class="catalog-dropdown-menu" id="catalogDropdownMenu">
                        <div class="catalog-dropdown-header">
                            <h2>Каталог</h2>
                            <button class="catalog-dropdown-close" onclick="closeCatalogDropdown()" aria-label="Закрыть каталог">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="catalog-dropdown-content" id="catalogDropdownContent">
                        <div class="catalog-dropdown-loading">Загрузка...</div>
                        </div>
                    </div>
                </div>
                <h1>
                    <a href="#" onclick="goToHomePage()" class="logo-link">
                        <img src="/static/images/logo.jpg" alt="Yo Store" class="logo">
                    </a>
                </h1>
                <button class="cart-icon-btn-header" onclick="openCart()" aria-label="Корзина">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <path d="M16 10a4 4 0 0 1-8 0"></path>
                    </svg>
                    <span class="cart-badge" id="cartBadgeMobile" style="display: none;">0</span>
                </button>
            </div>
            <div class="quick-menu quick-menu-mobile">
                <a href="#" class="quick-menu-item" onclick="loadProductsByBrand('Apple', 'Смартфоны'); return false;">iPhone</a>
                <a href="#" class="quick-menu-item" onclick="loadProductsByBrand('Apple', 'Ноутбуки'); return false;">MacBook</a>
                <a href="#" class="quick-menu-item" onclick="searchProducts('AirPods'); return false;">AirPods</a>
                <a href="#" class="quick-menu-item" onclick="searchProducts('iPad'); return false;">iPad</a>
                <a href="#" class="quick-menu-item" onclick="searchProducts('Apple Watch'); return false;">Apple Watch</a>
                <a href="#" class="quick-menu-item" onclick="searchProducts('Dyson'); return false;">Dyson</a>
            </div>
            <div class="search-bar-mobile">
                <input type="text" class="search-input" placeholder="Например, 17 Pro Max" id="searchInputMobile">
                <button class="search-icon-btn" aria-label="Найти" onclick="searchFromIcon()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/>
                        <line x1="16.65" y1="16.65" x2="21" y2="21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <button class="catalog-icon-btn" onclick="toggleCatalogDropdown(event)" aria-label="Каталог">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
        
        <button class="cart-icon-btn" onclick="openCart()" aria-label="Корзина">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <path d="M16 10a4 4 0 0 1-8 0"></path>
            </svg>
            <span class="cart-badge" id="cartBadgeFloating" style="display: none;">0</span>
        </button>
        
        <div id="content">
            <div class="page-loading">
                <div class="spinner"><img src="/static/images/logo.jpg" alt="Loading..."></div>
            </div>
        </div>
    </div>

    <!-- About footer (bottom block) -->
    <footer class="about-footer">
        <div class="grid">
            <div>
                <h4>Контакты</h4>
                <div class="about-kv">
                    <div><a href="tel:+79776208299" class="phone-link">+7 (977) 620-82-99</a></div>
                    <div style="margin-bottom: 20px;">Телефон службы заботы, 10:00 – 21:00</div>
                    <div style="margin-top: 8px; margin-bottom: 20px;">
                        Для тех, кому удобнее общаться в мессенджерах, пишите в специальный чат<br>
                        <a href="https://t.me/yoo_manager" target="_blank" style="color: #2d6cdf; text-decoration: none; display: inline-flex; align-items: center; gap: 4px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.295-.6.295-.002 0-.003 0-.005 0l.213-3.054 5.56-5.022c.24-.213-.054-.334-.373-.12l-6.869 4.326-2.96-.924c-.64-.203-.658-.64.135-.954l11.566-4.458c.538-.196 1.006.128.832.941z"/>
                            </svg>
                            Telegram
                        </a>
                    </div>
                    <div style="margin-top: 8px;">
                        Почта для вопросов, сотрудничества и предложений по улучшению<br>
                        <a href="mailto:yo.store@mail.ru" style="color: #2d6cdf; text-decoration: none; display: inline-flex; align-items: center; gap: 4px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                            </svg>
                            yo.store@mail.ru
                        </a>
                    </div>
                </div>
            </div>
            <div>
                <h4>Наши социальные сети</h4>
                <div class="about-kv">
                    <div>
                        <a href="https://t.me/yo_price" target="_blank" style="color: #2d6cdf; text-decoration: none; display: inline-flex; align-items: center; gap: 4px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.295-.6.295-.002 0-.003 0-.005 0l.213-3.054 5.56-5.022c.24-.213-.054-.334-.373-.12l-6.869 4.326-2.96-.924c-.64-.203-.658-.64.135-.954l11.566-4.458c.538-.196 1.006.128.832.941z"/>
                            </svg>
                            Telegram Канал
                        </a>
                    </div>
                </div>
            </div>
            <div>
                <h4>Адрес</h4>
                <div class="about-kv">
                    <div style="margin-bottom: 8px;">
                        <a href="https://yandex.com/maps/-/CLvKYC66" target="_blank" style="color: #2d6cdf; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s ease;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            г. Москва, пр-д Багратионовский, 7к20а, офис 1728
                        </a>
                    </div>
                    <div>Пн–Вс: 10:00–19:00</div>
                </div>
            </div>
            <div>
                <h4>Дополнительная информация</h4>
                <ul class="about-list">
                    <li><a href="#" onclick="loadGuaranteePage(); return false;" style="color: #444; text-decoration: none;">Гарантия</a></li>
                    <li><a href="#" onclick="loadDeliveryPage(); return false;" style="color: #444; text-decoration: none;">Доставка и оплата</a></li>
                    <li><a href="https://t.me/yo_feedback" target="_blank" style="color: #444; text-decoration: none;">Отзывы</a></li>
                </ul>
            </div>
        </div>
    </footer>

    <!-- Info Modal (Гарантия / Доставка и оплата) -->
    <div class="about-backdrop" id="infoBackdrop" onclick="backdropInfoClick(event)">
        <div class="about-modal">
            <div class="about-header">
                <div class="about-title" id="infoModalTitle">Гарантия</div>
                <button class="about-close" onclick="closeInfoModal()">×</button>
            </div>
            <div class="about-content" id="infoModalContent">
                <!-- Контент будет загружен динамически -->
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div class="cart-modal" id="cartModal">
        <div class="cart-container" style="position: relative;">
            <button class="cart-close-btn" onclick="closeCart()">×</button>
            
            <div class="cart-form-section">
                <h2 class="cart-title">Оформить заказ</h2>
                <form id="cartForm" onsubmit="submitCart(event)">
                    <div class="form-group">
                        <input type="text" id="customerName" name="name" required placeholder="Имя *" autocomplete="on">
                    </div>
                    <div class="form-group">
                        <select id="contactMethod" name="contact_method" class="form-select" onchange="handleContactMethodChange(this.value)" required>
                            <option value="">Как с вами связаться?</option>
                            <option value="phone">Телефон</option>
                            <option value="email">Email</option>
                            <option value="telegram">Telegram</option>
                            <option value="whatsapp">WhatsApp</option>
                        </select>
                    </div>
                    <!-- Динамические поля для контакта -->
                    <div class="form-group contact-field" id="contactPhoneField" style="display: none;">
                        <input type="tel" id="contactPhone" name="contact_phone" placeholder="Телефон для связи" autocomplete="tel">
                    </div>
                    <div class="form-group contact-field" id="contactEmailField" style="display: none;">
                        <input type="email" id="contactEmail" name="contact_email" placeholder="Email для связи" autocomplete="email">
                    </div>
                    <div class="form-group contact-field" id="contactTelegramField" style="display: none;">
                        <input type="text" id="contactTelegram" name="contact_telegram" placeholder="Telegram username (например: @username)" autocomplete="off">
                    </div>
                    <div class="form-group contact-field" id="contactWhatsAppField" style="display: none;">
                        <input type="tel" id="contactWhatsApp" name="contact_whatsapp" placeholder="WhatsApp номер" autocomplete="tel">
                    </div>
                    <div class="form-group">
                        <label class="form-group-title">Способ получения</label>
                        <div class="shipping-switch">
                            <label class="shipping-option">
                                <input type="radio" name="shipping_type" value="delivery" checked>
                                <span class="shipping-label">
                                    <span class="shipping-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <rect x="1" y="3" width="15" height="13"></rect>
                                            <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                                            <circle cx="5.5" cy="18.5" r="2.5"></circle>
                                            <circle cx="18.5" cy="18.5" r="2.5"></circle>
                                        </svg>
                                    </span>
                                    <span class="shipping-text">Доставка</span>
                                </span>
                            </label>
                            <label class="shipping-option">
                                <input type="radio" name="shipping_type" value="pickup">
                                <span class="shipping-label">
                                    <span class="shipping-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                            <circle cx="12" cy="10" r="3"></circle>
                                        </svg>
                                    </span>
                                    <span class="shipping-text">Самовывоз</span>
                                </span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group shipping-delivery" id="shippingDelivery">
                        <label class="form-group-title">Выберите способ доставки</label>
                        <div class="shipping-options-list">
                            <label class="shipping-option-item">
                                <input type="radio" name="delivery_option" value="moscow" checked>
                                <div class="shipping-option-box">
                                    <div class="shipping-option-title">По Москве</div>
                                    <div class="shipping-option-desc">Собственная курьерская служба. Доставим бережно и быстро ваш заказ, сохраняя высокий уровень сервиса.</div>
                                    <div class="shipping-option-price">от 790 ₽</div>
                                </div>
                            </label>
                            <label class="shipping-option-item">
                                <input type="radio" name="delivery_option" value="russia">
                                <div class="shipping-option-box">
                                    <div class="shipping-option-title">По России</div>
                                    <div class="shipping-option-desc">Отправляем заказы по всей России курьерской службой СДЭК. Надежная упаковка, быстрая доставка и удобные пункты выдачи рядом с домом.</div>
                                    <div class="shipping-option-price">от 790 ₽</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="form-group shipping-pickup" id="shippingPickup" style="display: none;">
                        <label class="form-group-title">Самовывоз</label>
                        <div class="shipping-option-box" style="border-color: #007AFF; background: rgba(0, 122, 255, 0.03);">
                            <div class="shipping-option-title">Наш магазин</div>
                            <div class="shipping-option-desc" style="margin-top: 8px; margin-bottom: 12px;">
                                Вы можете получить ваш заказ в нашем уютном магазине в центре Москвы. Для всех клиентов есть собственная бесплатная парковка.
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #6b7280; flex-shrink: 0;">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                        <circle cx="12" cy="10" r="3"></circle>
                                    </svg>
                                    <div style="font-size: 0.875rem; color: #111827; font-weight: 500;">г. Москва, ул. Примерная, 10, офис 5</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #6b7280; flex-shrink: 0;">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                    <div style="font-size: 0.875rem; color: #6b7280;">Пн–Вс: 10:00–20:00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <textarea id="customerAddress" name="address" rows="2" placeholder="Адрес доставки"></textarea>
                    </div>
                    <div class="form-group">
                        <textarea id="customerComment" name="comment" rows="2" placeholder="Комментарий к заказу"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-group-title">Выберите время доставки</label>
                        <div style="position: relative;">
                            <input type="text" id="deliveryDateTime" name="delivery_datetime" placeholder="Дата и время" readonly style="padding-right: 40px;">
                            <svg style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; pointer-events: none; color: #6b7280;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; align-items: stretch;">
                        <button type="submit" class="cart-submit-btn" id="cartSubmitBtn" style="flex: 1; margin-top: 0;">Оформить заказ</button>
                        <button type="button" class="cart-telegram-btn" id="cartTelegramBtn" onclick="sendOrderToTelegram()" title="Отправить заказ в Telegram" style="margin-top: 0;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 6px;">
                                <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.295-.6.295-.002 0-.003 0-.005 0l.213-3.054 5.56-5.022c.24-.213-.054-.334-.373-.12l-6.869 4.326-2.96-.924c-.64-.203-.658-.64.135-.954l11.566-4.458c.538-.196 1.006.128.832.941z"/>
                            </svg>
                            <span>В Telegram</span>
                        </button>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.85rem; color: #6b7280; text-align: center;">
                        <span style="color: #007AFF;">«Оформить заказ»</span> — мы примем заказ в работу и свяжемся с вами по выбранному каналу связи
                    </div>
                    <div class="cart-consent-text">
                        Нажимая на кнопку, вы даете согласие на обработку персональных данных
                    </div>
                </form>
            </div>
            
            <div class="cart-items-section">
                <h2 class="cart-title">Корзина</h2>
                <div class="cart-items-list" id="cartItemsList">
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        Корзина пуста
                    </div>
                </div>
                <div class="cart-total" id="cartTotal" style="display: none;">
                    <!-- Промокод -->
                    <div class="promo-code-section" style="margin-bottom: 12px;">
                        <!-- Кликабельный текст "Добавить промокод" -->
                        <div 
                            id="addPromoCodeBtn" 
                            onclick="togglePromoCodeInput()" 
                            style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer; color: #007AFF; font-size: 0.875rem; font-weight: 500; transition: all 0.2s; user-select: none;"
                            onmouseover="this.style.color='#0051D5'; this.style.opacity='0.8'" 
                            onmouseout="this.style.color='#007AFF'; this.style.opacity='1'"
                        >
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink: 0;">
                                <path d="M4 7.5C4 6.12 5.12 5 6.5 5h11C18.88 5 20 6.12 20 7.5v9c0 1.38-1.12 2.5-2.5 2.5h-11C5.12 19 4 17.88 4 16.5v-9Z"></path>
                                <path d="M4 9h16"></path>
                                <path d="M8 13h.01"></path>
                                <path d="M12 13h.01"></path>
                            </svg>
                            <span id="addPromoCodeText">Добавить промокод</span>
                        </div>
                        
                        <!-- Поле ввода промокода (скрыто по умолчанию) -->
                        <div id="promoCodeInputSection" style="display: none; margin-top: 12px; padding: 12px; background: #f9fafb; border-radius: 8px;">
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input 
                                    type="text" 
                                    id="promoCodeInput" 
                                    placeholder="Введите промокод" 
                                    style="flex: 1; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem;"
                                    onkeypress="if(event.key === 'Enter') applyPromoCode()"
                                    oninput="promoCodeInputValue = this.value"
                                >
                                <button 
                                    id="promoCodeBtn" 
                                    onclick="applyPromoCode()" 
                                    style="padding: 8px 16px; background: #007AFF; color: white; border: none; border-radius: 6px; font-size: 0.875rem; cursor: pointer; white-space: nowrap;"
                                >
                                    Применить
                                </button>
                            </div>
                            <div id="promoCodeMessage" style="margin-top: 8px; font-size: 0.75rem;"></div>
                            <div id="promoCodeInfo" style="margin-top: 8px; font-size: 0.875rem; color: #059669; display: none;"></div>
                        </div>
                        
                        <!-- Информация о примененном промокоде -->
                        <div id="appliedPromoCodeInfo" style="display: none; margin-top: 12px; padding: 12px; background: #ecfdf5; border: 1px solid #a7f3d0; border-radius: 8px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #059669;">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                    </svg>
                                    <div>
                                        <div style="font-size: 0.875rem; font-weight: 500; color: #059669;" id="appliedPromoCodeName"></div>
                                        <div style="font-size: 0.75rem; color: #047857; margin-top: 2px;" id="appliedPromoCodeDesc"></div>
                                    </div>
                                </div>
                                <button 
                                    onclick="removePromoCode()" 
                                    style="padding: 4px 8px; background: transparent; border: none; color: #dc2626; cursor: pointer; font-size: 0.75rem;"
                                >
                                    Удалить
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="cart-total-item">
                        <span class="cart-total-label">Сумма</span>
                        <span class="cart-total-value" id="cartSubtotalPrice">0 ₽</span>
                    </div>
                    <div class="cart-total-item" id="promoCodeDiscountItem" style="display: none;">
                        <span class="cart-total-label" style="color: #059669;">Скидка</span>
                        <span class="cart-total-value" style="color: #059669;" id="promoCodeDiscount">0 ₽</span>
                    </div>
                    <div class="cart-total-item">
                        <span class="cart-total-label">Доставка</span>
                        <span class="cart-total-value">⏤</span>
                    </div>
                    <div class="cart-total-note" style="font-size: 0.75rem; color: #6b7280; margin-top: -8px; margin-bottom: 8px; padding-left: 0;">
                        Стоимость доставки не включена в итоговую сумму заказа
                    </div>
                    <div class="cart-total-item cart-total-final">
                        <span class="cart-total-label">Итого</span>
                        <span class="cart-total-price" id="cartTotalPrice">0 ₽</span>
                    </div>
                    
                    <!-- Рекомендации -->
                    <div class="cart-recommendations" id="cartRecommendations" style="display: none;">
                        <div class="cart-recommendations-title">Рекомендуем также</div>
                        <div class="cart-recommendations-list" id="cartRecommendationsList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let currentView = 'categories';
        let isNavigatingFromHistory = false; // Флаг для предотвращения добавления в историю при восстановлении
        let currentProductModelName = null; // Модель продукта для детальной страницы
        
        // Проверка версии приложения и обновление при изменении
        (function() {
            const currentVersion = document.querySelector('meta[name="app-version"]')?.content;
            
            if (currentVersion) {
                const storedVersion = sessionStorage.getItem('app-version');
                
                // Если версия изменилась, очищаем кэш и перезагружаем
                if (storedVersion && storedVersion !== currentVersion) {
                    console.log('Обнаружена новая версия приложения, обновляем...');
                    // Очищаем кэш
                    sessionStorage.clear();
                    localStorage.clear();
                    
                    // Очищаем кэш браузера через принудительную перезагрузку
                    if ('caches' in window) {
                        caches.keys().then(function(names) {
                            for (let name of names) {
                                caches.delete(name);
                            }
                        });
                    }
                    
                    // Перезагружаем с обходом кэша
                    window.location.href = window.location.href.split('?')[0] + '?v=' + currentVersion + '&_=' + Date.now();
                    return;
                } else if (!storedVersion) {
                    // Первый запуск - сохраняем версию
                    sessionStorage.setItem('app-version', currentVersion);
                }
            }
        })();
        // Render category icon with overrides
        function renderCategoryIcon(name, fallbackIcon) {
            const n = String(name || '').toLowerCase();
            
            // Для категории "Ноутбуки" используем изображение
            if (n.includes('ноутбук') || n.includes('laptop') || n.includes('macbook')) {
                return `<img src="https://static.re-store.ru/upload/resize_cache/iblock/986/100500_800_140cd750bba9870f18aada2478b24840a/waidg8h9cgj34fqht941w4rm4uvxq0q3.jpg" alt="Ноутбуки" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;">`;
            }
            
            // Для категории "Смартфоны" используем изображение
            if (n.includes('смартфон') || n.includes('smartphone') || n.includes('phone')) {
                return `<img src="https://static.re-store.ru/upload/resize_cache/iblock/119/100500_800_140cd750bba9870f18aada2478b24840a/o97ih0va5sa2zx7a4qra1x3nnk10nfiy.jpg" alt="Смартфоны" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;">`;
            }
            
            // Для категории "Аксессуары для консолей" используем изображение (проверяем ДО общей категории "Аксессуары")
            if ((n.includes('аксессуар') && n.includes('консол')) || (n.includes('accessory') && n.includes('console'))) {
                return `<img src="https://img.mvideo.ru/Big/40079048bb1.jpg" alt="Аксессуары для консолей" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;">`;
            }
            
            // Для категории "Игровые приставки" используем изображение
            if (n.includes('игров') || n.includes('приставк') || n.includes('консол') || n.includes('game') || n.includes('console')) {
                return `<img src="https://img.mvideo.ru/Big/40079746bb.jpg" alt="Игровые приставки" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;">`;
            }
            
            // Для категории "Умные колонки" используем изображение (меньший масштаб)
            if ((n.includes('умн') && n.includes('колонк')) || (n.includes('smart') && n.includes('speaker')) || n.includes('homepod')) {
                return `<img src="https://rebro-store.ru/upload/iblock/0ef/8e1ur9ax61awjxhkk6impb61xecy5ty1.jpg" alt="Умные колонки" style="width: 70%; height: 70%; object-fit: contain; border-radius: 8px;">`;
            }
            
            // Для категории "Аксессуары" используем изображение
            if (n.includes('аксессуар') || n.includes('accessory') || n.includes('accessories')) {
                return `<img src="https://static.re-store.ru/upload/resize_cache/iblock/d50/1120_560_140cd750bba9870f18aada2478b24840a/sk0o9i98co0nnws077to80jfukvw0rdd.jpg" alt="Аксессуары" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;">`;
            }
            
            // Для категории "Умные браслеты" используем изображение
            if ((n.includes('умн') && n.includes('браслет')) || (n.includes('smart') && n.includes('band')) || n.includes('watch') || n.includes('часы')) {
                return `<img src="https://avatars.mds.yandex.net/get-mpic/5234126/2a000001997d994413804a8fedefabad1ea8/optimize" alt="Умные браслеты" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;">`;
            }
            
            return fallbackIcon || '📦';
        }
        
        // Get brand icon URL
        function getBrandIcon(brandName) {
            const brand = String(brandName || '').toLowerCase().trim();
            const brandIcons = {
                'apple': 'https://static.re-store.ru/upload/iblock/8cc/dsxngkggfd466t9owvtet1cpo5g8400h.svg',
                'samsung': 'https://static.re-store.ru/upload/iblock/ce1/5x2fyj9a1phrp2v3lo5yklv0kxmk1aj8.svg',
                'sony': 'https://static.re-store.ru/upload/iblock/211/5bzxi8nayu7le0145vlgy77qsqi9wyda.svg',
                'yandex': 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/91/Yandex_logo_en.svg/640px-Yandex_logo_en.svg.png',
                'jbl': 'https://static.re-store.ru/upload/iblock/0a2/wg0529eswoa98mwho7h1nomf56evzjgi.svg',
                'whoop': 'https://upload.wikimedia.org/wikipedia/commons/4/4c/WHOOP_Logo_Black.svg'
            };
            return brandIcons[brand] || null;
        }
        
        // Render brand icon or name
        function renderBrandIcon(brandName) {
            const iconUrl = getBrandIcon(brandName);
            if (iconUrl) {
                const brand = String(brandName || '').toLowerCase().trim();
                // Специальный размер для whoop
                if (brand === 'whoop') {
                    return `<img src="${iconUrl}" alt="${brandName}" style="height: 24px; width: auto; max-width: 70px; object-fit: contain; display: block;">`;
                }
                // Специальный размер для yandex
                if (brand === 'yandex') {
                    return `<img src="${iconUrl}" alt="${brandName}" class="yandex-brand-icon" style="height: 20px; width: auto; max-width: 80px; object-fit: contain; display: block;">`;
                }
                return `<img src="${iconUrl}" alt="${brandName}" style="height: 28px; width: auto; max-width: 100px; object-fit: contain; display: block;">`;
            }
            return `<span class="brand-name">${brandName}</span>`;
        }
        
        // Глобальные переменные для фильтрации
        let currentBrandFilter = null;
        let currentLevel0Filter = null;
        let currentLevel1Filter = null;
        let currentLevel2Filter = null;
        let currentCategoryId = null; // Сохраняем ID текущей категории
        let currentCategoryName = null; // Сохраняем название текущей категории
        
        // Объект для хранения текущих фильтров
        let currentFilters = {
            level0: null,
            level1: null,
            level2: null,
            brand: null
        };
        
        // Сохранение и восстановление состояния
        function saveAppState() {
            const state = {
                currentView: currentView,
                currentCategoryId: currentCategoryId,
                currentCategoryName: currentCategoryName,
                currentBrandFilter: currentBrandFilter,
                currentLevel0Filter: currentLevel0Filter,
                currentLevel1Filter: currentLevel1Filter,
                currentLevel2Filter: currentLevel2Filter,
                currentProductId: currentProductId,
                currentProductModelName: currentProductModelName,
                searchQuery: document.getElementById('searchInput')?.value || '',
                timestamp: Date.now()
            };
            localStorage.setItem('yo_mini_app_state', JSON.stringify(state));
            console.log('💾 Состояние сохранено:', state);
        }
        
        function restoreAppState() {
            try {
                const savedState = localStorage.getItem('yo_mini_app_state');
                if (!savedState) return false;
                
                const state = JSON.parse(savedState);
                
                // Проверяем что состояние не слишком старое (24 часа)
                if (Date.now() - state.timestamp > 24 * 60 * 60 * 1000) {
                    localStorage.removeItem('yo_mini_app_state');
                    return false;
                }
                
                // Восстанавливаем состояние
                currentView = state.currentView || 'categories';
                currentCategoryId = state.currentCategoryId;
                currentCategoryName = state.currentCategoryName;
                currentBrandFilter = state.currentBrandFilter;
                currentLevel0Filter = state.currentLevel0Filter;
                currentLevel1Filter = state.currentLevel1Filter;
                currentLevel2Filter = state.currentLevel2Filter;
                currentProductId = state.currentProductId;
                currentProductModelName = state.currentProductModelName || null;
                
                console.log('🔄 Состояние восстановлено:', state);
                return true;
            } catch (error) {
                console.error('Ошибка восстановления состояния:', error);
                localStorage.removeItem('yo_mini_app_state');
                return false;
            }
        }
        
        // Initialize app
        // Отслеживание видимости корзины в header
        function setupCartVisibilityObserver() {
            const headerCartBtns = document.querySelectorAll('.cart-icon-btn-header');
            const floatingCartBtn = document.querySelector('.cart-icon-btn');
            
            if (!headerCartBtns.length || !floatingCartBtn) return;
            
            // Храним состояние видимости каждой кнопки
            const visibilityMap = new Map();
            
            // Используем Intersection Observer для отслеживания видимости всех кнопок корзины в header
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    // Сохраняем состояние видимости для каждой кнопки
                    visibilityMap.set(entry.target, entry.isIntersecting);
                });
                
                // Проверяем, видна ли хотя бы одна кнопка корзины в header
                let anyVisible = false;
                headerCartBtns.forEach(btn => {
                    if (visibilityMap.get(btn)) {
                        anyVisible = true;
                    }
                });
                
                // Если хотя бы одна кнопка корзины в header видна, скрываем плавающую кнопку
                if (anyVisible) {
                    floatingCartBtn.classList.remove('visible');
                } else {
                    floatingCartBtn.classList.add('visible');
                }
            }, {
                threshold: 0.1, // Срабатывает когда видно хотя бы 10%
                rootMargin: '0px'
            });
            
            // Отслеживаем все кнопки корзины в header (десктопная и мобильная)
            headerCartBtns.forEach(btn => {
                observer.observe(btn);
            });
        }
        
        // Floating catalog button visibility
        function initFloatingCatalogButton() {
            const headerCatalogBtns = document.querySelectorAll('.catalog-btn');
            const floatingCatalogBtn = document.querySelector('.catalog-icon-btn');
            
            if (!headerCatalogBtns.length || !floatingCatalogBtn) return;
            
            // Храним состояние видимости каждой кнопки
            const visibilityMap = new Map();
            
            // Используем Intersection Observer для отслеживания видимости всех кнопок каталога в header
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    // Сохраняем состояние видимости для каждой кнопки
                    visibilityMap.set(entry.target, entry.isIntersecting);
                });
                
                // Проверяем, видна ли хотя бы одна кнопка каталога в header
                let anyVisible = false;
                headerCatalogBtns.forEach(btn => {
                    if (visibilityMap.get(btn)) {
                        anyVisible = true;
                    }
                });
                
                // Если хотя бы одна кнопка каталога в header видна, скрываем плавающую кнопку
                if (anyVisible) {
                    floatingCatalogBtn.classList.remove('visible');
                } else {
                    floatingCatalogBtn.classList.add('visible');
                }
            }, {
                threshold: 0.1, // Срабатывает когда видно хотя бы 10%
                rootMargin: '0px'
            });
            
            // Отслеживаем все кнопки каталога в header (мобильная версия)
            headerCatalogBtns.forEach(btn => {
                observer.observe(btn);
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, starting initialization...');
            
            // Тест что JavaScript работает
            setTimeout(() => {
                console.log('JavaScript is working - DOM fully loaded');
                const content = document.getElementById('content');
                if (content) {
                    console.log('Content element found:', content);
                } else {
                    console.error('Content element not found!');
                }
            }, 1000);
            
            try {
                // Пытаемся восстановить состояние
                const stateRestored = restoreAppState();
                
                // Проверяем, нужно ли восстановить страницы
                if (stateRestored && currentView === 'product_detail' && currentProductModelName) {
                    loadProductDetailPage(currentProductModelName);
                } else if (stateRestored && currentView === 'guarantee') {
                    loadGuaranteePage();
                } else if (stateRestored && currentView === 'delivery') {
                    loadDeliveryPage();
                } else if (stateRestored && currentBrandFilter) {
                    // Если был выбран бренд, загружаем товары бренда
                    loadProductsByBrand(currentBrandFilter, currentLevel0Filter);
                } else if (stateRestored && currentCategoryId) {
                    // Если была выбрана категория, загружаем товары категории
                    loadProducts(currentCategoryId);
                } else {
                    // Иначе загружаем категории (главная страница)
                    loadCategories();
                }
                
                setupSearch();
                setupCartVisibilityObserver();
                initFloatingCatalogButton();
                
                // Инициализируем поддержку свайпов
                initializeSwipeSupport();
                
                // Сохраняем состояние при закрытии страницы
                window.addEventListener('beforeunload', saveAppState);
                
                // Обработчик кнопки "Назад" в браузере
                window.addEventListener('popstate', (event) => {
                    console.log('🔙 Browser back button pressed, state:', event.state);
                    isNavigatingFromHistory = true;
                    
                    if (event.state) {
                        // Восстанавливаем состояние из истории
                        const state = event.state;
                        currentView = state.view || 'categories';
                        currentCategoryId = state.categoryId || null;
                        currentCategoryName = state.categoryName || null;
                        currentBrandFilter = state.brandFilter || null;
                        currentLevel0Filter = state.level0Filter || null;
                        currentLevel1Filter = state.level1Filter || null;
                        currentLevel2Filter = state.level2Filter || null;
                        currentProductId = state.productId || null;
                        
                        // Восстанавливаем страницу в зависимости от view
                        if (currentView === 'product_detail' && state.modelName) {
                            loadProductDetailPage(state.modelName);
                        } else if (currentView === 'guarantee') {
                            loadGuaranteePage();
                        } else if (currentView === 'delivery') {
                            loadDeliveryPage();
                        } else if (currentBrandFilter) {
                            loadProductsByBrand(currentBrandFilter, currentLevel0Filter);
                        } else if (currentCategoryId) {
                            loadProducts(currentCategoryId);
                        } else {
                            loadCategories();
                        }
                    } else {
                        // Если нет состояния, возвращаемся на главную
                        goToHomePage();
                    }
                    
                    setTimeout(() => {
                        isNavigatingFromHistory = false;
                    }, 100);
                });
                
                // Добавляем начальное состояние в историю
                if (!history.state) {
                    pushHistoryState('categories', {
                        view: 'categories',
                        categoryId: null,
                        categoryName: null,
                        brandFilter: null,
                        level0Filter: null
                    });
                }
                
                // Таймаут на случай если загрузка застряла
                setTimeout(() => {
                    const content = document.getElementById('content');
                    if (content.textContent.includes('загрузка')) {
                        console.error('Loading timeout - forcing reload');
                        showError('Время загрузки истекло. Попробуйте обновить страницу.');
                    }
                }, 10000); // 10 секунд
                
            } catch (error) {
                console.error('Initialization error:', error);
                showError('Ошибка инициализации приложения: ' + error.message);
            }
            
            // Закрытие корзины при клике на overlay
            const cartModal = document.getElementById('cartModal');
            if (cartModal) {
                cartModal.addEventListener('click', function(e) {
                    // Закрываем корзину только если клик был на сам modal (overlay), а не на контейнер
                    if (e.target === cartModal) {
                        closeCart();
                    }
                });
            }
        });
        
        // Setup search functionality
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchInputMobile = document.getElementById('searchInputMobile');
            const searchBar = document.querySelector('.search-bar');
            const searchBarMobile = document.querySelector('.search-bar-mobile');
            let searchTimeout;
            
            function handleSearch(value) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const query = value.trim();
                    // Синхронизируем значения между полями
                    if (searchInput && searchInputMobile) {
                        searchInput.value = query;
                        searchInputMobile.value = query;
                    }
                    if (query.length > 2) {
                        searchProducts(query);
                    } else if (query.length === 0 && currentView === 'search') {
                        loadCategories();
                    }
                }, 500);
            }
            
            // Desktop search bar
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    handleSearch(this.value);
                });
            }
            
            // Mobile search bar
            if (searchInputMobile) {
                searchInputMobile.addEventListener('input', function() {
                    handleSearch(this.value);
                });
            }
        }
        
        function searchFromIcon() {
            const input = document.getElementById('searchInput') || document.getElementById('searchInputMobile');
            if (!input) return;
            const query = input.value.trim();
            // Синхронизируем значения между полями
            const searchInput = document.getElementById('searchInput');
            const searchInputMobile = document.getElementById('searchInputMobile');
            if (searchInput && searchInputMobile) {
                searchInput.value = query;
                searchInputMobile.value = query;
            }
            if (query.length > 2) {
                searchProducts(query);
            } else if (query.length === 0 && currentView === 'search') {
                loadCategories();
            }
        }
        
        // Clear filters function
        function clearFilters() {
            // Clear hierarchy filters
            const hierarchyFilters = document.getElementById('hierarchyFilters');
            if (hierarchyFilters) {
                hierarchyFilters.style.display = 'none';
            }
            
            // Clear active filter buttons
            const activeButtons = document.querySelectorAll('.filter-btn.active');
            activeButtons.forEach(btn => btn.classList.remove('active'));
            
            // Reset current filters
            currentFilters = {
                level0: null,
                level1: null,
                level2: null,
                brand: null
            };
        }
        
        // Go to home page function
        // Toggle catalog dropdown
        function toggleCatalogDropdown(event) {
            event.stopPropagation();
            const dropdown = document.querySelector('.catalog-dropdown');
            const menu = document.getElementById('catalogDropdownMenu');
            const overlay = document.getElementById('catalogOverlay');
            const floatingCatalogBtn = document.querySelector('.catalog-icon-btn');
            
            if (dropdown.classList.contains('active')) {
                closeCatalogDropdown();
            } else {
                dropdown.classList.add('active');
                menu.classList.add('show');
                if (overlay) overlay.classList.add('show');
                // Скрываем всплывающую кнопку каталога при открытии меню
                if (floatingCatalogBtn) {
                    floatingCatalogBtn.classList.remove('visible');
                }
                // Предотвращаем прокрутку body и html при открытом каталоге
                document.body.style.overflow = 'hidden';
                document.documentElement.style.overflow = 'hidden';
                // Сохраняем текущую позицию прокрутки
                const scrollY = window.scrollY;
                document.body.style.position = 'fixed';
                document.body.style.top = `-${scrollY}px`;
                document.body.style.width = '100%';
                loadCatalogDropdown();
            }
        }
        
        // Load categories into dropdown menu
        async function loadCatalogDropdown() {
            const content = document.getElementById('catalogDropdownContent');
            if (!content) return;
            
            try {
                content.innerHTML = '<div class="catalog-dropdown-loading">Загрузка...</div>';
                
                const categoriesResponse = await fetch(`${API_BASE}/categories`);
                if (!categoriesResponse.ok) {
                    throw new Error(`HTTP ${categoriesResponse.status}: ${categoriesResponse.statusText}`);
                }
                const categories = await categoriesResponse.json();
                
                let menuHtml = '';
                for (const category of categories) {
                    const icon = renderCategoryIcon(category.name, category.icon);
                    menuHtml += `
                        <button class="catalog-dropdown-item" onclick="event.stopPropagation(); loadCategoryBrands(${category.id}, '${category.level_0}');">
                            <div class="category-icon">${icon}</div>
                            <div class="category-info">
                                <div class="category-name">${category.name}</div>
                                <div class="category-count">${category.product_count} товаров</div>
                            </div>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-left: auto;">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                    `;
                }
                
                // Добавляем разделы для мобильной версии
                const isMobile = window.innerWidth <= 768;
                if (isMobile) {
                    menuHtml += `
                        <div style="border-top: 1px solid #e5e7eb; margin: 8px 0;"></div>
                        <button class="catalog-dropdown-item catalog-section-item" onclick="event.stopPropagation(); closeCatalogDropdown(); goToHomePage();">
                            <div class="category-icon">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                </svg>
                            </div>
                            <div class="category-info">
                                <div class="category-name">Главная</div>
                            </div>
                        </button>
                        <button class="catalog-dropdown-item catalog-section-item" onclick="event.stopPropagation(); closeCatalogDropdown(); loadGuaranteePage();">
                            <div class="category-icon">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                </svg>
                            </div>
                            <div class="category-info">
                                <div class="category-name">Гарантия</div>
                            </div>
                        </button>
                        <button class="catalog-dropdown-item catalog-section-item" onclick="event.stopPropagation(); closeCatalogDropdown(); loadDeliveryPage();">
                            <div class="category-icon">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M1 3h15v13H1zM16 8h4l3 3v5h-7V8z"></path>
                                    <circle cx="5.5" cy="18.5" r="2.5"></circle>
                                    <circle cx="18.5" cy="18.5" r="2.5"></circle>
                                </svg>
                            </div>
                            <div class="category-info">
                                <div class="category-name">Доставка и оплата</div>
                            </div>
                        </button>
                        <button class="catalog-dropdown-item catalog-section-item" onclick="event.stopPropagation(); closeCatalogDropdown(); document.querySelector('.about-footer')?.scrollIntoView({behavior: 'smooth'});">
                            <div class="category-icon">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                    <circle cx="12" cy="10" r="3"></circle>
                                </svg>
                            </div>
                            <div class="category-info">
                                <div class="category-name">Контакты</div>
                            </div>
                        </button>
                        <button class="catalog-dropdown-item catalog-section-item" onclick="event.stopPropagation(); closeCatalogDropdown(); window.open('https://t.me/yo_feedback', '_blank');">
                            <div class="category-icon">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                </svg>
                            </div>
                            <div class="category-info">
                                <div class="category-name">Отзывы</div>
                            </div>
                        </button>
                        <button class="catalog-dropdown-item catalog-section-item" onclick="event.stopPropagation(); closeCatalogDropdown(); window.open('https://t.me/yo_price', '_blank');">
                            <div class="category-icon">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.295-.6.295-.002 0-.003 0-.005 0l.213-3.054 5.56-5.022c.24-.213-.054-.334-.373-.12l-6.869 4.326-2.96-.924c-.64-.203-.658-.64.135-.954l11.566-4.458c.538-.196 1.006.128.832.941z"/>
                                </svg>
                            </div>
                            <div class="category-info">
                                <div class="category-name">Telegram</div>
                            </div>
                        </button>
                    `;
                }
                
                content.innerHTML = menuHtml;
                // Принудительно перерисовываем для применения анимации
                void content.offsetHeight;
            } catch (error) {
                console.error('Error loading catalog dropdown:', error);
                content.innerHTML = '<div class="catalog-dropdown-loading" style="color: #ef4444;">Ошибка загрузки</div>';
            }
        }
        
        // Load brands for category in dropdown
        async function loadCategoryBrands(categoryId, level0) {
            const content = document.getElementById('catalogDropdownContent');
            if (!content) return;
            
            try {
                content.innerHTML = '<div class="catalog-dropdown-loading">Загрузка...</div>';
                
                // Получаем категорию для названия
                const categoriesResponse = await fetch(`${API_BASE}/categories`);
                const categories = await categoriesResponse.json();
                const category = categories.find(cat => cat.id === categoryId);
                
                // Получаем бренды для этой категории
                const categoryBrandsResponse = await fetch(`${API_BASE}/hierarchy/brands?level0=${encodeURIComponent(level0)}`);
                const categoryBrands = await categoryBrandsResponse.json();
                
                // Для каждого бренда проверяем наличие товаров
                const brandData = [];
                for (const brand of categoryBrands) {
                    try {
                        const countResponse = await fetch(`${API_BASE}/products?brand=${encodeURIComponent(brand)}&level0=${encodeURIComponent(level0)}&limit=1`);
                        const products = await countResponse.json();
                        if (products && products.length > 0) {
                            brandData.push(brand);
                        }
                    } catch (error) {
                        console.warn(`Ошибка получения товаров для бренда ${brand}:`, error);
                    }
                }
                
                let menuHtml = `
                    <button class="catalog-dropdown-item" onclick="event.stopPropagation(); loadCatalogDropdown();" style="border-bottom: 1px solid #e5e7eb;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                        <div class="category-info">
                            <div class="category-name">${category ? category.name : 'Назад'}</div>
                        </div>
                    </button>
                `;
                
                for (const brand of brandData) {
                    menuHtml += `
                        <button class="catalog-dropdown-item" onclick="event.stopPropagation(); closeCatalogDropdown(); loadProductsByBrand('${brand}', '${level0}');">
                            <div class="category-icon">${renderBrandIcon(brand)}</div>
                            <div class="category-info">
                                <div class="category-name">${brand}</div>
                            </div>
                        </button>
                    `;
                }
                
                content.innerHTML = menuHtml;
                // Принудительно перерисовываем для применения анимации
                void content.offsetHeight;
            } catch (error) {
                console.error('Error loading category brands:', error);
                content.innerHTML = '<div class="catalog-dropdown-loading" style="color: #ef4444;">Ошибка загрузки</div>';
            }
        }
        
        // Close catalog dropdown
        function closeCatalogDropdown() {
            const dropdown = document.querySelector('.catalog-dropdown');
            const menu = document.getElementById('catalogDropdownMenu');
            const overlay = document.getElementById('catalogOverlay');
            const floatingCatalogBtn = document.querySelector('.catalog-icon-btn');
            
            if (dropdown) {
                dropdown.classList.remove('active');
            }
            if (menu) {
                menu.classList.remove('show');
            }
            if (overlay) {
                overlay.classList.remove('show');
            }
            // Восстанавливаем прокрутку body и html
            const scrollY = document.body.style.top;
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.width = '';
            document.body.style.overflow = '';
            document.documentElement.style.overflow = '';
            // Восстанавливаем позицию прокрутки
            if (scrollY) {
                window.scrollTo(0, parseInt(scrollY || '0') * -1);
            }
            
            // Проверяем видимость кнопки каталога в header и показываем всплывающую кнопку, если нужно
            if (floatingCatalogBtn) {
                // Небольшая задержка, чтобы Intersection Observer успел обновиться
                setTimeout(() => {
                    const headerCatalogBtns = document.querySelectorAll('.catalog-btn');
                    let anyVisible = false;
                    
                    // Проверяем видимость кнопок каталога в header
                    headerCatalogBtns.forEach(btn => {
                        const rect = btn.getBoundingClientRect();
                        const isVisible = rect.top >= 0 && rect.bottom <= window.innerHeight && 
                                         rect.left >= 0 && rect.right <= window.innerWidth;
                        if (isVisible) {
                            anyVisible = true;
                        }
                    });
                    
                    // Если ни одна кнопка каталога в header не видна, показываем всплывающую кнопку
                    if (!anyVisible) {
                        floatingCatalogBtn.classList.add('visible');
                    }
                }, 100);
            }
        }
        
        // Close dropdown when clicking outside (overlay handles its own clicks)
        document.addEventListener('click', function(event) {
            const dropdown = document.querySelector('.catalog-dropdown');
            const overlay = document.getElementById('catalogOverlay');
            const menu = document.getElementById('catalogDropdownMenu');
            
            // Закрываем только если клик не на каталоге, не на overlay и каталог открыт
            if (dropdown && menu && menu.classList.contains('show')) {
                if (!dropdown.contains(event.target) && 
                    event.target !== overlay && 
                    !overlay?.contains(event.target) &&
                    !menu.contains(event.target)) {
                closeCatalogDropdown();
                }
            }
        });
        
        // Функция для добавления состояния в историю браузера
        function pushHistoryState(view, stateData) {
            if (isNavigatingFromHistory) {
                return; // Не добавляем в историю при восстановлении из истории
            }
            
            const state = {
                view: view,
                categoryId: currentCategoryId || null,
                categoryName: currentCategoryName || null,
                brandFilter: currentBrandFilter || null,
                level0Filter: currentLevel0Filter || null,
                level1Filter: currentLevel1Filter || null,
                level2Filter: currentLevel2Filter || null,
                productId: currentProductId || null,
                modelName: currentProductModelName || null,
                ...stateData
            };
            
            const url = `#${view}`;
            history.pushState(state, '', url);
            console.log('📝 Added to history:', view, state);
        }
        
        function goToHomePage() {
            console.log('🏠 Going to home page...');
            
            // Close catalog dropdown if open
            closeCatalogDropdown();
            
            // Clear search input
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // Hide products section
            const productsSection = document.getElementById('products');
            if (productsSection) {
                productsSection.style.display = 'none';
            }
            
            // Show categories section
            const categoriesSection = document.getElementById('categories');
            if (categoriesSection) {
                categoriesSection.style.display = 'block';
            }
            
            // Clear any active filters
            clearFilters();
            
            // Reset current view
            currentView = 'categories';
            
            // Добавляем в историю
            pushHistoryState('categories', {
                categoryId: null,
                categoryName: null,
                brandFilter: null,
                level0Filter: null
            });
            
            // Reload categories to show fresh data
            loadCategories();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            console.log('✅ Home page loaded');
        }
        
        // Load guarantee page
        function loadGuaranteePage() {
            currentView = 'guarantee';
            pushHistoryState('guarantee', {});
            saveAppState();
            const content = document.getElementById('content');
            content.innerHTML = `
                <button class="back-button" onclick="goToHomePage()">← Назад на главную</button>
                <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
                    <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 30px; text-align: center; color: #111827; display: flex; align-items: center; justify-content: center; gap: 12px;">
                        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#2d6cdf" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                        Гарантия
                    </h1>
                    <div class="about-section animate-in">
                        <h4 style="display: flex; align-items: center; gap: 10px;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2d6cdf" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                            </svg>
                            Заводской брак
                        </h4>
                        <div class="info-card" style="margin-bottom: 16px;">
                            <p style="margin: 0 0 12px 0; font-weight: 600; color: #111827;">Гарантия на всю технику — 1 год с момента приобретения товара, от магазина. Гарантия на аксессуары, не содержащие электронные элементы — 14 дней с момента приобретения товара, от магазина.</p>
                            <p style="margin: 0 0 12px 0;">Гарантия распространяется на заводской брак. Причину возникновения дефектов оборудования, а также их характер определяют специалисты собственного гарантийного обслуживания в ходе диагностики; срок проведения диагностики — до 21 дня. При несогласии покупателя с заключением может быть произведена независимая экспертиза в соответствии с законом «О защите прав потребителей». В течение 14 дней с момента покупки покупатель имеет право на обмен товара на новый или возврат денежных средств, но только в том случае, если по результатам диагностики было подтверждено наличие заводского брака.</p>
                            <p style="margin: 0;">По истечении 14 дней с момента покупки неисправное оборудование с заводским браком принимается в гарантийный ремонт, срок проведения ремонта — не более 45 дней. Доставка оборудования на диагностику и гарантийный ремонт осуществляется в офис продавца силами покупателя. Если вы находитесь в другом городе, вам необходимо отправить товар к нам курьерской службой CDEK (доставка до двери или до пункта выдачи). Доставка курьерскими службами не является услугой, связанной с заказом. Она не считается частью приобретаемого товара и заканчивается в момент получения товара. С момента передачи товара в курьерскую службу ответственность за сохранность товара также передается курьерской службе.</p>
                        </div>
                    </div>
                    <div class="about-section">
                        <h4 style="display: flex; align-items: center; gap: 10px;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2d6cdf" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                <line x1="12" y1="9" x2="12" y2="13"></line>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                            На что не распространяется гарантия?
                        </h4>
                        <div class="info-card">
                            <ul class="about-list" style="margin: 0;">
                                <li>со следами любого рода вмешательств (попыток вскрытия/разбора/ремонта и т. п.);</li>
                                <li>со следами попадания внутрь посторонних веществ/предметов/жидкостей и т. п.;</li>
                                <li>с механическими/тепловыми повреждениями;</li>
                                <li>с неисправностями, возникшими вследствие появившихся в ходе эксплуатации устройства загрязнений;</li>
                                <li>с повреждениями, вызванными неправильными подключением, эксплуатацией в нештатном режиме, либо в условиях, не предусмотренных производителем, а также произошедшими вследствие действия сторонних обстоятельств (скачков напряжения электропитания, стихийных бедствий и т. д.);</li>
                                <li>с неисправностями, возникшими вследствие внесения покупателем в устройство конструкционных, программных и иных изменений;</li>
                                <li>с «выпадением» точек ЖК-дисплея («битыми пикселями») количеством не более 4-х.</li>
                            </ul>
                        </div>
                    </div>
                    <div class="about-section animate-in">
                        <h4 style="display: flex; align-items: center; gap: 10px;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2d6cdf" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            Какие правила сдачи и приёма устройств на диагностику или ремонт?
                        </h4>
                        <div class="info-card">
                            <p style="margin: 0 0 16px 0; color: #4b5563;">Пожалуйста, выполните перечисленные ниже действия. Если устройство не включается или не реагирует на команды, постарайтесь выполнить как можно больше из этих действий. По гиперссылкам есть все необходимые инструкции.</p>
                            <ul class="about-list" style="margin: 0 0 16px 0;">
                                <li>сохраните ваши данные* с устройства перед сдачей в ремонт, например, создайте резервную копию: <a href="https://support.apple.com/ru-ru/HT203977" target="_blank" style="color: #2d6cdf; text-decoration: none; font-weight: 600;">iPhone</a>, <a href="https://support.apple.com/ru-ru/HT203977" target="_blank" style="color: #2d6cdf; text-decoration: none; font-weight: 600;">iPad</a>, <a href="https://support.apple.com/ru-ru/HT201250" target="_blank" style="color: #2d6cdf; text-decoration: none; font-weight: 600;">Mac</a>, <a href="https://support.apple.com/ru-ru/HT205000" target="_blank" style="color: #2d6cdf; text-decoration: none; font-weight: 600;">Watch</a>.</li>
                                <li>отключите функцию локатор на устройстве, для этого потребуется пароль Apple ID**.</li>
                                <li>извлеките SIM-карту из устройства с iOS или устройства с iPadOS, если она есть, и храните её в надёжном месте.</li>
                                <li>снимите с устройства все аксессуары, чехлы, держатели, зарядки, провода, дополнительные накопители и прочее, если они не требуются для диагностики неисправности.</li>
                            </ul>
                            <p style="margin: 0 0 8px 0; color: #4b5563; font-weight: 600;">*магазин и/или авторизованный сервисный центр не несут ответственность, если в ходе диагностики и ремонта данные, находящиеся на устройстве, будут утеряны.</p>
                            <p style="margin: 0 0 16px 0; color: #4b5563;">**если не удается отключить функцию Find My, магазин и/или компания Apple в лице авторизованного сервисного центра не смогут выполнить обслуживание устройства. Это правило установлено для того, чтобы не допустить сторонних лиц к обслуживанию устройства без вашего разрешения. Если вы забыли свой идентификатор Apple ID и пароль, перейдите на веб-сайт <a href="https://iforgot.apple.com" target="_blank" style="color: #2d6cdf; text-decoration: none; font-weight: 600;">iForgot</a>.</p>
                            <p style="margin: 0; font-weight: 600; color: #111827; text-align: center; padding-top: 16px; border-top: 1px solid #e5e7eb;">Совершение покупки означает согласие покупателя с настоящими правилами.</p>
                        </div>
                    </div>
                </div>
            `;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Load delivery page
        function loadDeliveryPage() {
            currentView = 'delivery';
            pushHistoryState('delivery', {});
            saveAppState();
            const content = document.getElementById('content');
            content.innerHTML = `
                <button class="back-button" onclick="goToHomePage()">← Назад на главную</button>
                <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
                    <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 30px; text-align: center; color: #111827; display: flex; align-items: center; justify-content: center; gap: 12px;">
                        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#2d6cdf" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                            <path d="M1 3h15v13H1zM16 8h4l3 3v5h-7V8z"></path>
                            <path d="M5 8h10"></path>
                        </svg>
                        Доставка и оплата
                    </h1>
                    <div class="about-section animate-in">
                        <h4 style="text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            С нами надежно
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px;">
                            <div class="info-card">
                                <h5>
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                        <circle cx="12" cy="10" r="3"></circle>
                                    </svg>
                                    Самовывоз
                                </h5>
                                <p>Вы можете забрать свой заказ в нашем магазине с 10:00 до 21:00 ежедневно. Услуга действует при оформлении заказа с 10:00 до 20:00.</p>
                            </div>
                            <div class="info-card">
                                <h5>
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M1 3h15v13H1zM16 8h4l3 3v5h-7V8z"></path>
                                        <path d="M5 8h10"></path>
                                    </svg>
                                    Доставка по Москве
                                </h5>
                                <p>Доставка заказа в день обращения собственными сотрудниками компании. Обычно все заказы доставляются за 1-2 часа после оформления. Бесплатная доставка от 30 тыс. р., в других случаях — 500 р. За МКАД — рассчитывается индивидуально.</p>
                            </div>
                            <div class="info-card">
                                <h5>
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                                        <line x1="12" y1="22.08" x2="12" y2="12"></line>
                                    </svg>
                                    Доставка по России
                                </h5>
                                <p>Экспресс-доставка по России курьерской службой СДЭК. Бережная упаковка и возможность отслеживать заказ. Отправляем заказы при полной оплате. Стоимость доставки — от 500 р.</p>
                            </div>
                        </div>
                    </div>
                    <div class="about-section">
                        <h4 style="text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            Варианты оплаты
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 16px;">
                            <div class="info-card">
                                <h5>
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                                        <line x1="12" y1="1" x2="12" y2="23"></line>
                                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                    </svg>
                                    Наличный расчёт
                                </h5>
                                <p>На данный момент оплатить заказ как при самовывозе, так и при доставке по Москве и области можно только наличными. Рядом с нами есть много банкоматов (СБЕР, Альфа-Банк, Тинькофф, ВТБ, Русский Стандарт).</p>
                            </div>
                            <div class="info-card">
                                <h5>
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                                        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                                        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                                    </svg>
                                    Банковский перевод
                                </h5>
                                <p>Для клиентов из других регионов оплата возможна банковским переводом. Мы принимаем полную оплату до отправки заказа.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Load categories with brands inside
        async function loadCategories() {
            try {
                console.log('Starting loadCategories...');
                showLoading();
                
                // Сбрасываем все фильтры и сохраняем состояние главной страницы
                currentCategoryId = null;
                currentCategoryName = null;
                currentBrandFilter = null;
                currentLevel0Filter = null;
                currentLevel1Filter = null;
                currentLevel2Filter = null;
                currentProductId = null;
                
                currentView = 'categories';
                pushHistoryState('categories', {
                    categoryId: null,
                    categoryName: null,
                    brandFilter: null,
                    level0Filter: null
                });
                saveAppState();
                
                // Получаем категории
                const categoriesResponse = await fetch(`${API_BASE}/categories`);
                if (!categoriesResponse.ok) {
                    throw new Error(`HTTP ${categoriesResponse.status}: ${categoriesResponse.statusText}`);
                }
                const categories = await categoriesResponse.json();
                
                const content = document.getElementById('content');
                let categoriesHtml = `
                    <div class="promo-carousel-wrapper">
                        <div class="promo-banners-container" id="promoCarousel">
                            <div class="promo-banner promo-banner-iphone17" onclick="loadProductsWithFilters('Apple', 'Смартфоны', '17 Series', null);">
                                <div class="promo-banner-content">
                                    <div class="promo-text">
                                        <div class="promo-badge">Новинка</div>
                                        <div class="promo-title">iPhone 17 Pro</div>
                                        <div class="promo-subtitle">Новейший iPhone с максимальными возможностями</div>
                                    </div>
                                    <div class="promo-image">
                                        <video muted playsinline class="promo-video" preload="metadata">
                                            <source src="https://www.apple.com/105/media/us/iphone-17-pro/2025/704d4474-8e63-4ce7-9917-bb47b1ca4ba0/anim/highlights-design/large_2x.mp4" type="video/mp4">
                                        </video>
                                    </div>
                                </div>
                            </div>
                            <div class="promo-banner promo-banner-2" onclick="loadProductsWithFilters('Apple', 'Наушники', null, 'AirPods Pro 3');">
                                <div class="promo-banner-content">
                                    <div class="promo-text">
                                        <div class="promo-badge">Новинка</div>
                                        <div class="promo-title">AirPods Pro 3</div>
                                        <div class="promo-subtitle">Превосходное качество звука и комфорт</div>
                                    </div>
                                    <div class="promo-image">
                                        <video muted playsinline class="promo-video" preload="metadata">
                                            <source src="https://www.apple.com/105/media/us/airpods/2025/515ae144-8530-47d0-85d1-22a263f4b237/anim/hero/large_2x.mp4" type="video/mp4">
                                        </video>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="promo-carousel-indicators" id="promoCarouselIndicators"></div>
                    </div>
                    <div class="categories">
                `;
                
                for (const category of categories) {
                    console.log(`Processing category: ${category.name}`);
                    
                    // Получаем бренды для этой категории - уже отфильтрованные по категории
                    const categoryBrandsResponse = await fetch(`${API_BASE}/hierarchy/brands?level0=${encodeURIComponent(category.level_0)}`);
                    const categoryBrands = await categoryBrandsResponse.json();
                    
                    // Для каждого бренда получаем количество товаров в этой категории
                    const brandData = [];
                    for (const brand of categoryBrands) {
                        try {
                            const countResponse = await fetch(`${API_BASE}/products?brand=${encodeURIComponent(brand)}&level0=${encodeURIComponent(category.level_0)}&limit=1`);
                            const products = await countResponse.json();
                            if (products && products.length > 0) {
                                // Получаем точное количество товаров
                                const fullCountResponse = await fetch(`${API_BASE}/products?brand=${encodeURIComponent(brand)}&level0=${encodeURIComponent(category.level_0)}&limit=1000`);
                                const allProducts = await fullCountResponse.json();
                                
                                brandData.push({
                                    brand: brand,
                                    icon: brand === 'Apple' ? '🍎' : (brand === 'Samsung' ? '📱' : '📦'),
                                    product_count: allProducts.length
                                });
                            }
                        } catch (error) {
                            console.warn(`Ошибка получения товаров для бренда ${brand}:`, error);
                        }
                    }
                    
                    categoriesHtml += `
                        <div class="category-card" id="category-${category.id}">
                            <div class="category-header" onclick="toggleCategoryBrands(${category.id})">
                                <div class="category-icon">${renderCategoryIcon(category.name, category.icon)}</div>
                                <div class="category-name">${category.name}</div>
                                <div class="category-count">${category.product_count} товаров</div>
                            </div>
                    `;
                    
                    // Добавляем бренды как кнопки внутри категории
                    if (brandData.length > 0) {
                        categoriesHtml += '<div class="brands-container">';
                        for (const brand of brandData) {
                            categoriesHtml += `
                                <div class="brand-button" onclick="event.stopPropagation(); loadProductsByBrand('${brand.brand}', '${category.level_0}')">
                                    ${renderBrandIcon(brand.brand)}
                                </div>
                            `;
                        }
                        categoriesHtml += '</div>';
                    }
                    categoriesHtml += '</div>';
                }
                categoriesHtml += '</div>';
                
                content.innerHTML = categoriesHtml;
                console.log('Categories HTML generated and displayed');
                
                // Инициализируем карусель промо-блоков
                initPromoCarousel();
                
                // Инициализируем видео с паузой между циклами
                initPromoVideos();
                
                // Добавляем плавную анимацию появления для категорий
                setTimeout(() => {
                    const categoryCards = document.querySelectorAll('.category-card');
                    categoryCards.forEach((card, index) => {
                        setTimeout(() => {
                            card.classList.add('animate-in');
                        }, index * 80); // Задержка 80ms между каждой карточкой
                    });
                    console.log('Categories initialization complete');
                }, 100);
                
            } catch (error) {
                console.error('Error loading categories:', error);
                showError('Ошибка загрузки категорий: ' + error.message);
            }
        }
        
        // Toggle category brands visibility
        function toggleCategoryBrands(categoryId) {
            const categoryCard = document.getElementById(`category-${categoryId}`);
            if (categoryCard) {
                categoryCard.classList.toggle('expanded');
            }
        }
        
        // Инициализация карусели промо-блоков
        function initPromoCarousel() {
            const carousel = document.getElementById('promoCarousel');
            const indicatorsContainer = document.getElementById('promoCarouselIndicators');
            
            if (!carousel || !indicatorsContainer) return;
            
            const banners = carousel.querySelectorAll('.promo-banner');
            if (banners.length <= 1) return; // Не нужна карусель, если только один блок
            
            // Создаем индикаторы
            indicatorsContainer.innerHTML = '';
            banners.forEach((_, index) => {
                const indicator = document.createElement('button');
                indicator.className = 'promo-carousel-indicator';
                if (index === 0) indicator.classList.add('active');
                indicator.setAttribute('aria-label', `Перейти к слайду ${index + 1}`);
                indicator.addEventListener('click', () => goToSlide(index));
                indicatorsContainer.appendChild(indicator);
            });
            
            let currentIndex = 0;
            let autoScrollInterval = null;
            let isPaused = false;
            let isUserInteracting = false;
            
            // Функция перехода к слайду
            function goToSlide(index) {
                if (index < 0 || index >= banners.length) return;
                
                const banner = banners[index];
                if (!banner) return;
                
                currentIndex = index;
                const scrollLeft = banner.offsetLeft - carousel.offsetLeft;
                carousel.scrollTo({
                    left: scrollLeft,
                    behavior: 'smooth'
                });
                
                // Обновляем индикаторы
                const indicators = indicatorsContainer.querySelectorAll('.promo-carousel-indicator');
                indicators.forEach((ind, i) => {
                    if (i === index) {
                        ind.classList.add('active');
                    } else {
                        ind.classList.remove('active');
                    }
                });
            }
            
            // Функция автопрокрутки
            function startAutoScroll() {
                if (autoScrollInterval) clearInterval(autoScrollInterval);
                if (isPaused || isUserInteracting) return;
                
                autoScrollInterval = setInterval(() => {
                    if (isPaused || isUserInteracting) return;
                    
                    currentIndex = (currentIndex + 1) % banners.length;
                    goToSlide(currentIndex);
                }, 4000); // Автопрокрутка каждые 4 секунды
            }
            
            // Остановка автопрокрутки
            function stopAutoScroll() {
                if (autoScrollInterval) {
                    clearInterval(autoScrollInterval);
                    autoScrollInterval = null;
                }
            }
            
            // Пауза автопрокрутки
            function pauseAutoScroll() {
                isPaused = true;
                stopAutoScroll();
            }
            
            // Возобновление автопрокрутки
            function resumeAutoScroll() {
                isPaused = false;
                if (!isUserInteracting) {
                    startAutoScroll();
                }
            }
            
            // Обработка прокрутки для обновления индикаторов
            let scrollTimeout;
            
            carousel.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    const scrollLeft = carousel.scrollLeft;
                    
                    // Находим ближайший баннер
                    let closestIndex = 0;
                    let closestDistance = Infinity;
                    
                    banners.forEach((banner, index) => {
                        const distance = Math.abs(banner.offsetLeft - scrollLeft - carousel.offsetLeft);
                        if (distance < closestDistance) {
                            closestDistance = distance;
                            closestIndex = index;
                        }
                    });
                    
                    currentIndex = closestIndex;
                    
                    const indicators = indicatorsContainer.querySelectorAll('.promo-carousel-indicator');
                    indicators.forEach((ind, i) => {
                        if (i === closestIndex) {
                            ind.classList.add('active');
                        } else {
                            ind.classList.remove('active');
                        }
                    });
                }, 100);
            });
            
            // Остановка при взаимодействии пользователя
            carousel.addEventListener('mouseenter', () => {
                isUserInteracting = true;
                pauseAutoScroll();
            });
            
            carousel.addEventListener('mouseleave', () => {
                isUserInteracting = false;
                resumeAutoScroll();
            });
            
            // Поддержка свайпов на мобильных устройствах
            let touchStartX = 0;
            let touchEndX = 0;
            let touchEndTimeout = null;
            
            carousel.addEventListener('touchstart', (e) => {
                isUserInteracting = true;
                pauseAutoScroll();
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });
            
            carousel.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
                
                // Возобновляем через 3 секунды после окончания взаимодействия
                if (touchEndTimeout) clearTimeout(touchEndTimeout);
                touchEndTimeout = setTimeout(() => {
                    isUserInteracting = false;
                    resumeAutoScroll();
                }, 3000);
            }, { passive: true });
            
            function handleSwipe() {
                const swipeThreshold = 50;
                const diff = touchStartX - touchEndX;
                
                if (Math.abs(diff) > swipeThreshold) {
                    let newIndex;
                    
                    if (diff > 0) {
                        // Свайп влево - следующий слайд
                        newIndex = Math.min(currentIndex + 1, banners.length - 1);
                    } else {
                        // Свайп вправо - предыдущий слайд
                        newIndex = Math.max(currentIndex - 1, 0);
                    }
                    
                    goToSlide(newIndex);
                }
            }
            
            // Запускаем автопрокрутку
            startAutoScroll();
        }
        
        // Инициализация видео с паузой между циклами
        function initPromoVideos() {
            const promoVideos = document.querySelectorAll('.promo-video');
            
            // Проверка на мобильное устройство
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || 
                            (window.matchMedia && window.matchMedia('(max-width: 768px)').matches);
            
            // Функция для запуска видео
            function playVideo(video, force = false) {
                if (video.paused || force) {
                    video.muted = true;
                    video.playsInline = true;
                    const playPromise = video.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            // Игнорируем ошибки автовоспроизведения
                        });
                    }
                }
            }
            
            if (isMobile) {
                // Логика для мобильных устройств: первый кадр до касания
                let userInteracted = false;
                
                // Обработчик первого взаимодействия пользователя
                function handleFirstInteraction() {
                    if (!userInteracted) {
                        userInteracted = true;
                        promoVideos.forEach(video => {
                            // Убеждаемся, что видео настроено
                            video.muted = true;
                            video.playsInline = true;
                            // Запускаем воспроизведение
                            playVideo(video, true);
                        });
                    }
                }
                
                // Добавляем обработчики для первого взаимодействия
                document.addEventListener('touchstart', handleFirstInteraction, { once: true, passive: true });
                document.addEventListener('click', handleFirstInteraction, { once: true });
                document.addEventListener('scroll', handleFirstInteraction, { once: true, passive: true });
                
                promoVideos.forEach(video => {
                    // Настройка видео
                    video.muted = true;
                    video.playsInline = true;
                    video.setAttribute('playsinline', '');
                    video.setAttribute('webkit-playsinline', '');
                    
                    // Устанавливаем первый кадр (currentTime = 0) после загрузки метаданных
                    video.addEventListener('loadedmetadata', function() {
                        video.currentTime = 0;
                        // Приостанавливаем видео, чтобы показать первый кадр
                        video.pause();
                    });
                    
                    // Загружаем первый кадр
                    video.load();
                    
                    // Обработка окончания видео с паузой 3 секунды
                    video.addEventListener('ended', function() {
                        // Пауза 3 секунды перед повторным воспроизведением
                        setTimeout(() => {
                            if (userInteracted) {
                                video.currentTime = 0;
                                playVideo(video, true);
                            }
                        }, 3000);
                    });
                    
                    // Обработка клика на промо-блок для запуска видео
                    const promoBanner = video.closest('.promo-banner');
                    if (promoBanner) {
                        promoBanner.addEventListener('touchstart', function() {
                            handleFirstInteraction();
                        }, { once: true, passive: true });
                        
                        promoBanner.addEventListener('click', function() {
                            handleFirstInteraction();
                        }, { once: true });
                    }
                });
            } else {
                // Логика для десктопа: автовоспроизведение
                promoVideos.forEach(video => {
                    // Настройка видео
                    video.muted = true;
                    video.playsInline = true;
                    video.setAttribute('playsinline', '');
                    video.setAttribute('webkit-playsinline', '');
                    video.setAttribute('autoplay', '');
                    
                    // Автоматический запуск
                    playVideo(video, true);
                    
                    // Обработка окончания видео с паузой 3 секунды
                    video.addEventListener('ended', function() {
                        // Пауза 3 секунды перед повторным воспроизведением
                        setTimeout(() => {
                            video.currentTime = 0;
                            playVideo(video, true);
                        }, 3000);
                    });
                    
                    // Обработка различных событий загрузки для гарантированного запуска
                    video.addEventListener('loadeddata', function() {
                        playVideo(video, true);
                    });
                    
                    video.addEventListener('canplay', function() {
                        playVideo(video, true);
                    });
                });
            }
        }
        
        // Load subcategories for category
        async function loadSubcategories(categoryId) {
            try {
                showLoading();
                
                // Получаем категорию
                const categoriesResponse = await fetch(`${API_BASE}/categories`);
                const categories = await categoriesResponse.json();
                const category = categories.find(cat => cat.id === categoryId);
                
                if (!category) {
                    showError('Категория не найдена');
                    return;
                }
                
                // Получаем бренды для этой категории (level_0) - уже отфильтрованные по категории
                const brandsResponse = await fetch(`${API_BASE}/hierarchy/brands?level0=${encodeURIComponent(category.level_0)}`);
                const allBrands = await brandsResponse.json();
                
                // Для каждого бренда получаем количество товаров в этой категории
                const brandData = [];
                for (const brand of allBrands) {
                    try {
                        const countResponse = await fetch(`${API_BASE}/products?brand=${encodeURIComponent(brand)}&level0=${encodeURIComponent(category.level_0)}&limit=1`);
                        const products = await countResponse.json();
                        if (products && products.length > 0) {
                            // Получаем точное количество товаров
                            const fullCountResponse = await fetch(`${API_BASE}/products?brand=${encodeURIComponent(brand)}&level0=${encodeURIComponent(category.level_0)}&limit=1000`);
                            const allProducts = await fullCountResponse.json();
                            
                            brandData.push({
                                brand: brand,
                                icon: brand === 'Apple' ? '🍎' : (brand === 'Samsung' ? '📱' : '📦'),
                                product_count: allProducts.length
                            });
                        }
                    } catch (e) {
                        console.error(`Error checking brand ${brand}:`, e);
                    }
                }
                
                if (brandData.length === 0) {
                    showError('Бренды не найдены');
                    return;
                }
                
                currentView = 'subcategories';
                currentCategoryId = categoryId;
                
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="subcategories-grid">
                        ${brandData.map(subcat => `
                            <div class="subcategory-card" onclick="loadProductsByBrandWithCategory('${subcat.brand}', ${categoryId}, '${category.name}')">
                                <div class="subcategory-name" style="display: flex; align-items: center; justify-content: center;">
                                    ${renderBrandIcon(subcat.brand)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                // Добавляем плавную анимацию появления для подкатегорий
                setTimeout(() => {
                    const subcategoryCards = document.querySelectorAll('.subcategory-card');
                    subcategoryCards.forEach((card, index) => {
                        setTimeout(() => {
                            card.classList.add('animate-in');
                        }, index * 60);
                    });
                }, 100);
            } catch (error) {
                console.error('Error loading subcategories:', error);
                showError('Ошибка загрузки подкатегорий');
            }
        }
        
        // Load products for category (all products in category and subcategories)
        async function loadProducts(categoryId) {
            try {
                showLoading();
                
                // Сохраняем состояние
                currentCategoryId = categoryId;
                currentBrandFilter = null;
                currentLevel0Filter = null;
                currentLevel1Filter = null;
                currentLevel2Filter = null;
                currentProductId = null;
                
                currentView = 'products';
                pushHistoryState('products', {
                    categoryId: categoryId,
                    brandFilter: null,
                    level0Filter: null
                });
                saveAppState();
                
                const response = await fetch(`${API_BASE}/products?category_id=${categoryId}&limit=20`);
                const products = await response.json();
                
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="products-grid">
                        ${products.map(product => {
                            storeProductImages(product);
                            return createProductCard(product);
                        }).join('')}
                    </div>
                `;
                
                // Добавляем плавную анимацию появления для товаров
                setTimeout(() => {
                    const productCards = document.querySelectorAll('.product-card');
                    productCards.forEach((card, index) => {
                        setTimeout(() => {
                            card.classList.add('animate-in');
                        }, index * 50);
                    });
                }, 100);
                
                // Инициализировать цвета по умолчанию после рендеринга
                setTimeout(async () => {
                    await initializeDefaultColors();
                    await loadDefaultImages();
                }, 100);
            } catch (error) {
                showError('Ошибка загрузки товаров');
            }
        }
        
        // Get welcome text for category-brand combination
        function getCategoryBrandWelcome(categoryLevel0, brand) {
            const welcomeTexts = {
                'Смартфоны': {
                    'Apple': {
                        title: 'iPhone',
                        subtitle: 'Изысканные технологии в каждой детали.'
                    },
                    'Samsung': {
                        title: 'Galaxy',
                        subtitle: 'Инновации, которые меняют мир.'
                    },
                    'Xiaomi': {
                        title: 'Xiaomi',
                        subtitle: 'Высокое качество по доступной цене.'
                    }
                },
                'Ноутбуки': {
                    'Apple': {
                        title: 'MacBook',
                        subtitle: 'Мощность и элегантность в одном устройстве.'
                    },
                    'Samsung': {
                        title: 'Galaxy Book',
                        subtitle: 'Производительность для работы и творчества.'
                    }
                },
                'Планшеты': {
                    'Apple': {
                        title: 'iPad',
                        subtitle: 'Творчество и продуктивность в ваших руках.'
                    }
                },
                'Наушники': {
                    'Apple': {
                        title: 'AirPods',
                        subtitle: 'Звук нового поколения.'
                    },
                    'Sony': {
                        title: 'Sony',
                        subtitle: 'Превосходное качество звука.'
                    }
                }
            };
            
            const category = welcomeTexts[categoryLevel0];
            if (category && category[brand]) {
                return category[brand];
            }
            
            // Default welcome text if not found
            return {
                title: brand,
                subtitle: 'Качественная техника для вашего комфорта.'
            };
        }
        
        // Load products by brand with hierarchical filters
        async function loadProductsByBrand(brand, categoryLevel0) {
            try {
                showLoading();
                
                // Сохраняем текущий фильтр бренда и категории
                currentBrandFilter = brand;
                currentLevel0Filter = categoryLevel0; // Устанавливаем категорию из параметра
                currentLevel1Filter = null;
                currentLevel2Filter = null;
                currentProductId = null; // Сбрасываем товар при переходе к списку
                
                currentView = 'brand_products';
                pushHistoryState('brand_products', {
                    brandFilter: brand,
                    level0Filter: categoryLevel0,
                    categoryId: null
                });
                saveAppState();
                
                // Получаем товары с учетом уровня категории (level0)
                let url = `${API_BASE}/products?brand=${encodeURIComponent(brand)}&level0=${encodeURIComponent(categoryLevel0)}&limit=50`;
                console.log(`🔗 Запрашиваем товары бренда ${brand} в категории ${categoryLevel0}: ${url}`);
                
                const response = await fetch(url);
                const products = await response.json();
                console.log(`📦 Получено товаров: ${products.length}`);
                if (products.length > 0) {
                    console.log(`📋 Первый товар: ${products[0].name} (level0: ${products[0].level0})`);
                }
                
                const welcome = getCategoryBrandWelcome(categoryLevel0, brand);
                
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="breadcrumbs" id="breadcrumbsContainer">
                        ${createBreadcrumbs(brand)}
                    </div>
                    <div class="category-welcome">
                        <h2 class="category-welcome-title">${welcome.title}</h2>
                        <div class="category-welcome-subtitle">${welcome.subtitle}</div>
                    </div>
                    <div class="hierarchy-filters" id="hierarchyFilters">
                        <!-- Фильтры будут добавлены динамически -->
                    </div>
                    <div class="products-grid">
                        ${products.map(product => {
                            storeProductImages(product);
                            return createProductCard(product);
                        }).join('')}
                    </div>
                `;
                
                // Добавляем плавную анимацию появления для товаров
                setTimeout(() => {
                    const productCards = document.querySelectorAll('.product-card');
                    productCards.forEach((card, index) => {
                        setTimeout(() => {
                            card.classList.add('animate-in');
                        }, index * 50);
                    });
                }, 100);
                
                // Создаем кнопки фильтрации level1
                await createHierarchyFilters(brand, products);
                
                // Инициализировать цвета по умолчанию после рендеринга
                setTimeout(async () => {
                    await initializeDefaultColors();
                    await loadDefaultImages();
                    await loadAllSpecifications();
                    // Инициализируем поддержку свайпов для новых каруселей
                    initializeSwipeSupport();
                }, 100);
            } catch (error) {
                showError('Ошибка загрузки товаров бренда');
            }
        }
        
        // Search products
        async function searchProducts(query) {
            try {
                showLoading();
                const response = await fetch(`${API_BASE}/search?q=${encodeURIComponent(query)}&limit=20`);
                const products = await response.json();
                
                currentView = 'search';
                currentCategoryId = null;
                
                const content = document.getElementById('content');
                if (products.length === 0) {
                    content.innerHTML = `
                        <div class="no-products">
                            По запросу "${query}" ничего не найдено
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="products-grid">
                            ${products.map(product => {
                                storeProductImages(product);
                                return createProductCard(product);
                            }).join('')}
                        </div>
                    `;
                    
                    // Добавляем плавную анимацию появления для товаров
                    setTimeout(() => {
                        const productCards = document.querySelectorAll('.product-card');
                        productCards.forEach((card, index) => {
                            setTimeout(() => {
                                card.classList.add('animate-in');
                            }, index * 50);
                        });
                    }, 100);
                    
                    // Инициализировать цвета по умолчанию после рендеринга
                    setTimeout(async () => {
                        await initializeDefaultColors();
                        await loadDefaultImages();
                        // Инициализируем поддержку свайпов для новых каруселей
                        initializeSwipeSupport();
                    }, 100);
                }
            } catch (error) {
                showError('Ошибка поиска');
            }
        }
        
        // Загрузка товаров бренда с учетом категории
        async function loadProductsByBrandWithCategory(brand, categoryId, categoryName) {
            console.log(`🎯 Загружаем товары бренда ${brand} в категории ${categoryName}`);
            // Устанавливаем level0Filter на основе названия категории
            currentLevel0Filter = categoryName;
            currentCategoryId = categoryId;
            currentCategoryName = categoryName;
            console.log(`📝 Установлены фильтры: level0=${currentLevel0Filter}, categoryId=${currentCategoryId}`);
            // Вызываем основную функцию
            await loadProductsByBrand(brand, categoryName);
        }
        
        // Создание фильтров иерархии
        async function createHierarchyFilters(brand, products) {
            try {
                console.log(`🏗️ Создаем фильтры для бренда ${brand}, currentLevel0Filter: ${currentLevel0Filter}`);
                
                const filtersContainer = document.getElementById('hierarchyFilters');
                if (!filtersContainer) return;
                
                // Если level0 еще не определен, определяем его из товаров (первая категория)
                if (!currentLevel0Filter && products.length > 0) {
                    const firstProductLevel0 = products[0].level0 || products[0].category_name.split(' / ')[0];
                    currentLevel0Filter = firstProductLevel0;
                    console.log(`🔍 Автоопределен level0 из товаров: ${currentLevel0Filter}`);
                }
                
                let filtersHtml = '<div class="hierarchy-filter-section"><div style="margin: 0 0 10px 0; display: flex; align-items: center; gap: 6px; color: #666;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg></div>';
                
                // Level1 фильтры (начинаем сразу с уровня 1, так как level0 уже выбран ранее)
                let level1Values = [];
                if (currentLevel0Filter) {
                    const level1Url = `${API_BASE}/hierarchy/levels?level=1&brand=${encodeURIComponent(brand)}&parent_level0=${encodeURIComponent(currentLevel0Filter)}`;
                    console.log(`🔗 Запрашиваем level1 для ${brand} в ${currentLevel0Filter}: ${level1Url}`);
                    
                    const level1Response = await fetch(level1Url);
                    level1Values = await level1Response.json();
                    // Сортировка по возрастанию
                    level1Values.sort((a, b) => String(a).localeCompare(String(b), undefined, { numeric: true, sensitivity: 'base' }));
                    console.log(`📋 Получены level1 значения:`, level1Values);
                }
                
                if (level1Values.length > 0) {
                    filtersHtml += `
                        <div class="filter-group">
                            <div class="filter-buttons">
                                ${level1Values.map(level1 => 
                                    `<button class="filter-btn ${currentLevel1Filter === level1 ? 'active' : ''}" 
                                             onclick="applyLevelFilter('level1', '${level1}')">
                                        ${level1}
                                    </button>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // Level2 фильтры (показываем только если выбран level1)
                if (currentLevel1Filter) {
                    const level2Response = await fetch(`${API_BASE}/hierarchy/levels?level=2&brand=${encodeURIComponent(brand)}&parent_level1=${encodeURIComponent(currentLevel1Filter)}`);
                    const level2Values = await level2Response.json();
                    // Сортировка по возрастанию
                    if (level2Values.length > 0) {
                        level2Values.sort((a, b) => String(a).localeCompare(String(b), undefined, { numeric: true, sensitivity: 'base' }));
                    }
                    
                    if (level2Values.length > 0) {
                        filtersHtml += `
                            <div class="filter-group">
                                <div class="filter-buttons">
                                    ${level2Values.map(level2 => 
                                        `<button class="filter-btn ${currentLevel2Filter === level2 ? 'active' : ''}" 
                                                 onclick="applyLevelFilter('level2', '${level2}')">
                                            ${level2}
                                        </button>`
                                    ).join('')}
                                </div>
                            </div>
                        `;
                    }
                }
                
                filtersHtml += '</div>';
                
                // Кнопка сброса фильтров
                if (currentLevel1Filter || currentLevel2Filter) {
                    filtersHtml += `
                        <div class="filter-reset">
                            <button class="reset-btn" onclick="resetFilters()" aria-label="Сбросить фильтры">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                    `;
                }
                
                filtersContainer.innerHTML = filtersHtml;
                
            } catch (error) {
                console.error('Ошибка создания фильтров:', error);
            }
        }
        
        // Load products with hierarchical filters (brand, level0, level1, level2)
        async function loadProductsWithFilters(brand, level0, level1, level2) {
            try {
                showLoading();
                
                // Сохраняем текущие фильтры
                currentBrandFilter = brand;
                currentLevel0Filter = level0;
                currentLevel1Filter = level1 || null;
                currentLevel2Filter = level2 || null;
                currentProductId = null;
                
                // Сохраняем состояние
                saveAppState();
                
                // Получаем товары с учетом всех фильтров
                const params = new URLSearchParams();
                params.append('brand', brand);
                params.append('level0', level0);
                if (level1) params.append('level1', level1);
                if (level2) params.append('level2', level2);
                params.append('limit', '50');
                
                const url = `${API_BASE}/products?${params.toString()}`;
                console.log(`🔗 Запрашиваем товары с фильтрами: ${url}`);
                
                const response = await fetch(url);
                let products = await response.json();
                console.log(`📦 Получено товаров: ${products.length}`);
                
                // Кастомная сортировка для 17 Series
                if (level1 === '17 Series') {
                    const sortOrder = [
                        'iPhone 17 Pro Max',
                        'iPhone 17 Pro',
                        'iPhone Air',
                        'iPhone 17'
                    ];
                    
                    products.sort((a, b) => {
                        const aName = a.name || a.level_2 || '';
                        const bName = b.name || b.level_2 || '';
                        
                        const aIndex = sortOrder.findIndex(order => aName.includes(order));
                        const bIndex = sortOrder.findIndex(order => bName.includes(order));
                        
                        // Если оба найдены в порядке сортировки
                        if (aIndex !== -1 && bIndex !== -1) {
                            return aIndex - bIndex;
                        }
                        // Если только один найден, он идет первым
                        if (aIndex !== -1) return -1;
                        if (bIndex !== -1) return 1;
                        // Если оба не найдены, сортируем по имени
                        return aName.localeCompare(bName);
                    });
                }
                
                currentView = 'brand_products';
                
                const welcome = getCategoryBrandWelcome(level0, brand);
                
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="breadcrumbs" id="breadcrumbsContainer">
                        ${createBreadcrumbs(brand)}
                    </div>
                    <div class="category-welcome">
                        <h2 class="category-welcome-title">${welcome.title}</h2>
                        <div class="category-welcome-subtitle">${welcome.subtitle}</div>
                    </div>
                    <div class="hierarchy-filters" id="hierarchyFilters">
                        <!-- Фильтры будут добавлены динамически -->
                    </div>
                    <div class="products-grid">
                        ${products.map(product => {
                            storeProductImages(product);
                            return createProductCard(product);
                        }).join('')}
                    </div>
                `;
                
                // Добавляем плавную анимацию появления для товаров
                setTimeout(() => {
                    const productCards = document.querySelectorAll('.product-card');
                    productCards.forEach((card, index) => {
                        setTimeout(() => {
                            card.classList.add('animate-in');
                        }, index * 50);
                    });
                }, 100);
                
                // Создаем кнопки фильтрации
                await createHierarchyFilters(brand, products);
                
                // Активируем кнопки фильтров после их создания
                setTimeout(() => {
                    // Активируем level1 фильтр
                    if (currentLevel1Filter) {
                        const allLevel1Btns = document.querySelectorAll('.filter-btn');
                        allLevel1Btns.forEach(btn => {
                            const onclick = btn.getAttribute('onclick') || '';
                            if (onclick.includes(`applyLevelFilter('level1', '${currentLevel1Filter}')`) || 
                                onclick.includes(`applyLevelFilter('level1', "${currentLevel1Filter}")`)) {
                                btn.classList.add('active');
                            }
                        });
                    }
                    // Активируем level2 фильтр
                    if (currentLevel2Filter) {
                        const allLevel2Btns = document.querySelectorAll('.filter-btn');
                        allLevel2Btns.forEach(btn => {
                            const onclick = btn.getAttribute('onclick') || '';
                            if (onclick.includes(`applyLevelFilter('level2', '${currentLevel2Filter}')`) || 
                                onclick.includes(`applyLevelFilter('level2', "${currentLevel2Filter}")`)) {
                                btn.classList.add('active');
                            }
                        });
                    }
                }, 300);
                
                // Инициализировать цвета по умолчанию после рендеринга
                setTimeout(async () => {
                    await initializeDefaultColors();
                    await loadDefaultImages();
                }, 100);
                
                // Обновляем хлебные крошки
                updateBreadcrumbs();
                
                hideLoading();
                
            } catch (error) {
                console.error('Ошибка загрузки товаров с фильтрами:', error);
                hideLoading();
            }
        }
        
        // Функция для открытия детальной страницы с учетом выбранных вариантов
        function openProductDetailWithVariants(productId, modelName) {
            const variants = getSelectedVariants(productId);
            loadProductDetailPage(modelName, variants);
        }
        
        // Загрузка детальной страницы продукта
        async function loadProductDetailPage(modelName, selectedVariants = {}) {
            try {
                showLoading();
                
                // Сохраняем состояние
                currentView = 'product_detail';
                currentProductId = null;
                currentProductModelName = modelName;
                saveAppState();
                
                // Добавляем в историю браузера
                pushHistoryState('product_detail', {
                    modelName: modelName
                });
                
                // Ищем продукт по модели
                const response = await fetch(`${API_BASE}/products?level2=${encodeURIComponent(modelName)}&limit=1`);
                const products = await response.json();
                
                if (!products || products.length === 0) {
                    console.error('Продукт не найден:', modelName);
                    hideLoading();
                    return;
                }
                
                const product = products[0];
                storeProductImages(product);
                
                // Загружаем варианты продукта
                const variantsResponse = await fetch(`${API_BASE}/products/${encodeURIComponent(modelName)}/variants`);
                const variantsData = await variantsResponse.ok ? await variantsResponse.json() : { variants: [] };
                
                // Загружаем детали уровня 2
                const details = await loadLevel2Details(modelName);
                
                // Отладочный вывод для проверки доступных полей
                if (product.level_0 === 'Смартфоны') {
                    console.log('Доступные поля в details для смартфона:', Object.keys(details));
                    console.log('Все details:', details);
                }
                
                // Вспомогательная функция для поиска поля по различным вариантам названий
                const findDetail = (variants) => {
                    for (const variant of variants) {
                        if (details[variant]) return details[variant];
                    }
                    // Поиск по частичному совпадению (без учета регистра)
                    const lowerVariants = variants.map(v => v.toLowerCase());
                    for (const key in details) {
                        const lowerKey = key.toLowerCase();
                        if (lowerVariants.some(v => lowerKey.includes(v) || v.includes(lowerKey))) {
                            return details[key];
                        }
                    }
                    return null;
                };
                
                // Получаем уникальные значения памяти и цвета
                // Функция для правильной сортировки памяти
                const sortMemory = (a, b) => {
                    const parseMemory = (mem) => {
                        if (!mem) return 0;
                        const memStr = mem.toString().toUpperCase().trim();
                        // Обработка TB
                        if (memStr.includes('TB')) {
                            const num = parseFloat(memStr);
                            return num * 1000; // 1TB = 1000, 2TB = 2000
                        }
                        // Обработка GB
                        if (memStr.includes('GB')) {
                            return parseFloat(memStr);
                        }
                        // Обработка ГБ (кириллица)
                        if (memStr.includes('ГБ')) {
                            return parseFloat(memStr);
                        }
                        // Если просто число, предполагаем GB
                        return parseFloat(memStr);
                    };
                    
                    return parseMemory(a) - parseMemory(b);
                };
                
                const memories = [...new Set(variantsData.variants.map(v => v.memory).filter(Boolean))].sort(sortMemory);
                const colors = [...new Set(variantsData.variants.map(v => v.color).filter(Boolean))];
                const sims = [...new Set(variantsData.variants.map(v => v.sim_type || v.sim).filter(Boolean))];
                const rams = [...new Set(variantsData.variants.map(v => v.ram).filter(Boolean))];
                const ssds = [...new Set(variantsData.variants.map(v => v.ssd || v.disk).filter(Boolean))];
                const screens = [...new Set(variantsData.variants.map(v => v.screen).filter(Boolean))];
                const capacities = [...new Set(variantsData.variants.map(v => v.capacity).filter(Boolean))];
                
                // Отладочный вывод для проверки вариантов
                console.log('Доступные варианты:', {
                    memories: memories.length,
                    colors: colors.length,
                    sims: sims.length,
                    rams: rams.length,
                    ssds: ssds.length,
                    screens: screens.length,
                    capacities: capacities.length,
                    firstVariant: variantsData.variants[0]
                });
                
                // Определяем выбранные варианты: используем переданные варианты или первый доступный
                let selectedMemory = selectedVariants.memory || '';
                let selectedColor = selectedVariants.color || '';
                let selectedSim = selectedVariants.sim || '';
                let selectedRam = selectedVariants.ram || '';
                let selectedSsd = selectedVariants.ssd || '';
                let selectedScreen = selectedVariants.screen || '';
                let selectedCapacity = selectedVariants.capacity || '';
                
                // Проверяем, что выбранные варианты доступны, иначе используем первый доступный
                if (selectedMemory && !memories.includes(selectedMemory)) {
                    selectedMemory = memories.length > 0 ? memories[0] : '';
                } else if (!selectedMemory) {
                    selectedMemory = memories.length > 0 ? memories[0] : '';
                }
                
                if (selectedColor && !colors.includes(selectedColor)) {
                    selectedColor = colors.length > 0 ? colors[0] : '';
                } else if (!selectedColor) {
                    selectedColor = colors.length > 0 ? colors[0] : '';
                }
                
                // Для SIM используем sim_type из первого варианта, если не передан
                if (!selectedSim && variantsData.variants.length > 0) {
                    selectedSim = variantsData.variants[0].sim_type || variantsData.variants[0].sim || '';
                }
                if (selectedSim && !sims.includes(selectedSim)) {
                    selectedSim = sims.length > 0 ? sims[0] : '';
                } else if (!selectedSim) {
                    selectedSim = sims.length > 0 ? sims[0] : '';
                }
                
                if (selectedRam && !rams.includes(selectedRam)) {
                    selectedRam = rams.length > 0 ? rams[0] : '';
                } else if (!selectedRam) {
                    selectedRam = rams.length > 0 ? rams[0] : '';
                }
                
                if (selectedSsd && !ssds.includes(selectedSsd)) {
                    selectedSsd = ssds.length > 0 ? ssds[0] : '';
                } else if (!selectedSsd) {
                    selectedSsd = ssds.length > 0 ? ssds[0] : '';
                }
                
                if (selectedScreen && !screens.includes(selectedScreen)) {
                    selectedScreen = screens.length > 0 ? screens[0] : '';
                } else if (!selectedScreen) {
                    selectedScreen = screens.length > 0 ? screens[0] : '';
                }
                
                if (selectedCapacity && !capacities.includes(selectedCapacity)) {
                    selectedCapacity = capacities.length > 0 ? capacities[0] : '';
                } else if (!selectedCapacity) {
                    selectedCapacity = capacities.length > 0 ? capacities[0] : '';
                }
                
                // Находим вариант с выбранными параметрами для получения цены
                const matchingVariant = variantsData.variants.find(v => 
                    v.memory === selectedMemory && 
                    v.color === selectedColor &&
                    (!selectedSim || v.sim === selectedSim) &&
                    (!selectedRam || v.ram === selectedRam) &&
                    (!selectedSsd || v.ssd === selectedSsd) &&
                    (!selectedScreen || v.screen === selectedScreen) &&
                    (!selectedCapacity || v.capacity === selectedCapacity)
                ) || variantsData.variants.find(v => 
                    v.memory === selectedMemory || v.color === selectedColor
                ) || variantsData.variants[0] || null;
                
                // Определяем первый доступный вариант
                const firstVariant = matchingVariant || variantsData.variants[0] || null;
                
                // Находим цену для выбранного варианта
                let selectedPrice = product.price;
                if (matchingVariant && matchingVariant.price) {
                    selectedPrice = matchingVariant.price;
                } else if (firstVariant && firstVariant.price) {
                    selectedPrice = firstVariant.price;
                }
                
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="breadcrumbs" id="breadcrumbsContainer">
                        <div class="breadcrumb-trail">
                            <a href="#" class="breadcrumb-link" onclick="loadHomePage(); return false;">Главная</a>
                            <span class="breadcrumb-separator">›</span>
                            <a href="#" class="breadcrumb-link" onclick="loadProductsByBrand('${product.brand}', '${product.level_0 || ''}'); return false;">${product.level_0 || 'Каталог'}</a>
                            <span class="breadcrumb-separator">›</span>
                            <span class="breadcrumb-current">${modelName}</span>
                        </div>
                    </div>
                    
                    <div class="product-detail-page">
                        <h1 class="product-detail-title">${modelName}</h1>
                        
                        <div class="product-detail-content">
                            <div class="product-detail-images">
                                <div class="product-detail-images-sticky">
                                    <div class="product-image-carousel-detail" data-product-id="${product.id}">
                                        <img alt="${modelName}" class="product-img-detail" style="opacity: 0;">
                                        <div class="image-placeholder loading-placeholder"><img src="/static/images/logo.jpg" alt="Loading..."></div>
                                        <div class="image-indicators">
                                            ${product.images && product.images.length > 0 ? product.images.map((_, index) => 
                                                `<span class="indicator ${index === 0 ? 'active' : ''}" data-index="${index}"></span>`
                                            ).join('') : '<span class="indicator active" data-index="0"></span>'}
                                        </div>
                                        <div class="image-nav prev" onclick="changeImageWithSlide(${product.id}, -1)" style="display: ${product.images && product.images.length > 1 ? 'flex' : 'none'}; opacity: 1 !important; visibility: visible !important; z-index: 200 !important;">‹</div>
                                        <div class="image-nav next" onclick="changeImageWithSlide(${product.id}, 1)" style="display: ${product.images && product.images.length > 1 ? 'flex' : 'none'}; opacity: 1 !important; visibility: visible !important; z-index: 200 !important;">›</div>
                                    </div>
                                </div>
                                
                                <!-- Рекомендации товаров -->
                                <div class="product-detail-recommendations" id="productDetailRecommendations" style="display: none;">
                                    <h3 class="product-detail-recommendations-title">Рекомендуем также</h3>
                                    <div class="product-detail-recommendations-list" id="productDetailRecommendationsList">
                                        <!-- Рекомендации будут загружены динамически -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="product-detail-info">
                                <div class="product-detail-price">
                                    <span class="price-main" id="detail-price">${Math.round(selectedPrice).toLocaleString()} ₽</span>
                                    ${product.old_price && product.old_price > selectedPrice ? `
                                        <span class="price-old">${Math.round(product.old_price).toLocaleString()} ₽</span>
                                    ` : ''}
                                </div>
                                
                                ${memories.length > 0 ? `
                                    <div class="variant-selector">
                                        <div class="variant-label">Память: <span class="variant-selected" data-testid="selected-memory">${selectedMemory}</span></div>
                                        <div class="variant-buttons">
                                            ${memories.map(memory => `
                                                <label class="variant-button ${memory === selectedMemory ? 'active' : ''}">
                                                    <input type="radio" name="memory" value="${memory}" ${memory === selectedMemory ? 'checked' : ''}>
                                                    <span>${memory}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${colors.length > 0 ? `
                                    <div class="variant-selector">
                                        <div class="variant-label">Цвет: <span class="variant-selected" data-testid="selected-colour">${selectedColor}</span></div>
                                        <div class="variant-buttons variant-buttons-color">
                                            ${colors.map(color => {
                                                const colorLower = color.toLowerCase();
                                                const colorClass = colorLower.replace(/\s+/g, '-');
                                                return `
                                                    <label class="variant-button variant-button-color ${colorClass} ${color === selectedColor ? 'active' : ''}" data-color="${color}">
                                                        <input type="radio" name="color" value="${color}" ${color === selectedColor ? 'checked' : ''}>
                                                        <span class="sr-only">${color}</span>
                                                    </label>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${sims.length > 0 ? `
                                    <div class="variant-selector">
                                        <div class="variant-label">Конфигурация SIM: <span class="variant-selected" data-testid="selected-sim">${selectedSim}</span></div>
                                        <div class="variant-buttons">
                                            ${sims.map(sim => `
                                                <label class="variant-button ${sim === selectedSim ? 'active' : ''}">
                                                    <input type="radio" name="sim" value="${sim}" ${sim === selectedSim ? 'checked' : ''}>
                                                    <span>${sim}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${rams.length > 0 ? `
                                    <div class="variant-selector">
                                        <div class="variant-label">RAM: <span class="variant-selected" data-testid="selected-ram">${selectedRam}</span></div>
                                        <div class="variant-buttons">
                                            ${rams.map(ram => `
                                                <label class="variant-button ${ram === selectedRam ? 'active' : ''}">
                                                    <input type="radio" name="ram" value="${ram}" ${ram === selectedRam ? 'checked' : ''}>
                                                    <span>${ram}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${ssds.length > 0 ? `
                                    <div class="variant-selector">
                                        <div class="variant-label">SSD: <span class="variant-selected" data-testid="selected-ssd">${selectedSsd}</span></div>
                                        <div class="variant-buttons">
                                            ${ssds.map(ssd => `
                                                <label class="variant-button ${ssd === selectedSsd ? 'active' : ''}">
                                                    <input type="radio" name="ssd" value="${ssd}" ${ssd === selectedSsd ? 'checked' : ''}>
                                                    <span>${ssd}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${screens.length > 0 ? `
                                    <div class="variant-selector">
                                        <div class="variant-label">Экран: <span class="variant-selected" data-testid="selected-screen">${selectedScreen}</span></div>
                                        <div class="variant-buttons">
                                            ${screens.map(screen => `
                                                <label class="variant-button ${screen === selectedScreen ? 'active' : ''}">
                                                    <input type="radio" name="screen" value="${screen}" ${screen === selectedScreen ? 'checked' : ''}>
                                                    <span>${screen}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${capacities.length > 0 ? `
                                    <div class="variant-selector">
                                        <div class="variant-label">Емкость: <span class="variant-selected" data-testid="selected-capacity">${selectedCapacity}</span></div>
                                        <div class="variant-buttons">
                                            ${capacities.map(capacity => `
                                                <label class="variant-button ${capacity === selectedCapacity ? 'active' : ''}">
                                                    <input type="radio" name="capacity" value="${capacity}" ${capacity === selectedCapacity ? 'checked' : ''}>
                                                    <span>${capacity}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div class="product-detail-actions">
                                    <button class="btn-add-to-cart-detail" onclick="addProductToCartFromDetail('${modelName}', event)">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                                            <line x1="3" y1="6" x2="21" y2="6"></line>
                                            <path d="M16 10a4 4 0 0 1-8 0"></path>
                                        </svg>
                                        <span class="btn-add-to-cart-detail-text">В корзину</span>
                                    </button>
                                </div>
                                
                                <!-- Рекомендации для мобильной версии (после кнопки "В корзину") -->
                                <div class="product-detail-recommendations product-detail-recommendations-mobile" id="productDetailRecommendationsMobile" style="display: none;">
                                    <h3 class="product-detail-recommendations-title">Рекомендуем также</h3>
                                    <div class="product-detail-recommendations-list" id="productDetailRecommendationsListMobile">
                                        <!-- Рекомендации будут загружены динамически -->
                                    </div>
                                </div>
                                
                                ${product.description ? `
                                    <div class="product-detail-description">
                                        <h3>Описание</h3>
                                        <p>${product.description}</p>
                                    </div>
                                ` : ''}
                                
                                ${details && Object.keys(details).length > 0 ? `
                                    <div class="product-detail-specifications">
                                        <h3>Характеристики</h3>
                                        <div class="specifications-list">
                                            ${Object.entries(details)
                                                .filter(([key, value]) => value && value !== 'undefined')
                                                .map(([key, value]) => 
                                                    `<div class="spec-item"><span class="spec-key">${key}:</span> <span class="spec-value">${value}</span></div>`
                                                ).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                // Инициализируем изображения
                setTimeout(async () => {
                    // Загружаем изображения для детальной страницы
                    const carousel = document.querySelector('.product-image-carousel-detail');
                    if (carousel) {
                        const img = carousel.querySelector('.product-img-detail');
                        const placeholder = carousel.querySelector('.loading-placeholder');
                        
                        // Если выбран цвет, обновляем изображение по цвету
                        if (selectedColor) {
                            await updateProductImage(product.id, selectedColor, { waitForLoad: true });
                        } else if (product.images && product.images.length > 0 && img) {
                            // Если цвета нет, просто показываем первое изображение
                            img.style.opacity = '0';
                            img.onload = () => {
                                if (placeholder) placeholder.style.display = 'none';
                                img.style.opacity = '1';
                            };
                            img.src = product.images[0];
                        }
                    }
                }, 100);
                
                // Обработчики для выбора вариантов
                // Функция для получения всех выбранных вариантов
                const getAllSelectedVariants = () => {
                    return {
                        memory: document.querySelector('input[name="memory"]:checked')?.value || selectedMemory,
                        color: document.querySelector('input[name="color"]:checked')?.value || selectedColor,
                        sim: document.querySelector('input[name="sim"]:checked')?.value || selectedSim,
                        ram: document.querySelector('input[name="ram"]:checked')?.value || selectedRam,
                        ssd: document.querySelector('input[name="ssd"]:checked')?.value || selectedSsd,
                        screen: document.querySelector('input[name="screen"]:checked')?.value || selectedScreen,
                        capacity: document.querySelector('input[name="capacity"]:checked')?.value || selectedCapacity
                    };
                };
                
                // Функция для обновления цены с учетом всех вариантов
                const updatePrice = () => {
                    const variants = getAllSelectedVariants();
                    updateDetailPrice(modelName, variants);
                };
                
                const memoryInputs = document.querySelectorAll('input[name="memory"]');
                const colorInputs = document.querySelectorAll('input[name="color"]');
                const simInputs = document.querySelectorAll('input[name="sim"]');
                const ramInputs = document.querySelectorAll('input[name="ram"]');
                const ssdInputs = document.querySelectorAll('input[name="ssd"]');
                const screenInputs = document.querySelectorAll('input[name="screen"]');
                const capacityInputs = document.querySelectorAll('input[name="capacity"]');
                
                memoryInputs.forEach(input => {
                    input.addEventListener('change', function() {
                        document.querySelectorAll('input[name="memory"]').forEach(inp => inp.closest('.variant-button')?.classList.remove('active'));
                        this.closest('.variant-button').classList.add('active');
                        const selectedEl = document.querySelector('[data-testid="selected-memory"]');
                        if (selectedEl) selectedEl.textContent = this.value;
                        updatePrice();
                    });
                });
                
                colorInputs.forEach(input => {
                    input.addEventListener('change', function() {
                        document.querySelectorAll('.variant-button-color').forEach(btn => btn.classList.remove('active'));
                        this.closest('.variant-button-color').classList.add('active');
                        const selectedEl = document.querySelector('[data-testid="selected-colour"]');
                        if (selectedEl) selectedEl.textContent = this.value;
                        updateProductImage(product.id, this.value, { waitForLoad: true });
                        updatePrice();
                    });
                });
                
                simInputs.forEach(input => {
                    input.addEventListener('change', function() {
                        document.querySelectorAll('input[name="sim"]').forEach(inp => inp.closest('.variant-button')?.classList.remove('active'));
                        this.closest('.variant-button').classList.add('active');
                        const selectedEl = document.querySelector('[data-testid="selected-sim"]');
                        if (selectedEl) selectedEl.textContent = this.value;
                        updatePrice();
                    });
                });
                
                ramInputs.forEach(input => {
                    input.addEventListener('change', function() {
                        document.querySelectorAll('input[name="ram"]').forEach(inp => inp.closest('.variant-button')?.classList.remove('active'));
                        this.closest('.variant-button').classList.add('active');
                        const selectedEl = document.querySelector('[data-testid="selected-ram"]');
                        if (selectedEl) selectedEl.textContent = this.value;
                        updatePrice();
                    });
                });
                
                ssdInputs.forEach(input => {
                    input.addEventListener('change', function() {
                        document.querySelectorAll('input[name="ssd"]').forEach(inp => inp.closest('.variant-button')?.classList.remove('active'));
                        this.closest('.variant-button').classList.add('active');
                        const selectedEl = document.querySelector('[data-testid="selected-ssd"]');
                        if (selectedEl) selectedEl.textContent = this.value;
                        updatePrice();
                    });
                });
                
                screenInputs.forEach(input => {
                    input.addEventListener('change', function() {
                        document.querySelectorAll('input[name="screen"]').forEach(inp => inp.closest('.variant-button')?.classList.remove('active'));
                        this.closest('.variant-button').classList.add('active');
                        const selectedEl = document.querySelector('[data-testid="selected-screen"]');
                        if (selectedEl) selectedEl.textContent = this.value;
                        updatePrice();
                    });
                });
                
                capacityInputs.forEach(input => {
                    input.addEventListener('change', function() {
                        document.querySelectorAll('input[name="capacity"]').forEach(inp => inp.closest('.variant-button')?.classList.remove('active'));
                        this.closest('.variant-button').classList.add('active');
                        const selectedEl = document.querySelector('[data-testid="selected-capacity"]');
                        if (selectedEl) selectedEl.textContent = this.value;
                        updatePrice();
                    });
                });
                
                updateBreadcrumbs();
                
                // Загружаем рекомендации
                await loadProductDetailRecommendations(product.id, product.level_2, product.level_0);
                
                // Инициализируем свайп для изображений на детальной странице
                setTimeout(() => {
                    addSwipeSupport();
                }, 100);
                
                hideLoading();
                
            } catch (error) {
                console.error('Ошибка загрузки детальной страницы продукта:', error);
                hideLoading();
            }
        }
        
        // Загрузка рекомендаций для детальной страницы продукта
        async function loadProductDetailRecommendations(currentProductId, currentModel, currentLevel0) {
            const recommendationsSection = document.getElementById('productDetailRecommendations');
            const recommendationsList = document.getElementById('productDetailRecommendationsList');
            
            if (!recommendationsSection || !recommendationsList) return;
            
            try {
                // Получаем список всех товаров
                const response = await fetch(`${API_BASE}/products?limit=100`);
                if (!response.ok) {
                    recommendationsSection.style.display = 'none';
                    return;
                }
                
                const allProducts = await response.json();
                
                // Фильтруем товары: исключаем текущий товар (по ID, по level_2 и по level_0)
                const availableProducts = allProducts.filter(product => {
                    // Исключаем товар с тем же ID
                    if (product.id === currentProductId) return false;
                    
                    // Исключаем товары с той же моделью (level_2)
                    if (currentModel && product.level_2 && product.level_2 === currentModel) return false;
                    
                    // Исключаем товары из той же категории (level_0)
                    if (currentLevel0 && product.level_0 && product.level_0 === currentLevel0) return false;
                    
                    // Показываем только товары с ценой
                    if (!product.price || product.price <= 0) return false;
                    
                    return true;
                });
                
                // Если нет доступных товаров, скрываем секцию
                if (availableProducts.length === 0) {
                    recommendationsSection.style.display = 'none';
                    return;
                }
                
                // Выбираем случайные 12 товаров (3 слайда по 4 товара)
                const shuffled = availableProducts.sort(() => 0.5 - Math.random());
                const recommendations = shuffled.slice(0, Math.min(12, shuffled.length));
                
                // Получаем варианты для всех рекомендованных товаров параллельно
                const recommendationsWithVariants = await Promise.all(recommendations.map(async (product) => {
                    let specsText = '';
                    try {
                        // Используем level_2 (модель) для получения вариантов
                        const model = product.level_2 || product.model || '';
                        if (model) {
                            const variantsResponse = await fetch(`${API_BASE}/products/${encodeURIComponent(model)}/variants`);
                            if (variantsResponse.ok) {
                                const variantsData = await variantsResponse.json();
                                if (variantsData.variants && variantsData.variants.length > 0) {
                                    const firstVariant = variantsData.variants[0];
                                    const specs = [
                                        firstVariant.color || '',
                                        firstVariant.memory || '',
                                        firstVariant.sim_type || '',
                                        firstVariant.ram || ''
                                    ].filter(s => s);
                                    specsText = specs.join(', ');
                                }
                            }
                        }
                    } catch (error) {
                        console.warn('Ошибка получения вариантов для рекомендации:', error);
                    }
                    return { ...product, specsText };
                }));
                
                // Разделяем товары на группы по 4 товара (2 строки по 2 товара)
                const groups = [];
                for (let i = 0; i < recommendationsWithVariants.length; i += 4) {
                    groups.push(recommendationsWithVariants.slice(i, i + 4));
                }
                
                // Функция для создания HTML товара
                const createProductHTML = (product) => {
                    const price = Math.round(product.price || 0);
                    const oldPrice = product.old_price ? Math.round(product.old_price) : null;
                    const imageUrl = product.image_url || (product.images && product.images[0]) || '/static/images/logo.jpg';
                    const productName = product.level_2 || product.name || 'Товар';
                    
                    return `
                        <div class="product-detail-recommendation-item" onclick="loadProductDetailPage('${(product.level_2 || product.model || product.name).replace(/'/g, "\\'")}'); return false;">
                            <img src="${imageUrl}" alt="${productName}" class="product-detail-recommendation-image" onerror="this.src='/static/images/logo.jpg'">
                            <div class="product-detail-recommendation-info">
                                <div class="product-detail-recommendation-name">${productName}</div>
                                ${product.specsText ? `<div class="product-detail-recommendation-specs">${product.specsText}</div>` : ''}
                                <div class="product-detail-recommendation-price">
                                    ${price.toLocaleString()} ₽
                                    ${oldPrice && oldPrice > price ? `<span style="font-size: 0.75rem; color: #6b7280; text-decoration: line-through; margin-left: 6px;">${oldPrice.toLocaleString()} ₽</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                };
                
                // Создаем слайды для каждой группы
                const slidesHTML = groups.map((group, index) => `
                    <div class="product-detail-recommendations-slide" data-slide="${index}">
                        ${group.map(createProductHTML).join('')}
                    </div>
                `).join('');
                
                // Создаем индикаторы (точки)
                const dotsHTML = groups.map((_, index) => `
                    <div class="product-detail-recommendations-dot ${index === 0 ? 'active' : ''}" onclick="switchProductDetailRecommendationSlide(${index})"></div>
                `).join('');
                
                // Отображаем рекомендации со слайдером
                recommendationsList.innerHTML = `
                    <div class="product-detail-recommendations-slider" id="productDetailRecommendationsSlider">
                        ${slidesHTML}
                    </div>
                    <div class="product-detail-recommendations-dots">
                        ${dotsHTML}
                    </div>
                `;
                
                // Инициализируем слайдер
                let currentSlide = 0;
                const slider = document.getElementById('productDetailRecommendationsSlider');
                const slides = slider?.querySelectorAll('.product-detail-recommendations-slide');
                const dots = document.querySelectorAll('.product-detail-recommendations-dot');
                
                // Функция переключения слайда
                window.switchProductDetailRecommendationSlide = function(index) {
                    if (!slider || !slides) return;
                    currentSlide = index;
                    slider.style.transform = `translateX(-${index * 100}%)`;
                    
                    // Обновляем активную точку
                    dots.forEach((dot, i) => {
                        dot.classList.toggle('active', i === index);
                    });
                };
                
                // Автоматическое переключение слайдов
                let autoSlideInterval = setInterval(() => {
                    if (slides && slides.length > 1) {
                        currentSlide = (currentSlide + 1) % slides.length;
                        window.switchProductDetailRecommendationSlide(currentSlide);
                    }
                }, 5000);
                
                // Останавливаем автопереключение при наведении
                recommendationsSection.addEventListener('mouseenter', () => {
                    clearInterval(autoSlideInterval);
                });
                
                recommendationsSection.addEventListener('mouseleave', () => {
                    autoSlideInterval = setInterval(() => {
                        if (slides && slides.length > 1) {
                            currentSlide = (currentSlide + 1) % slides.length;
                            window.switchProductDetailRecommendationSlide(currentSlide);
                        }
                    }, 5000);
                });
                
                // Инициализируем свайп
                let startX = 0;
                let isDragging = false;
                
                recommendationsList.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    isDragging = true;
                });
                
                recommendationsList.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                });
                
                recommendationsList.addEventListener('touchend', (e) => {
                    if (!isDragging) return;
                    isDragging = false;
                    const endX = e.changedTouches[0].clientX;
                    const diff = startX - endX;
                    
                    if (Math.abs(diff) > 50) {
                        if (diff > 0 && currentSlide < slides.length - 1) {
                            window.switchProductDetailRecommendationSlide(currentSlide + 1);
                        } else if (diff < 0 && currentSlide > 0) {
                            window.switchProductDetailRecommendationSlide(currentSlide - 1);
                        }
                    }
                });
                
                recommendationsSection.style.display = 'block';
                
                // Также загружаем рекомендации для мобильной версии
                const mobileRecommendationsSection = document.getElementById('productDetailRecommendationsMobile');
                const mobileRecommendationsList = document.getElementById('productDetailRecommendationsListMobile');
                
                if (mobileRecommendationsSection && mobileRecommendationsList) {
                    // Создаем отдельный HTML для мобильной версии с уникальным ID
                    const mobileSlidesHTML = groups.map((group, index) => `
                        <div class="product-detail-recommendations-slide" data-slide="${index}">
                            ${group.map(createProductHTML).join('')}
                        </div>
                    `).join('');
                    
                    const mobileDotsHTML = groups.map((_, index) => `
                        <div class="product-detail-recommendations-dot ${index === 0 ? 'active' : ''}" data-mobile-dot="${index}"></div>
                    `).join('');
                    
                    mobileRecommendationsList.innerHTML = `
                        <div class="product-detail-recommendations-slider" id="productDetailRecommendationsSliderMobile">
                            ${mobileSlidesHTML}
                        </div>
                        <div class="product-detail-recommendations-dots">
                            ${mobileDotsHTML}
                        </div>
                    `;
                    mobileRecommendationsSection.style.display = 'block';
                    
                    // Инициализируем слайдер для мобильной версии с небольшой задержкой для правильной инициализации
                    setTimeout(() => {
                        const mobileSlider = document.getElementById('productDetailRecommendationsSliderMobile');
                        const mobileSlides = mobileSlider?.querySelectorAll('.product-detail-recommendations-slide');
                        const mobileDots = mobileRecommendationsList.querySelectorAll('.product-detail-recommendations-dot');
                        let mobileCurrentSlide = 0;
                        
                        if (!mobileSlider || !mobileSlides || mobileSlides.length === 0) {
                            console.warn('Мобильный слайдер не найден:', { mobileSlider, mobileSlides });
                            return;
                        }
                        
                        console.log('Инициализация мобильного слайдера:', { 
                            slidesCount: mobileSlides.length, 
                            dotsCount: mobileDots.length 
                        });
                        
                        // Убеждаемся, что слайдер правильно инициализирован
                        if (mobileSlider && mobileSlides && mobileSlides.length > 0) {
                        // Получаем ширину контейнера
                        const containerWidth = mobileRecommendationsList.offsetWidth || mobileRecommendationsList.clientWidth;
                        
                        // Устанавливаем правильную ширину слайдера (100% * количество слайдов)
                        mobileSlider.style.width = `${mobileSlides.length * 100}%`;
                        
                        // Убеждаемся, что каждый слайд имеет правильную ширину (100% от контейнера)
                        mobileSlides.forEach((slide, index) => {
                            slide.style.width = `${100 / mobileSlides.length}%`;
                            slide.style.minWidth = `${100 / mobileSlides.length}%`;
                            slide.style.maxWidth = `${100 / mobileSlides.length}%`;
                            slide.style.flexShrink = '0';
                            slide.style.flexGrow = '0';
                            slide.style.display = 'grid';
                        });
                        
                        // Устанавливаем начальную позицию
                        mobileSlider.style.transform = 'translateX(0%)';
                        mobileSlider.style.display = 'flex';
                        
                        // Принудительно обновляем стили
                        mobileSlider.offsetHeight; // Trigger reflow
                        
                        // Функция переключения слайда для мобильной версии
                        const switchMobileSlide = (index) => {
                            if (!mobileSlider || !mobileSlides || index < 0 || index >= mobileSlides.length) {
                                console.warn('Некорректный индекс слайда:', index, 'из', mobileSlides.length);
                                return;
                            }
                            mobileCurrentSlide = index;
                            // Сдвигаем на index * 100% от контейнера (каждый слайд занимает 100% контейнера)
                            const translateX = -(index * (100 / mobileSlides.length));
                            mobileSlider.style.transform = `translateX(${translateX}%)`;
                            if (mobileDots && mobileDots.length > 0) {
                                mobileDots.forEach((dot, i) => {
                                    dot.classList.toggle('active', i === index);
                                });
                            }
                        };
                        
                        // Сохраняем функцию в глобальной области для использования в обработчиках
                        window.switchMobileRecommendationSlide = switchMobileSlide;
                    
                        // Обработчики для точек навигации
                        if (mobileDots && mobileDots.length > 0) {
                            mobileDots.forEach((dot, index) => {
                                dot.onclick = () => switchMobileSlide(index);
                            });
                        }
                        
                        // Обработчики свайпа для мобильной версии
                        let mobileStartX = 0;
                        let mobileIsDragging = false;
                        
                        mobileRecommendationsList.addEventListener('touchstart', (e) => {
                            mobileStartX = e.touches[0].clientX;
                            mobileIsDragging = true;
                        }, { passive: true });
                        
                        mobileRecommendationsList.addEventListener('touchmove', (e) => {
                            if (!mobileIsDragging) return;
                            e.preventDefault();
                        }, { passive: false });
                        
                        mobileRecommendationsList.addEventListener('touchend', (e) => {
                            if (!mobileIsDragging) return;
                            mobileIsDragging = false;
                            const endX = e.changedTouches[0].clientX;
                            const diff = mobileStartX - endX;
                            
                            if (Math.abs(diff) > 50) {
                                if (diff > 0 && mobileCurrentSlide < mobileSlides.length - 1) {
                                    switchMobileSlide(mobileCurrentSlide + 1);
                                } else if (diff < 0 && mobileCurrentSlide > 0) {
                                    switchMobileSlide(mobileCurrentSlide - 1);
                                }
                            }
                        }, { passive: true });
                        }
                    }, 100);
                }
            } catch (error) {
                console.error('Ошибка загрузки рекомендаций для детальной страницы:', error);
                recommendationsSection.style.display = 'none';
                const mobileRecommendationsSection = document.getElementById('productDetailRecommendationsMobile');
                if (mobileRecommendationsSection) {
                    mobileRecommendationsSection.style.display = 'none';
                }
            }
        }
        
        // Обновление цены на детальной странице
        async function updateDetailPrice(modelName, variants) {
            try {
                const variantsResponse = await fetch(`${API_BASE}/products/${encodeURIComponent(modelName)}/variants`);
                if (variantsResponse.ok) {
                    const variantsData = await variantsResponse.json();
                    // Ищем вариант, который соответствует всем выбранным параметрам
                    const matchingVariant = variantsData.variants.find(v => {
                        return (!variants.memory || v.memory === variants.memory) &&
                               (!variants.color || v.color === variants.color) &&
                               (!variants.sim || (v.sim_type || v.sim) === variants.sim) &&
                               (!variants.ram || v.ram === variants.ram) &&
                               (!variants.ssd || (v.ssd || v.disk) === variants.ssd) &&
                               (!variants.screen || v.screen === variants.screen) &&
                               (!variants.capacity || v.capacity === variants.capacity);
                    }) || variantsData.variants.find(v => 
                        v.memory === variants.memory && v.color === variants.color
                    ) || variantsData.variants[0];
                    
                    if (matchingVariant && matchingVariant.price) {
                        const priceElement = document.getElementById('detail-price');
                        if (priceElement) {
                            priceElement.textContent = `${Math.round(matchingVariant.price).toLocaleString()} ₽`;
                        }
                    }
                }
            } catch (error) {
                console.error('Ошибка обновления цены:', error);
            }
        }
        
        // Добавление в корзину с детальной страницы
        async function addProductToCartFromDetail(modelName, clickEvent) {
            try {
                // Получаем все выбранные варианты из формы
                const selectedVariants = {
                    memory: document.querySelector('input[name="memory"]:checked')?.value || '',
                    color: document.querySelector('input[name="color"]:checked')?.value || '',
                    sim: document.querySelector('input[name="sim"]:checked')?.value || '',
                    ram: document.querySelector('input[name="ram"]:checked')?.value || '',
                    ssd: document.querySelector('input[name="ssd"]:checked')?.value || '',
                    screen: document.querySelector('input[name="screen"]:checked')?.value || '',
                    capacity: document.querySelector('input[name="capacity"]:checked')?.value || ''
                };
                
                // Получаем информацию о продукте
                const productResponse = await fetch(`${API_BASE}/products?level2=${encodeURIComponent(modelName)}&limit=1`);
                const products = await productResponse.ok ? await productResponse.json() : [];
                
                if (products.length === 0) {
                    console.error('Продукт не найден:', modelName);
                    return;
                }
                
                const product = products[0];
                
                // Получаем варианты
                const variantsResponse = await fetch(`${API_BASE}/products/${encodeURIComponent(modelName)}/variants`);
                if (!variantsResponse.ok) return;
                
                const variantsData = await variantsResponse.json();
                // Ищем вариант, который соответствует всем выбранным параметрам
                const matchingVariant = variantsData.variants.find(v => {
                    return (!selectedVariants.memory || v.memory === selectedVariants.memory) &&
                           (!selectedVariants.color || v.color === selectedVariants.color) &&
                           (!selectedVariants.sim || (v.sim_type || v.sim) === selectedVariants.sim) &&
                           (!selectedVariants.ram || v.ram === selectedVariants.ram) &&
                           (!selectedVariants.ssd || (v.ssd || v.disk) === selectedVariants.ssd) &&
                           (!selectedVariants.screen || v.screen === selectedVariants.screen) &&
                           (!selectedVariants.capacity || v.capacity === selectedVariants.capacity);
                }) || variantsData.variants.find(v => 
                    v.memory === selectedVariants.memory && v.color === selectedVariants.color
                ) || variantsData.variants[0];
                
                if (matchingVariant) {
                    // Формируем объект продукта для addToCart
                    const productData = {
                        level_2: modelName,
                        level_0: product.level_0 || null,
                        model: modelName,
                        name: modelName,
                        image: product.image_url || (product.images && product.images[0] ? product.images[0] : ''),
                        images: product.images || [],
                        price: matchingVariant.price || product.price,
                        selectedColor: selectedVariants.color,
                        selectedMemory: selectedVariants.memory,
                        selectedSim: selectedVariants.sim || matchingVariant.sim || '',
                        selectedRam: selectedVariants.ram || matchingVariant.ram || '',
                        selectedSsd: selectedVariants.ssd || matchingVariant.ssd || '',
                        selectedScreen: selectedVariants.screen || matchingVariant.screen || '',
                        selectedCapacity: selectedVariants.capacity || matchingVariant.capacity || '',
                        specs: product.specifications || {}
                    };
                    
                    addToCart(matchingVariant.product_id, productData);
                } else {
                    // Если точный вариант не найден, используем базовый продукт
                    const productData = {
                        level_2: modelName,
                        level_0: product.level_0 || null,
                        model: modelName,
                        name: modelName,
                        image: product.image_url || (product.images && product.images[0] ? product.images[0] : ''),
                        images: product.images || [],
                        price: product.price,
                        selectedColor: selectedVariants.color,
                        selectedMemory: selectedVariants.memory,
                        selectedSim: selectedVariants.sim || '',
                        selectedRam: selectedVariants.ram || '',
                        selectedSsd: selectedVariants.ssd || '',
                        selectedScreen: selectedVariants.screen || '',
                        selectedCapacity: selectedVariants.capacity || '',
                        specs: product.specifications || {}
                    };
                    
                    addToCart(product.id, productData);
                }
                
                // Show confirmation with smooth animation
                if (clickEvent && clickEvent.target) {
                    const btn = clickEvent.target.closest('.btn-add-to-cart-detail');
                    if (btn) {
                        const textSpan = btn.querySelector('.btn-add-to-cart-detail-text');
                        const iconSvg = btn.querySelector('svg');
                        if (textSpan) {
                            // Fade out current text and icon
                            textSpan.classList.add('fade-out');
                            if (iconSvg) {
                                iconSvg.classList.add('hide-icon');
                            }
                            
                            setTimeout(() => {
                                // Replace with checkmark icon
                                textSpan.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                                // Center the checkmark
                                textSpan.classList.add('show-checkmark');
                                // Fade in new text (icon stays hidden)
                                textSpan.classList.remove('fade-out');
                                textSpan.classList.add('fade-in');
                                
                                setTimeout(() => {
                                    // Fade out checkmark icon
                                    textSpan.classList.remove('fade-in');
                                    textSpan.classList.add('fade-out');
                                    
                                    setTimeout(() => {
                                        // Restore original text and show icon
                                        textSpan.textContent = 'В корзину';
                                        // Remove checkmark centering
                                        textSpan.classList.remove('show-checkmark');
                                        // Fade in original text
                                        textSpan.classList.remove('fade-out');
                                        textSpan.classList.add('fade-in');
                                        if (iconSvg) {
                                            iconSvg.classList.remove('hide-icon');
                                        }
                                        
                                        setTimeout(() => {
                                            textSpan.classList.remove('fade-in');
                                        }, 300);
                                    }, 300);
                                }, 1500);
                            }, 300);
                        }
                    }
                }
            } catch (error) {
                console.error('Ошибка добавления в корзину:', error);
            }
        }
        
        // Применение фильтра по уровням
        async function applyLevelFilter(filterType, filterValue) {
            try {
                // Обновляем глобальные переменные
                if (filterType === 'level0') {
                    currentLevel0Filter = filterValue;
                    currentLevel1Filter = null;
                    currentLevel2Filter = null;
                } else if (filterType === 'level1') {
                    currentLevel1Filter = filterValue;
                    currentLevel2Filter = null;
                } else if (filterType === 'level2') {
                    currentLevel2Filter = filterValue;
                }
                
                // Загружаем отфильтрованные товары
                await loadFilteredProducts();
                
                // Обновляем хлебные крошки
                updateBreadcrumbs();
                
                // Обновляем кнопки фильтров
                await createHierarchyFilters(currentBrandFilter, []);
                
            } catch (error) {
                console.error('Ошибка применения фильтра:', error);
            }
        }
        
        // Загрузка отфильтрованных товаров
        async function loadFilteredProducts() {
            try {
                // Добавить индикатор загрузки только к grid товаров
                const content = document.getElementById('content');
                const productsContainer = content.querySelector('.products-grid');
                
                if (!productsContainer) {
                    console.error('Products container not found');
                    return;
                }
                
                // Сохраняем текущую высоту контейнера, чтобы footer не поднимался
                const currentHeight = productsContainer.offsetHeight;
                if (currentHeight > 0) {
                    productsContainer.style.minHeight = currentHeight + 'px';
                }
                
                // Показываем спиннер загрузки
                productsContainer.innerHTML = '<div class="loading-products"></div>';
                
                // Строим URL с текущими фильтрами
                const params = new URLSearchParams();
                params.append('brand', currentBrandFilter);
                params.append('limit', '50');
                
                if (currentLevel0Filter) params.append('level0', currentLevel0Filter);
                if (currentLevel1Filter) params.append('level1', currentLevel1Filter);
                if (currentLevel2Filter) params.append('level2', currentLevel2Filter);
                
                const response = await fetch(`${API_BASE}/products?${params.toString()}`);
                let products = await response.json();
                
                // Кастомная сортировка для 17 Series
                if (currentLevel1Filter === '17 Series') {
                    const sortOrder = [
                        'iPhone 17 Pro Max',
                        'iPhone 17 Pro',
                        'iPhone Air',
                        'iPhone 17'
                    ];
                    
                    products.sort((a, b) => {
                        const aName = a.name || a.level_2 || '';
                        const bName = b.name || b.level_2 || '';
                        
                        const aIndex = sortOrder.findIndex(order => aName.includes(order));
                        const bIndex = sortOrder.findIndex(order => bName.includes(order));
                        
                        // Если оба найдены в порядке сортировки
                        if (aIndex !== -1 && bIndex !== -1) {
                            return aIndex - bIndex;
                        }
                        // Если только один найден, он идет первым
                        if (aIndex !== -1) return -1;
                        if (bIndex !== -1) return 1;
                        // Если оба не найдены, сортируем по имени
                        return aName.localeCompare(bName);
                    });
                }
                
                // Обновляем только товары в grid
                productsContainer.innerHTML = products.map(product => {
                    storeProductImages(product);
                    return createProductCard(product);
                }).join('');
                
                // Убираем minHeight после загрузки товаров
                productsContainer.style.minHeight = '';
                
                // Инициализировать цвета по умолчанию и загрузить изображения
                setTimeout(async () => {
                    await initializeDefaultColors();
                    await loadDefaultImages();
                    await loadAllSpecifications();
                }, 100);
                
            } catch (error) {
                console.error('Ошибка загрузки отфильтрованных товаров:', error);
                const productsContainer = document.querySelector('.products-grid');
                if (productsContainer) {
                    productsContainer.innerHTML = '<div class="error">Ошибка загрузки товаров</div>';
                }
            }
        }
        
        // Сброс всех фильтров
        async function resetFilters() {
            currentLevel1Filter = null;
            currentLevel2Filter = null;
            // НЕ сбрасываем currentLevel0Filter - он должен оставаться из категории
            
            await loadFilteredProducts();
            
            // Обновляем хлебные крошки
            updateBreadcrumbs();
            
            await createHierarchyFilters(currentBrandFilter, []);
        }
        
        // Create product card HTML
        function createProductCard(product) {
            const discountHtml = product.discount_percentage > 0 
                ? `<span class="discount">-${Math.round(product.discount_percentage)}%</span>` 
                : '';
            
            const oldPriceHtml = product.old_price > product.price 
                ? `<span class="old-price">${Math.round(product.old_price).toLocaleString()} ₽</span>` 
                : '';
            
            // Определяем модель для загрузки вариантов
            const modelKey = product.model;
            
            // Создать базовую HTML структуру для вариантов товара
            const variantSelectorsHtml = `
                <div class="product-variants" data-product-id="${product.id}" data-model="${modelKey}" onclick="event.stopPropagation();">
                    <!-- Варианты будут загружены динамически -->
                </div>
            `;
            
            // Обработка изображений - показываем изображение из базы данных сразу
            let imageHtml = '';
            
            if (product.images && product.images.length > 0) {
                // Если есть множественные изображения из базы данных
                if (product.images.length > 1) {
                    imageHtml = `
                        <div class="product-image-carousel" data-product-id="${product.id}">
                            <img alt="${product.name}" class="product-img" style="opacity: 0;">
                            <div class="image-placeholder loading-placeholder"><img src="/static/images/logo.jpg" alt="Loading..."></div>
                            <div class="image-indicators">
                                ${product.images.map((_, index) => 
                                    `<span class="indicator ${index === 0 ? 'active' : ''}" data-index="${index}"></span>`
                                ).join('')}
                            </div>
                            <div class="image-nav prev" onclick="event.stopPropagation(); changeImageWithSlide(${product.id}, -1)">‹</div>
                            <div class="image-nav next" onclick="event.stopPropagation(); changeImageWithSlide(${product.id}, 1)">›</div>
                        </div>
                    `;
                } else {
                    // Одно изображение из базы данных
                    imageHtml = `
                        <div class="product-image-carousel" data-product-id="${product.id}">
                            <img alt="${product.name}" class="product-img" style="opacity: 0;">
                            <div class="image-placeholder loading-placeholder"><img src="/static/images/logo.jpg" alt="Loading..."></div>
                            <div class="image-indicators"></div>
                            <div class="image-nav prev" onclick="event.stopPropagation(); changeImageWithSlide(${product.id}, -1)" style="display:none;">‹</div>
                            <div class="image-nav next" onclick="event.stopPropagation(); changeImageWithSlide(${product.id}, 1)" style="display:none;">›</div>
                        </div>
                    `;
                }
            } else if (product.image_url) {
                // Старое поле image_url
                imageHtml = `
                    <div class="product-image-carousel" data-product-id="${product.id}">
                            <img alt="${product.name}" class="product-img" style="opacity: 0;">
                        <div class="image-placeholder loading-placeholder"><img src="/static/images/logo.jpg" alt="Loading..."></div>
                        <div class="image-indicators"></div>
                        <div class="image-nav prev" onclick="event.stopPropagation(); changeImageWithSlide(${product.id}, -1)" style="display:none;">‹</div>
                        <div class="image-nav next" onclick="event.stopPropagation(); changeImageWithSlide(${product.id}, 1)" style="display:none;">›</div>
                    </div>
                `;
            } else {
                // Если нет изображений в базе данных - показываем placeholder
                imageHtml = `
                    <div class="product-image-carousel" data-product-id="${product.id}">
                        <div class="image-placeholder loading-placeholder"><img src="/static/images/logo.jpg" alt="Loading..."></div>
                        <div class="image-indicators"></div>
                        <div class="image-nav prev" onclick="event.stopPropagation(); changeImageWithSlide(${product.id}, -1)" style="display:none;">‹</div>
                        <div class="image-nav next" onclick="event.stopPropagation(); changeImageWithSlide(${product.id}, 1)" style="display:none;">›</div>
                    </div>
                `;
            }
            
            return `
                <div class="product-card" onclick="openProductDetailWithVariants(${product.id}, '${(product.level_2 || product.model || product.name).replace(/'/g, "\\'")}'); return false;" style="cursor: pointer;">
                    <div class="low-stock-badge" id="low-stock-badge-${product.id}" style="display: none;">Осталась 1 шт</div>
                    <div class="product-image">
                        ${imageHtml}
                    </div>
                    <div class="product-info">
                        <div class="product-name">${product.level_2 || product.name}</div>
                        <div class="product-brand">${product.brand}</div>
                        <div class="product-price" style="display: flex; align-items: center; gap: 10px;">
                            <span class="current-price" id="price-${product.id}">${Math.round(product.price).toLocaleString()} ₽</span>
                            ${oldPriceHtml}
                            ${discountHtml}
                        </div>
                        
                        <!-- Варианты товара -->
                        ${variantSelectorsHtml}
                        
                        <!-- Спойлеры для описания и характеристик -->
                        <div class="product-description-spoiler" onclick="event.stopPropagation();">
                            <div class="spoiler-header" onclick="toggleSpoiler('desc-${product.id}')">
                                <span class="spoiler-title">Описание</span>
                                <span class="spoiler-arrow" id="arrow-desc-${product.id}">▶</span>
                            </div>
                            <div class="spoiler-content" id="desc-${product.id}" style="display: none;">
                                <div class="product-description">${product.description}</div>
                            </div>
                        </div>
                        
                        <div class="product-specifications-spoiler" onclick="event.stopPropagation();">
                            <div class="spoiler-header" onclick="toggleSpoiler('spec-${product.id}')">
                                <span class="spoiler-title">Характеристики</span>
                                <span class="spoiler-arrow" id="arrow-spec-${product.id}">▶</span>
                            </div>
                            <div class="spoiler-content" id="spec-${product.id}" style="display: none;">
                                <div class="specifications" data-level2="${product.level_2}">
                                    <div class="loading-specs">Загрузка характеристик...</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Кнопка добавления в корзину -->
                        <div style="display: flex; justify-content: flex-end; margin-top: 12px;" onclick="event.stopPropagation();">
                            <button class="add-to-cart-btn" onclick="event.stopPropagation(); addProductToCart(${product.id}, '${product.model}', event)">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                                    <line x1="3" y1="6" x2="21" y2="6"></line>
                                    <path d="M16 10a4 4 0 0 1-8 0"></path>
                                </svg>
                                <span class="add-to-cart-btn-text">В корзину</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Toggle spoiler content
        function toggleSpoiler(spoilerId) {
            const content = document.getElementById(spoilerId);
            const arrow = document.getElementById('arrow-' + spoilerId);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.textContent = '▼';
            } else {
                content.style.display = 'none';
                arrow.textContent = '▶';
            }
        }
        
        // Calculate variant price
        function calculateVariantPrice(productId, basePrice, selectedVariant) {
            let priceModifier = 0;
            
            // Логика расчета цены на основе выбранных вариантов
            if (selectedVariant.memory) {
                const memoryPrice = {
                    '128GB': 0,
                    '256GB': 10000,
                    '512GB': 20000,
                    '1TB': 30000
                };
                priceModifier += memoryPrice[selectedVariant.memory] || 0;
            }
            
            if (selectedVariant.color) {
                // Обычно цвет не влияет на цену, но может быть особые цвета
                if (selectedVariant.color.includes('Gold') || selectedVariant.color.includes('Special')) {
                    priceModifier += 5000;
                }
            }
            
            if (selectedVariant.sim) {
                if (selectedVariant.sim === 'Dual SIM') {
                    priceModifier += 2000;
                } else if (selectedVariant.sim === 'eSIM') {
                    priceModifier += 1000;
                }
            }
            
            // Для ноутбуков
            if (selectedVariant.screen) {
                const screenPrice = {
                    '14"': 0,
                    '15"': 15000,
                    '16"': 25000,
                    '17"': 35000
                };
                priceModifier += screenPrice[selectedVariant.screen] || 0;
            }
            
            if (selectedVariant.ram) {
                const ramPrice = {
                    '8GB': 0,
                    '16GB': 10000,
                    '32GB': 25000,
                    '64GB': 50000
                };
                priceModifier += ramPrice[selectedVariant.ram] || 0;
            }
            
            if (selectedVariant.ssd) {
                const ssdPrice = {
                    '256GB': 0,
                    '512GB': 15000,
                    '1TB': 30000,
                    '2TB': 60000
                };
                priceModifier += ssdPrice[selectedVariant.ssd] || 0;
            }
            
            return basePrice + priceModifier;
        }
        
        // Toggle variant button
        function toggleVariant(productId, buttonElement) {
            const productCard = buttonElement.closest('.product-card');
            const variantsContainer = productCard.querySelector('.product-variants');
            const variantType = buttonElement.dataset.type;
            const variantValue = buttonElement.dataset.value || buttonElement.dataset.color;
            
            // Снять активность с других кнопок того же типа
            const sameTypeButtons = variantsContainer.querySelectorAll(`[data-type="${variantType}"]`);
            sameTypeButtons.forEach(btn => btn.classList.remove('active'));
            
            // Активировать выбранную кнопку
            buttonElement.classList.add('active');
            
            // Получить все выбранные варианты
            const selectedVariants = {};
            const activeButtons = variantsContainer.querySelectorAll('.variant-btn.active');
            activeButtons.forEach(btn => {
                selectedVariants[btn.dataset.type] = btn.dataset.value || btn.dataset.color;
            });
            
            // Обновить изображение если выбран цвет (при любом изменении вариантов)
            if (variantType === 'color') {
                // Скрыть подсказку через 2 секунды после клика
                try {
                    buttonElement.classList.remove('no-tooltip');
                    setTimeout(() => {
                        buttonElement.classList.add('no-tooltip');
                    }, 2000);
                    // Вновь разрешать показ подсказки при уходе курсора
                    buttonElement.addEventListener('mouseleave', function handleLeave() {
                        buttonElement.classList.remove('no-tooltip');
                        buttonElement.removeEventListener('mouseleave', handleLeave);
                    });
                } catch (e) {}
                updateProductImage(productId, variantValue);
            }
            // При изменении других вариантов (память, RAM, SIM) изображение не обновляется - оно меняется только при изменении цвета
            
            // Обновить характеристики товара при смене вариантов
            updateProductSpecifications(productId, selectedVariants);
            
            // Получить базовую цену
            const priceElement = productCard.querySelector(`#price-${productId}`);
            const basePriceText = priceElement.textContent.replace(/[^\d]/g, '');
            const basePrice = parseInt(basePriceText) || 0;
            
            // Рассчитать новую цену
            const newPrice = calculateVariantPrice(productId, basePrice, selectedVariants);
            
            // Обновить отображение цены
            priceElement.textContent = `${Math.round(newPrice).toLocaleString()} ₽`;
        }
        
        // Update product specifications based on selected variants
        async function updateProductSpecifications(productId, selectedVariants) {
            try {
                // Получить информацию о товаре с выбранными вариантами
                const response = await fetch(`/products/${productId}/variants`);
                const variantsData = await response.json();
                
                // Найти товар с выбранными вариантами
                const matchingVariant = variantsData.variants.find(variant => {
                    return variant.color === selectedVariants.color &&
                           variant.memory === selectedVariants.memory &&
                           variant.sim_type === selectedVariants.sim;
                });
                
                if (matchingVariant) {
                    // Загрузить общие характеристики из таблицы level2_descriptions
                    const level2Details = await loadLevel2Details(variantsData.model);
                    
                    // Обновить характеристики в DOM
                    const productCard = document.querySelector(`[data-product-id="${productId}"]`)?.closest('.product-card');
                    if (productCard) {
                        const specsElement = productCard.querySelector(`#spec-${productId}`);
                        if (specsElement) {
                            const specsContainer = specsElement.querySelector('.specifications');
                            if (specsContainer) {
                                // Объединить общие характеристики с вариантами
                                const allSpecs = {
                                    ...level2Details, // Общие характеристики (процессор, экран, камера и т.д.)
                                    'Память': matchingVariant.memory || selectedVariants.memory,
                                    'Цвет': matchingVariant.color || selectedVariants.color,
                                    'Конфигурация SIM': matchingVariant.sim_type || selectedVariants.sim
                                };
                                
                                // Обновить HTML характеристик
                                specsContainer.innerHTML = Object.entries(allSpecs)
                                    .filter(([key, value]) => value && value !== 'undefined')
                                    .map(([key, value]) => 
                                        `<div class="spec-item"><span class="spec-key">${key}:</span> <span class="spec-value">${value}</span></div>`
                                    ).join('');
                                
                            }
                        }
                    }
                }
            } catch (error) {
                console.error(`❌ Ошибка обновления характеристик для товара ${productId}:`, error);
            }
        }
        
        // Функция для загрузки характеристик для всех товаров
        async function loadAllSpecifications() {
            const specsContainers = document.querySelectorAll('.specifications[data-level2]');
            
            for (const container of specsContainers) {
                // Удаляем placeholder "Загрузка характеристик..." если есть
                const loadingPlaceholder = container.querySelector('.loading-specs');
                if (loadingPlaceholder) {
                    loadingPlaceholder.remove();
                }
                
                const level2 = container.dataset.level2;
                if (level2) {
                    try {
                        const details = await loadLevel2Details(level2);
                        
                        // Получить варианты товара для добавления к общим характеристикам
                        const productCard = container.closest('.product-card');
                        const productIdElement = productCard?.querySelector('[data-product-id]');
                        const productId = productIdElement?.dataset.productId;
                        
                        if (productId) {
                            // Получить первый вариант товара для отображения базовых характеристик
                            const response = await fetch(`/products/${productId}/variants`);
                            if (response.ok) {
                                const variantsData = await response.json();
                                const firstVariant = variantsData.variants[0];
                                
                                if (firstVariant) {
                                    // Объединить общие характеристики с первым вариантом
                                    const allSpecs = {
                                        ...details, // Общие характеристики
                                        'Память': firstVariant.memory,
                                        'Цвет': firstVariant.color,
                                        'Конфигурация SIM': firstVariant.sim_type
                                    };
                                    
                                    // Обновить HTML характеристик
                                    container.innerHTML = Object.entries(allSpecs)
                                        .filter(([key, value]) => value && value !== 'undefined')
                                        .map(([key, value]) => 
                                            `<div class="spec-item"><span class="spec-key">${key}:</span> <span class="spec-value">${value}</span></div>`
                                        ).join('');
                                } else {
                                    // Если нет вариантов, показать только общие характеристики
                                    container.innerHTML = Object.entries(details)
                                        .filter(([key, value]) => value && value !== 'undefined')
                                        .map(([key, value]) => 
                                            `<div class="spec-item"><span class="spec-key">${key}:</span> <span class="spec-value">${value}</span></div>`
                                        ).join('') || 'Характеристики не указаны';
                                }
                            }
                        }
                    } catch (error) {
                        console.error(`Ошибка загрузки характеристик для ${level2}:`, error);
                        container.innerHTML = 'Ошибка загрузки характеристик';
                    }
                }
            }
        }

        // Функция для загрузки характеристик из таблицы level2_descriptions
        async function loadLevel2Details(level2) {
            try {
                const response = await fetch(`/level2-descriptions/${encodeURIComponent(level2)}`);
                if (response.ok) {
                    const data = await response.json();
                    return data.details || {};
                }
            } catch (error) {
                console.error(`Ошибка загрузки характеристик для ${level2}:`, error);
            }
            return {};
        }
        
        // Update product image based on selected color - БЕЗ ХАРДКОДА!
        async function updateProductImage(productId, selectedColor, options = {}) {
            const waitForLoad = options.waitForLoad === true;
            
            // Валидация входных параметров
            if (!selectedColor || selectedColor === 'undefined' || selectedColor === 'null' || selectedColor === undefined) {
                console.warn(`❌ Неверный цвет для товара ID ${productId}:`, selectedColor, typeof selectedColor);
                return;
            }
            
            console.log(`🔍 updateProductImage вызвана для товара ${productId} с цветом:`, selectedColor, typeof selectedColor);
            
            // Найти карточку товара или детальную страницу
            const productCard = document.querySelector(`[data-product-id="${productId}"]`)?.closest('.product-card');
            const isDetailPage = !productCard && document.querySelector('.product-detail-page');
            
            let container = productCard;
            let variantsElement = null;
            let brandModel = null;
            
            if (productCard) {
                // Обычная карточка товара
                variantsElement = productCard.querySelector('.product-variants');
                brandModel = variantsElement?.dataset.model;
            } else if (isDetailPage) {
                // Детальная страница
                container = document.querySelector('.product-detail-page');
                // Получаем модель из заголовка или из данных
                const titleElement = container?.querySelector('.product-detail-title');
                brandModel = titleElement?.textContent?.trim() || null;
            }
            
            if (!container) {
                console.warn(`Контейнер товара с ID ${productId} не найден`);
                return;
            }
            
            if (!brandModel) {
                console.warn(`Модель товара не найдена для ID ${productId}`);
                return;
            }
            
            // Получить model_key из названия модели
            const modelKey = getModelKey(brandModel);
            if (!modelKey) {
                console.warn(`Не удалось определить model_key для ${brandModel}`);
                return;
            }
            
            // Используем оригинальное название цвета для API запроса
            const apiColor = selectedColor; // "Deep Blue"
            
            console.log(`📸 Обновляем изображения для ${brandModel} цвета ${selectedColor} -> ${apiColor} (modelKey: ${modelKey})`);
            
            try {
                // Получить информацию об изображениях из API
                const apiUrl = `/product-images/${modelKey}/${encodeURIComponent(apiColor)}`;
                console.log(`🌐 API запрос: ${apiUrl}`);
                
                const response = await fetch(apiUrl);
                
                console.log(`📡 API ответ: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const imageData = await response.json();
                console.log(`📊 Данные изображений:`, imageData);
                
                // Проверяем, что image_paths существует
                if (!imageData.image_paths || !Array.isArray(imageData.image_paths)) {
                    console.warn(`❌ Некорректные данные изображений для ${brandModel} цвета ${selectedColor}:`, imageData);
                    console.warn(`❌ image_paths не является массивом:`, imageData.image_paths);
                    throw new Error('Некорректные данные изображений');
                }
                
                // Добавить timestamp для предотвращения кэширования
                const timestampedPaths = imageData.image_paths.map(img => `${img}?v=${Date.now()}`);
                
                // Обновить изображения в карусели (для карточки или детальной страницы)
                const carousel = container.querySelector('.product-image-carousel') || container.querySelector('.product-image-carousel-detail');
                if (carousel) {
                    // Placeholder пока изображение не загрузится
                    const loadingPlaceholder = carousel.querySelector('.loading-placeholder');
                    if (loadingPlaceholder && !waitForLoad) {
                        loadingPlaceholder.style.display = 'none';
                    } else if (loadingPlaceholder && waitForLoad) {
                        loadingPlaceholder.style.display = 'block';
                    }

                    // Проверяем, есть ли уже структура слайдов
                    let slideContainer = carousel.querySelector('.image-slide-container');
                    
                    if (slideContainer) {
                        // Обновляем существующую структуру слайдов
                        const slideWrapper = slideContainer.querySelector('.image-slide-wrapper');
                        const slideItems = slideContainer.querySelectorAll('.image-slide-item');
                        
                        // Удаляем старые слайды
                        slideItems.forEach(item => item.remove());
                        
                        // Создаем новые слайды для нового цвета
                        timestampedPaths.forEach((imageSrc, index) => {
                            const slideItem = document.createElement('div');
                            slideItem.className = 'image-slide-item';
                            if (index === 0) {
                                slideItem.classList.add('fade-in');
                            }
                            
                            const img = document.createElement('img');
                            img.src = imageSrc;
                            img.alt = `Product image ${index + 1}`;
                            img.style.opacity = index === 0 ? '1' : '0';
                            
                            slideItem.appendChild(img);
                            slideWrapper.appendChild(slideItem);
                        });
                        
                        // Сбрасываем позицию слайдера на первое изображение
                        slideWrapper.style.transform = 'translateX(0%)';
                        
                    } else {
                        // Обновляем обычное изображение (для карточки или детальной страницы)
                        const mainImg = carousel.querySelector('.product-img') || carousel.querySelector('.product-img-detail');
                        if (mainImg && timestampedPaths[0]) {
                            // Устанавливаем новое изображение
                            mainImg.style.opacity = '0';
                            mainImg.onload = () => {
                                if (loadingPlaceholder) loadingPlaceholder.style.display = 'none';
                            mainImg.style.opacity = '1';
                            };
                            mainImg.src = timestampedPaths[0];
                        } else {
                            // Попробуем создать изображение, если его нет
                            if (!mainImg && timestampedPaths[0]) {
                                const newImg = document.createElement('img');
                                newImg.alt = `${brandModel} ${selectedColor}`;
                                newImg.className = 'product-img';
                                newImg.style.cssText = 'width: 90%; height: 90%; object-fit: contain; border-radius: 15px; margin: 5%; opacity: 0;';
                                newImg.onload = () => {
                                    if (loadingPlaceholder) loadingPlaceholder.style.display = 'none';
                                    newImg.style.opacity = '1';
                                };
                                newImg.src = timestampedPaths[0];
                                
                                carousel.appendChild(newImg);
                            }
                        }
                    }
                    
                    // Индикаторы карусели
                    let indicatorsContainer = carousel.querySelector('.image-indicators');
                    if (!indicatorsContainer) {
                        // Создаем контейнер индикаторов, если его нет
                        indicatorsContainer = document.createElement('div');
                        indicatorsContainer.className = 'image-indicators';
                        carousel.appendChild(indicatorsContainer);
                    }
                    
                    if (timestampedPaths.length > 1) {
                        indicatorsContainer.innerHTML = timestampedPaths.map((_, index) => 
                            `<span class="indicator ${index === 0 ? 'active' : ''}" data-index="${index}"></span>`
                        ).join('');
                        
                        // Показать навигацию если есть несколько изображений
                        let prevNav = carousel.querySelector('.image-nav.prev');
                        let nextNav = carousel.querySelector('.image-nav.next');
                        
                        if (!prevNav || !nextNav) {
                            // Создаем навигацию, если её нет
                            prevNav = document.createElement('div');
                            prevNav.className = 'image-nav prev';
                            prevNav.textContent = '‹';
                            prevNav.onclick = () => changeImageWithSlide(productId, -1);
                            
                            nextNav = document.createElement('div');
                            nextNav.className = 'image-nav next';
                            nextNav.textContent = '›';
                            nextNav.onclick = () => changeImageWithSlide(productId, 1);
                            
                            carousel.appendChild(prevNav);
                            carousel.appendChild(nextNav);
                        }
                        
                        prevNav.style.display = 'flex';
                        nextNav.style.display = 'flex';
                        prevNav.style.opacity = '1';
                        nextNav.style.opacity = '1';
                        prevNav.style.visibility = 'visible';
                        nextNav.style.visibility = 'visible';
                        prevNav.style.zIndex = '200';
                        nextNav.style.zIndex = '200';
                    } else {
                        indicatorsContainer.innerHTML = '';
                        // Скрыть навигацию если изображение одно
                        const prevNav = carousel.querySelector('.image-nav.prev');
                        const nextNav = carousel.querySelector('.image-nav.next');
                        if (prevNav && nextNav) {
                            prevNav.style.display = 'none';
                            nextNav.style.display = 'none';
                        }
                    }
                    
                    // Сохранить пути для changeImage функции
                    window[`${productId}-${selectedColor}`] = timestampedPaths;
                }
                
                console.log(`✅ Обновлены изображения для ${brandModel} цвета ${selectedColor}`);
                
            } catch (error) {
                console.error(`❌ Ошибка загрузки изображений для ${brandModel} цвета ${selectedColor}:`, error);
                const carousel = container.querySelector('.product-image-carousel') || container.querySelector('.product-image-carousel-detail');
                if (carousel) {
                    // Скрыть loading placeholder
                    const placeholder = carousel.querySelector('.loading-placeholder');
                    if (placeholder) {
                        placeholder.style.display = 'none';
                    }
                    
                    // Добавить fallback изображение (просто placeholder)
                    const mainImg = carousel.querySelector('.product-img') || carousel.querySelector('.product-img-detail');
                    if (mainImg) {
                        mainImg.src = `/static/images/products/placeholder.jpg?v=${Date.now()}`;
                    } else {
                        // Показать placeholder если нет изображения
                        const placeholder = carousel.querySelector('.loading-placeholder');
                        if (placeholder) {
                            placeholder.style.display = 'block';
                            placeholder.innerHTML = '<img src="/static/images/logo.jpg" alt="Нет фото">';
                        }
                    }
                }
            }
        }
        
        // Показать загрузчики для всех изображений при загрузке страницы
        function showLoadingPlaceholders() {
            console.log('🔄 Показываем загрузчики для всех изображений...');
            // Если активен общий лоадер страницы, не дублируем загрузчики картинок
            if (document.querySelector('.page-loading')) {
                return;
            }
            
            document.querySelectorAll('.product-img').forEach(img => {
                const placeholder = img.nextElementSibling;
                if (placeholder && placeholder.classList.contains('loading-placeholder')) {
                    // Скрыть изображение и показать загрузчик
                    img.style.opacity = '0';
                    placeholder.style.display = 'flex';
                    
                    // Проверить, загружено ли изображение
                    if (img.complete && img.naturalHeight !== 0) {
                        // Изображение уже загружено, показать его
                        setTimeout(() => {
                            img.style.opacity = '1';
                            placeholder.style.display = 'none';
                        }, 100);
                    } else {
                        // Изображение еще загружается, добавить обработчик
                        img.onload = function() {
                            this.style.opacity = '1';
                            this.nextElementSibling.style.display = 'none';
                        };
                    }
                }
            });
        }
        
        // Initialize variant buttons event listeners
        function initVariantButtons() {
            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('variant-btn')) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    const buttonElement = event.target;
                    const productId = buttonElement.closest('.product-variants').dataset.productId;
                    
                    toggleVariant(productId, buttonElement);
                }
            });
        }
        
        // Call initVariantButtons when page loads
        initVariantButtons();
        
        // Function to get CSS color based on color name
        function getColorStyle(colorName) {
            if (!colorName || colorName === 'Default' || colorName === 'Не указан') {
                return '#E9ECEF'; // Дефолтный серый цвет
            }
            
            // Отладочный вывод для Titanium Desert
            if (colorName.toLowerCase().includes('titanium') || colorName.toLowerCase().includes('desert')) {
                console.log('🔍 getColorStyle вызвана для:', colorName, 'тип:', typeof colorName);
            }
            
            const colorMap = {
                // iPhone colors
                'ultramarine': '#a4b6f6', // Ультрамариновый
                'black': '#000000', 'white': '#FFFFFF', 'pink': '#FFB6C1', // Светло розовый
                'titanium-black': '#000000', // Чисто черный
                'titanium-white': '#FFFFFF', 'titanium-natural': '#979792', 'titanium-desert': '#d0b6a8',
                // Дублируем для разных вариантов написания
                'Titanium Desert': '#d0b6a8', 'TITANIUM-DESERT': '#d0b6a8',
                'deep-blue': '#1B2951', 'cosmic-orange': '#FF6B35', 'silver': '#E8E8E8', // Светло серебристый
                'teal': '#20B2AA', // Бирюзовый

                // New colors from DB
                'space black': '#0b0b0b',
                'starlight': '#F5E7D3',
                'midnight': '#0a0f1f',
                'sky blue': '#87CEEB',
                'mist blue': '#9BB7D4',
                'sage': '#A3B18A',
                'lavender': '#B7A1E3',
                'light gold': '#E6C87A',
                'cloud white': '#F9FAFB',
                'blue': '#2563EB',
                'green': '#059669',
                
                // MacBook colors
                'space-gray': '#7F7F7F', 'silver': '#C0C0C0',
                
                // iPad colors
                'black': '#000000', 'blue': '#2563EB',
                
                // Other common colors
                'gray': '#6B7280', 'grey': '#6B7280', 'green': '#059669',
                'purple': '#7C3AED', 'gold': '#F59E0B', 'red': '#DC2626', 'orange': '#EA580C',
                'camouflage': '#556B2F' // Камуфляжный цвет (оливково-зеленый)
            };
            
            // Проверяем точное совпадение
            if (colorMap[colorName.toLowerCase()]) {
                const result = colorMap[colorName.toLowerCase()];
                if (colorName.toLowerCase().includes('titanium') || colorName.toLowerCase().includes('desert')) {
                    console.log('✅ Найдено точное совпадение:', colorName.toLowerCase(), '->', result);
                }
                return result;
            }
            
            // Проверяем частичное совпадение (для составных цветов как "titanium-black")
            for (const [key, color] of Object.entries(colorMap)) {
                if (colorName.toLowerCase().includes(key)) {
                    if (colorName.toLowerCase().includes('titanium') || colorName.toLowerCase().includes('desert')) {
                        console.log('✅ Найдено частичное совпадение:', key, 'для', colorName, '->', color);
                    }
                    return color;
                }
            }
            
            return '#6B7280'; // Цвет по умолчанию (серый)
        }
        
        // Function to determine text color based on background color
        function getTextColor(backgroundColor) {
            // Конвертируем hex в RGB
            const hex = backgroundColor.slice(1);
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            
            // Вычисляем яркость
            const brightness = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            
            return brightness > 128 ? '#000000' : '#FFFFFF';
        }
        
        // Function to get English label for color
        function getColorLabel(colorName) {
            if (!colorName || colorName === 'Default' || colorName === 'Не указан') {
                return 'Default';
            }
            
            const colorLabels = {
                'ultramarine': 'Ultramarine',
                'black': 'Black',
                'white': 'White',
                'pink': 'Pink',
                'yellow': 'Yellow',
                'teal': 'Teal',
                'titanium-black': 'Titanium Black',
                'titanium-white': 'Titanium White',
                'titanium-natural': 'Titanium Natural',
                'titanium-desert': 'Titanium Desert',
                'deep-blue': 'Deep Blue',
                'cosmic-orange': 'Cosmic Orange',
                'silver': 'Silver',
                'space-gray': 'Space Gray',
                'blue': 'Blue',
                'gray': 'Gray',
                'grey': 'Grey',
                'green': 'Green',
                'purple': 'Purple',
                'gold': 'Gold',
                'red': 'Red',
                'orange': 'Orange',

                // New labels
                'space black': 'Space Black',
                'starlight': 'Starlight',
                'midnight': 'Midnight',
                'sky blue': 'Sky Blue',
                'mist blue': 'Mist Blue',
                'sage': 'Sage',
                'lavender': 'Lavender',
                'light gold': 'Light Gold',
                'cloud white': 'Cloud White'
            };
            
            return colorLabels[colorName.toLowerCase()] || colorName;
        }
        
        // Helpers to sync loaders
        function isPageLoadingActive() {
            return !!document.querySelector('.page-loading');
        }
        async function waitForPageLoaderToHide(timeoutMs = 5000) {
            const start = performance.now();
            while (isPageLoadingActive()) {
                await new Promise(r => setTimeout(r, 50));
                if (performance.now() - start > timeoutMs) break;
            }
        }
        
        // Initialize variants and colors for all cards
        // Функция для загрузки изображения первого цвета сразу при создании карточки
        async function loadFirstColorImage(productId, brand, model) {
            try {
                console.log(`🖼️ Загружаем изображение первого цвета для ${brand} ${model}...`);
                
                // Определяем model_key
                const modelKey = getModelKey(`${brand} ${model}`);
                if (!modelKey) {
                    console.warn(`Не удалось определить model_key для ${brand} ${model}`);
                    return;
                }
                
                // Определяем цвет по умолчанию (обычно Black или первый доступный)
                const defaultColors = ['Black', 'black', 'White', 'white', 'Space Black', 'space-black'];
                
                for (const colorName of defaultColors) {
                    try {
                        // Пытаемся загрузить изображение для этого цвета
                        const response = await fetch(`/product-images/${modelKey}/${encodeURIComponent(colorName)}`);
                        
                        if (response.ok) {
                            const imageData = await response.json();
                            const timestampedPaths = imageData.image_paths.map(img => `${img}?v=${Date.now()}`);
                            
                            // Обновляем изображение в карточке
                            const carousel = document.querySelector(`[data-product-id="${productId}"]`);
                            if (carousel) {
                                const placeholder = carousel.querySelector('.loading-placeholder');
                                if (placeholder) {
                                    placeholder.style.display = 'none';
                                }
                                
                                // Создаем изображение
                                const mainImg = document.createElement('img');
                                mainImg.className = 'product-img';
                                mainImg.alt = `${brand} ${model}`;
                                mainImg.src = timestampedPaths[0];
                                mainImg.style.opacity = '0';
                                mainImg.onerror = 'this.style.display="none"; this.nextElementSibling.style.display="block";';
                                
                                carousel.insertBefore(mainImg, carousel.querySelector('.image-indicators'));
                                
                                // Плавное появление
                                setTimeout(() => {
                                    mainImg.style.opacity = '1';
                                }, 100);
                                
                                // Настройка карусели если есть несколько изображений
                                if (timestampedPaths.length > 1) {
                                    const indicatorsContainer = carousel.querySelector('.image-indicators');
                                    indicatorsContainer.innerHTML = timestampedPaths.map((_, index) => 
                                        `<span class="indicator ${index === 0 ? 'active' : ''}" data-index="${index}"></span>`
                                    ).join('');
                                    
                                    const prevNav = carousel.querySelector('.image-nav.prev');
                                    const nextNav = carousel.querySelector('.image-nav.next');
                                    if (prevNav && nextNav) {
                                        prevNav.style.display = 'block';
                                        nextNav.style.display = 'block';
                                    }
                                    
                                    // Сохранить для функции changeImage
                                    window[`${productId}-${colorName}`] = timestampedPaths;
                                }
                            }
                            
                            console.log(`✅ Загружено изображение для ${brand} ${model} цвета ${colorName}`);
                            break; // Успешно загрузили, выходим из цикла
                            
                        }
                    } catch (error) {
                        // Цвет не найден, пробуем следующий
                        continue;
                    }
                }
                
            } catch (error) {
                console.warn(`❌ Ошибка загрузки первого изображения для товара ${productId}:`, error);
            }
        }

        // Функция для загрузки изображений по умолчанию для первого цвета
        async function loadDefaultImages() {
            console.log('🖼️ Загружаем изображения по умолчанию для всех товаров...');

            // Дождаться скрытия глобального лоадера, чтобы не дублировать индикаторы
            await waitForPageLoaderToHide();
            
            // Принудительно применяем стили ко всем изображениям (карточки и детальная страница)
            document.querySelectorAll('.product-img').forEach(img => {
                img.style.cssText = 'width: 90%; height: 90%; object-fit: contain; border-radius: 15px; margin: 5%; transition: opacity 0.2s ease-in-out;';
            });
            
            // Применяем стили для изображений на детальной странице
            document.querySelectorAll('.product-img-detail').forEach(img => {
                img.style.cssText = 'max-width: 100%; max-height: 100%; object-fit: contain; transition: opacity 0.3s ease;';
            });
            
            // Сначала показать загрузчики для всех изображений (только если нет глобального)
            if (!isPageLoadingActive()) {
            showLoadingPlaceholders();
            }
            
            // Принудительно инициализируем свайп для всех каруселей
            setTimeout(() => {
                addSwipeSupport();
            }, 200);
            
            for (const card of document.querySelectorAll('.product-card')) {
                const colorButton = card.querySelector('.variant-btn.color-btn.active');
                if (colorButton) {
                    const productId = card.querySelector('.product-variants')?.dataset.productId || 
                                     card.querySelector('[data-product-id]')?.dataset.productId;
                    
                    const selectedColor = colorButton.dataset.color || colorButton.dataset.value;
                    
                    if (productId && selectedColor) {
                        try {
                            // Ждем полной загрузки нужного изображения перед показом
                            await updateProductImage(productId, selectedColor, { waitForLoad: true });
                        } catch (error) {
                            console.warn(`Ошибка загрузки изображения для товара ${productId} цвета ${selectedColor}:`, error);
                        }
                    }
                }
            }
            
            console.log('✅ Завершена загрузка изображений по умолчанию');
        }

        async function initializeDefaultColors() {
            // Загрузить варианты для всех товаров через новый API
            for (const card of document.querySelectorAll('.product-card')) {
                const variantsElement = card.querySelector('[data-model]');
                if (variantsElement) {
                    const model = variantsElement.dataset.model;
                    try {
                        // Загрузить варианты через новый API
                        await loadVariantsForModel(card, model);
                    } catch (error) {
                        console.warn('Ошибка загрузки вариантов для модели:', model, error);
                    }
                }
            }
        }
        
        // Новая функция для загрузки вариантов модели
        async function loadVariantsForModel(productCard, model) {
            console.log('🔄 Загружаем варианты для модели:', model);
            
            const variantsElement = productCard.querySelector('.product-variants');
            if (!variantsElement) return;
            
            try {
                const response = await fetch(`/products/${encodeURIComponent(model)}/variants`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('✅ Загружены варианты:', data);
                
                // Очищаем элемент вариантов
                variantsElement.innerHTML = '';
                
                if (data.variants && data.variants.length > 0) {
                    // Группируем варианты по цветам
                    const colorGroups = {};
                    
                    data.variants.forEach(variant => {
                        const color = variant.color && variant.color.trim() !== '' ? variant.color : null;
                        if (color) { // Только добавляем варианты с реальными цветами
                            if (!colorGroups[color]) {
                                colorGroups[color] = [];
                            }
                            colorGroups[color].push(variant);
                        }
                    });
                    
                    console.log('🎨 Группы цветов:', Object.keys(colorGroups));
                    
                    // Создаем красивые цветные кнопки цветов
                    const colorButtons = Object.keys(colorGroups).map(color => {
                        const variants = colorGroups[color];
                        const activeClass = Object.keys(colorGroups).indexOf(color) === 0 ? 'active' : '';
                        
                        // Создаем красивую цветную кнопку
                        const colorStyle = getColorStyle(color);
                        const label = getColorLabel(color);
                        const textColor = getTextColor(colorStyle);
                        
                        return `
                            <button class="variant-btn color-btn ${activeClass}" 
                                    data-color="${color}" 
                                    data-model="${model}"
                                    data-type="color"
                                    data-tooltip="${label}"
                                    style="background-color: ${(color && color.toLowerCase().includes('titanium') && color.toLowerCase() && color.toLowerCase().includes('desert')) ? '#d0b6a8' : colorStyle}; color: ${textColor}; border-color: ${(color && color.toLowerCase().includes('titanium') && color.toLowerCase().includes('desert')) ? '#d0b6a8' : colorStyle};">
                            </button>
                        `;
                    }).join('');
                    
                    // Создаем красивые кнопки памяти (только с реальными значениями)
                    const memoryOptions = [...new Set(data.variants
                        .map(v => v.memory)
                        .filter(memory => memory && memory.trim() !== ''))];
                    
                    // Функция для сортировки памяти: 128, 256, 512, 1TB, 2TB
                    const sortMemory = (a, b) => {
                        const parseMemory = (mem) => {
                            if (!mem) return 0;
                            const memStr = mem.toString().toUpperCase().trim();
                            // Обработка TB
                            if (memStr.includes('TB')) {
                                const num = parseFloat(memStr);
                                return num * 1000; // 1TB = 1000, 2TB = 2000
                            }
                            // Обработка GB
                            if (memStr.includes('GB')) {
                                return parseFloat(memStr);
                            }
                            // Если просто число, предполагаем GB
                            return parseFloat(memStr);
                        };
                        
                        return parseMemory(a) - parseMemory(b);
                    };
                    
                    // Сортируем варианты памяти
                    memoryOptions.sort(sortMemory);
                    
                    const memoryButtons = memoryOptions.map((memory, index) => {
                        const activeClass = index === 0 ? 'active' : '';
                        return `
                            <button class="variant-btn memory-btn ${activeClass}" 
                                    data-memory="${memory}" 
                                    data-model="${model}"
                                    data-type="memory">
                                ${memory}
                            </button>
                        `;
                    }).join('');
                    
                    // Создаем красивые кнопки RAM (только с реальными значениями) - для ноутбуков
                    const ramOptions = [...new Set(data.variants
                        .map(v => v.ram)
                        .filter(ram => ram && ram.trim() !== ''))];
                    const ramButtons = ramOptions.map((ram, index) => {
                        const activeClass = index === 0 ? 'active' : '';
                        return `
                            <button class="variant-btn ram-btn ${activeClass}" 
                                    data-ram="${ram}" 
                                    data-model="${model}"
                                    data-type="ram">
                                ${ram}
                            </button>
                        `;
                    }).join('');
                    
                    // Создаем красивые кнопки SIM (только с реальными значениями)
                    const simOptions = [...new Set(data.variants
                        .map(v => v.sim_type)
                        .filter(sim => sim && sim.trim() !== ''))];
                    // Маппинг для отображения типов SIM
                    const simLabels = {
                        'Single SIM': 'SIM + eSIM',
                        'eSIM': 'Dual eSIM',
                        'Dual SIM': 'Dual SIM'
                    };
                    
                    const simButtons = simOptions.map((sim, index) => {
                        const activeClass = index === 0 ? 'active' : '';
                        const displayLabel = simLabels[sim] || sim;
                        return `
                            <button class="variant-btn sim-btn ${activeClass}" 
                                    data-sim="${sim}" 
                                    data-model="${model}"
                                    data-type="sim">
                                ${displayLabel}
                            </button>
                        `;
                    }).join('');
                    
                    // Создаем HTML только для элементов с вариантами
                    let htmlContent = '';
                    
                    if (colorButtons) {
                        htmlContent += `
                            <div class="variant-group color-group">
                                <label>Цвет:</label>
                                <div class="variant-buttons">
                                    ${colorButtons}
                                </div>
                            </div>
                        `;
                    }
                    
                    if (memoryButtons) {
                        htmlContent += `
                            <div class="variant-group memory-group">
                                <label>Память:</label>
                                <div class="variant-buttons">
                                    ${memoryButtons}
                                </div>
                            </div>
                        `;
                    }
                    
                    if (ramButtons) {
                        htmlContent += `
                            <div class="variant-group ram-group">
                                <label>RAM:</label>
                                <div class="variant-buttons">
                                    ${ramButtons}
                                </div>
                            </div>
                        `;
                    }
                    
                    if (simButtons) {
                        htmlContent += `
                            <div class="variant-group sim-group">
                                <label>Конфигурация SIM:</label>
                                <div class="variant-buttons">
                                    ${simButtons}
                                </div>
                            </div>
                        `;
                    }
                    
                    
                    variantsElement.innerHTML = htmlContent;
                    
                    // Добавляем обработчики событий для новых кнопок
                    addVariantEventListeners(model, colorGroups);
                    
                    // Обновляем цену для первого варианта
                    updateVariantPrice(model, colorGroups);
                    
                } else {
                    variantsElement.innerHTML = '<div class="no-variants">Варианты не найдены</div>';
                }
                
                    } catch (error) {
                console.error('Ошибка загрузки вариантов:', error);
                variantsElement.innerHTML = '<div class="error">Ошибка загрузки вариантов</div>';
            }
        }
        
        // Функция для добавления обработчиков событий
        function addVariantEventListeners(model, colorGroups) {
            // Обработчик изменения цвета
            document.querySelectorAll(`[data-model="${model}"][data-type="color"]`).forEach(button => {
                button.addEventListener('click', function() {
                    // Убираем активный класс с других кнопок цвета
                    document.querySelectorAll(`[data-model="${model}"][data-type="color"]`).forEach(btn => btn.classList.remove('active'));
                    // Добавляем активный класс к нажатой кнопке
                    this.classList.add('active');
                    
                    // Обновляем цену при изменении варианта
                    updateVariantPrice(model, colorGroups);
                    
                    // Дополнительное обновление изображений для цвета
                    const selectedColor = this.dataset.color;
                    const productCard = this.closest('.product-card');
                    if (productCard) {
                        // Получаем product-id из карточки
                        const productIdMatch = productCard.outerHTML.match(/data-product-id="(\d+)"/);
                        if (productIdMatch) {
                            const productId = productIdMatch[1];
                            updateProductImage(productId, selectedColor);
                        }
                    }
                });
            });
            
            // Обработчик изменения памяти
            document.querySelectorAll(`[data-model="${model}"][data-type="memory"]`).forEach(button => {
                button.addEventListener('click', function() {
                    // Убираем активный класс с других кнопок памяти
                    document.querySelectorAll(`[data-model="${model}"][data-type="memory"]`).forEach(btn => btn.classList.remove('active'));
                    // Добавляем активный класс к нажатой кнопке
                    this.classList.add('active');
                    
                    // Обновляем цену при изменении варианта
                    updateVariantPrice(model, colorGroups);
                });
            });
            
            // Обработчик изменения RAM
            document.querySelectorAll(`[data-model="${model}"][data-type="ram"]`).forEach(button => {
                button.addEventListener('click', function() {
                    // Убираем активный класс с других кнопок RAM
                    document.querySelectorAll(`[data-model="${model}"][data-type="ram"]`).forEach(btn => btn.classList.remove('active'));
                    // Добавляем активный класс к нажатой кнопке
                    this.classList.add('active');
                    
                    // Обновляем цену при изменении варианта
                    updateVariantPrice(model, colorGroups);
                });
            });
            
            // Обработчик изменения SIM
            document.querySelectorAll(`[data-model="${model}"][data-type="sim"]`).forEach(button => {
                button.addEventListener('click', function() {
                    // Убираем активный класс с других кнопок SIM
                    document.querySelectorAll(`[data-model="${model}"][data-type="sim"]`).forEach(btn => btn.classList.remove('active'));
                    // Добавляем активный класс к нажатой кнопке
                    this.classList.add('active');
                    
                    // Обновляем цену при изменении варианта
                    updateVariantPrice(model, colorGroups);
                });
            });
        }
        
        // Функция для обновления цены выбранного варианта
        async function updateVariantPrice(model, colorGroups) {
            // Получаем активные кнопки вариантов (могут отсутствовать для некоторых типов товаров)
            const activeColorButton = document.querySelector(`[data-model="${model}"][data-type="color"].active`);
            const activeMemoryButton = document.querySelector(`[data-model="${model}"][data-type="memory"].active`);
            const activeRamButton = document.querySelector(`[data-model="${model}"][data-type="ram"].active`);
            const activeSimButton = document.querySelector(`[data-model="${model}"][data-type="sim"].active`);
            
            // Если нет ни одного варианта, не обновляем цену
            if (!activeColorButton && !activeMemoryButton && !activeRamButton && !activeSimButton) {
                console.log('⚠️ Нет активных вариантов для модели:', model);
                return;
            }
            
            // Получаем выбранные значения (могут быть undefined для некоторых товаров)
            const selectedColor = activeColorButton?.dataset.color || '';
            const selectedMemory = activeMemoryButton?.dataset.memory || '';
            const selectedRam = activeRamButton?.dataset.ram || '';
            const selectedSim = activeSimButton?.dataset.sim || '';
            
            // Если есть colorGroups, используем их для поиска варианта
            if (colorGroups && Object.keys(colorGroups).length > 0) {
                // Находим соответствующий вариант
                const variants = colorGroups[selectedColor] || [];
                const matchedVariant = variants.find(v => {
                    // Сравниваем только те поля, которые есть
                    // Для ноутбуков может быть disk вместо memory, для телефонов - memory
                    const memoryMatch = !selectedMemory || 
                        v.memory === selectedMemory || 
                        v.disk === selectedMemory ||
                        v.ssd === selectedMemory;
                    // RAM для ноутбуков
                    const ramMatch = !selectedRam || !v.ram || v.ram === selectedRam;
                    // SIM только для телефонов, для ноутбуков может отсутствовать
                    const simMatch = !selectedSim || !v.sim_type || v.sim_type === selectedSim;
                    return memoryMatch && ramMatch && simMatch;
                });
                
                // Если точное соответствие не найдено, берем первый доступный вариант этого цвета
                const fallbackVariant = matchedVariant || variants[0];
                
                if (fallbackVariant && fallbackVariant.price) {
                    // Обновляем основную цену в карточке товара
                    const productCard = document.querySelector(`[data-model="${model}"]`)?.closest('.product-card');
                    const currentPriceElement = productCard?.querySelector('.current-price');
                    
                    if (currentPriceElement) {
                        const price = Math.round(fallbackVariant.price).toLocaleString();
                        currentPriceElement.textContent = `${price} ₽`;
                        console.log('💱 Обновлена цена из colorGroups:', fallbackVariant.price, '₽');
                    }
                    
                    // Обновляем старую цену и скидку
                    const priceContainer = productCard?.querySelector('.product-price');
                    if (priceContainer) {
                        // Удаляем старые элементы old-price и discount
                        const oldOldPrice = priceContainer.querySelector('.old-price');
                        const oldDiscount = priceContainer.querySelector('.discount');
                        if (oldOldPrice) oldOldPrice.remove();
                        if (oldDiscount) oldDiscount.remove();
                        
                        // Добавляем новые элементы, если есть old_price и discount
                        if (fallbackVariant.old_price && fallbackVariant.old_price > fallbackVariant.price) {
                            const oldPriceSpan = document.createElement('span');
                            oldPriceSpan.className = 'old-price';
                            oldPriceSpan.textContent = `${Math.round(fallbackVariant.old_price).toLocaleString()} ₽`;
                            currentPriceElement.after(oldPriceSpan);
                        }
                        
                        if (fallbackVariant.discount_percentage && fallbackVariant.discount_percentage > 0) {
                            const discountSpan = document.createElement('span');
                            discountSpan.className = 'discount';
                            discountSpan.textContent = `-${Math.round(fallbackVariant.discount_percentage)}%`;
                            priceContainer.appendChild(discountSpan);
                        }
                    }
                    
                    // Обновляем бейдж "Осталась 1 шт" на основе stock выбранного варианта
                    const variantsElement = productCard?.querySelector('.product-variants');
                    const productId = variantsElement?.dataset.productId || productCard?.querySelector('[data-product-id]')?.dataset.productId;
                    if (productId && fallbackVariant.stock !== undefined) {
                        updateLowStockBadge(productId, fallbackVariant.stock);
                    }
                    
                    // Изображения обновляются только при изменении цвета, не при изменении других вариантов
                    return;
                }
            }
            
            // Если colorGroups не помогли, загружаем варианты напрямую из API
            try {
                const response = await fetch(`/products/${encodeURIComponent(model)}/variants`);
                if (!response.ok) {
                    console.error('❌ Ошибка загрузки вариантов:', response.status);
                    return;
                }
                
                const data = await response.json();
                if (!data.variants || data.variants.length === 0) {
                    console.log('⚠️ Варианты не найдены для модели:', model);
                    return;
                }
                
                // Находим вариант, соответствующий выбранным параметрам
                const matchedVariant = data.variants.find(variant => {
                    const colorMatch = !selectedColor || variant.color === selectedColor;
                    // Для ноутбуков может быть disk вместо memory, для телефонов - memory
                    const memoryMatch = !selectedMemory || 
                        variant.memory === selectedMemory || 
                        variant.disk === selectedMemory ||
                        variant.ssd === selectedMemory;
                    // RAM для ноутбуков
                    const ramMatch = !selectedRam || !variant.ram || variant.ram === selectedRam;
                    // SIM только для телефонов, для ноутбуков может отсутствовать
                    const simMatch = !selectedSim || !variant.sim_type || variant.sim_type === selectedSim;
                    return colorMatch && memoryMatch && ramMatch && simMatch;
                });
                
                // Если точное соответствие не найдено, берем первый вариант с подходящим цветом
                let finalVariant = matchedVariant;
                if (!finalVariant && selectedColor) {
                    finalVariant = data.variants.find(v => v.color === selectedColor);
                }
                // Если и это не помогло, берем первый доступный вариант
                if (!finalVariant) {
                    finalVariant = data.variants[0];
                }
                
                if (finalVariant && finalVariant.price) {
                    // Обновляем основную цену в карточке товара
                    const productCard = document.querySelector(`[data-model="${model}"]`)?.closest('.product-card');
                    const currentPriceElement = productCard?.querySelector('.current-price');
                    
                    if (currentPriceElement) {
                        const price = Math.round(finalVariant.price).toLocaleString();
                        currentPriceElement.textContent = `${price} ₽`;
                        console.log('💱 Обновлена цена из API:', finalVariant.price, '₽', 'для варианта:', finalVariant.sku);
                    }
                    
                    // Обновляем старую цену и скидку
                    const priceContainer = productCard?.querySelector('.product-price');
                    if (priceContainer) {
                        // Удаляем старые элементы old-price и discount
                        const oldOldPrice = priceContainer.querySelector('.old-price');
                        const oldDiscount = priceContainer.querySelector('.discount');
                        if (oldOldPrice) oldOldPrice.remove();
                        if (oldDiscount) oldDiscount.remove();
                        
                        // Добавляем новые элементы, если есть old_price и discount
                        if (finalVariant.old_price && finalVariant.old_price > finalVariant.price) {
                            const oldPriceSpan = document.createElement('span');
                            oldPriceSpan.className = 'old-price';
                            oldPriceSpan.textContent = `${Math.round(finalVariant.old_price).toLocaleString()} ₽`;
                            currentPriceElement.after(oldPriceSpan);
                        }
                        
                        if (finalVariant.discount_percentage && finalVariant.discount_percentage > 0) {
                            const discountSpan = document.createElement('span');
                            discountSpan.className = 'discount';
                            discountSpan.textContent = `-${Math.round(finalVariant.discount_percentage)}%`;
                            priceContainer.appendChild(discountSpan);
                        }
                    }
                    
                    // Обновляем бейдж "Осталась 1 шт" на основе stock выбранного варианта
                    const variantsElement = productCard?.querySelector('.product-variants');
                    const productId = variantsElement?.dataset.productId || productCard?.querySelector('[data-product-id]')?.dataset.productId;
                    if (productId && finalVariant.stock !== undefined) {
                        updateLowStockBadge(productId, finalVariant.stock);
                    }
                    
                    // Изображения обновляются только при изменении цвета, не при изменении других вариантов
                } else {
                    console.warn('⚠️ Не найден вариант с ценой для модели:', model, 'выбранные параметры:', {selectedColor, selectedMemory, selectedRam, selectedSim});
                }
            } catch (error) {
                console.error('❌ Ошибка при обновлении цены:', error);
            }
        }
        
        // Update low stock badge based on selected variant stock
        function updateLowStockBadge(productId, stock) {
            const badge = document.getElementById(`low-stock-badge-${productId}`);
            if (badge) {
                if (stock === 1) {
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        async function createColorButtonsForProduct(productCard, productId) {
            console.log('🎨 Начинаем создание кнопок цветов для товара', productId);
            
            // Получить модель товара из data-model атрибута
            const variantsElement = productCard.querySelector('.product-variants');
            if (!variantsElement || !variantsElement.dataset.model) {
                console.log('❌ Элемент с моделью не найден');
                return;
            }
            
            const brandModel = variantsElement.dataset.model; // "Apple iPhone 16 Pro"
            console.log('📱 Найдена модель:', brandModel);
            
            // Получить цветовую схему из API с полной информацией о цветах
            const modelKey = getModelKey(brandModel);
            console.log('🔑 Определен ключ модели:', modelKey);
            let colorsData = [];

            if (modelKey) {
                try {
                    const response = await fetch(`/color-schemes/${modelKey}`);
                    if (response.ok) {
                        const data = await response.json();
                        // Извлекаем поля value из объектов цветов
                        colorsData = data.colors.map(color => color.value);
                        console.log('✅ Загружены цвета:', colorsData);
                        console.log('🧪 Тест извлечения цвета:', colorsData[0], typeof colorsData[0]);
                    } else {
                        console.warn(`Цветовая схема не найдена для ${modelKey}`);
                    }
                } catch (error) {
                    console.warn('Ошибка получения цветовой схемы:', error);
                }
            }

            // Если не удалось получить цвета из API, использовать fallback
            if (colorsData.length === 0) {
                colorsData = ['black'];
            }

            // Найти контейнер кнопок цветов
            const variantGroups = productCard.querySelectorAll('.variant-group');
            let colorContainer = null;
            for (const group of variantGroups) {
                const label = group.querySelector('label');
                if (label && label.textContent === 'Цвет:') {
                    colorContainer = group.querySelector('.variant-buttons');
                    break;
                }
            }
            if (!colorContainer) {
                console.log('❌ Контейнер цветов не найден');
                return;
            }
            
            console.log('🎨 Найден контейнер цветов, данные цветов:', colorsData);
            
            // Тестируем функции на известных цветах
            console.log('🧪 Тестирование функций цветов:');
            console.log('titanium-black ->', getColorStyle('titanium-black'));
            console.log('titanium-desert ->', getColorStyle('titanium-desert'));
            console.log('Titanium Desert ->', getColorStyle('Titanium Desert'));
            console.log('black ->', getColorStyle('black'));
            console.log('white ->', getColorStyle('white'));
            console.log('deep-blue ->', getColorStyle('deep-blue'));
            
            // Создать HTML и добавить цветные стили к кнопкам цветов
            const colorButtonsHTML = colorsData.map((colorValue, index) => {
                const isActive = index === 0 ? 'active' : '';
                
                // Убедимся что colorValue - это строка, а не объект
                const actualColorValue = typeof colorValue === 'string' ? colorValue : colorValue.value || colorValue.toString();
                console.log(`🎨 Обрабатываем цвет ${index}:`, { colorValue, actualColorValue, type: typeof colorValue });
                
                // Преобразовать название цвета в папку: "titanium-black" -> "titanium-black"
                const folderName = actualColorValue.toLowerCase().replace(/\s+/g, '_');
                const colorStyle = getColorStyle(actualColorValue);
                const label = getColorLabel(actualColorValue);
                const textColor = getTextColor(colorStyle);
                
                console.log(`🎨 Создаю кнопку для цвета ${actualColorValue}:`, { colorStyle, label, textColor });
                
                return `<button class="variant-btn color-btn ${isActive}" data-type="color" data-value="${actualColorValue}" data-color-folder="${folderName}" data-tooltip="${label}" style="background-color: ${(actualColorValue && actualColorValue.toLowerCase().includes('titanium') && actualColorValue.toLowerCase().includes('desert')) ? '#d0b6a8' : colorStyle};"></button>`;
            }).join('');
            
            console.log('🎨 Создан HTML кнопок:', colorButtonsHTML);
            
            // Заменить содержимое контейнера
            colorContainer.innerHTML = colorButtonsHTML;
            console.log('✅ Цветовые кнопки заменены успешно');
            
            // Переиниторизовать обработчики событий
            initVariantButtons(productCard.querySelector('.product-variants'));
        }
        
        async function createVariantsForProduct(productCard, productId) {
            // Получить модель товара из data-model атрибута
            const variantsElement = productCard.querySelector('.product-variants');
            if (!variantsElement || !variantsElement.dataset.model) return;
            
            const brandModel = variantsElement.dataset.model; // "Apple iPhone 16 Pro"
            
            // Получить схему вариантов из API
            const modelKey = getModelKey(brandModel);
            let variantsData = {};
            
            if (modelKey) {
                try {
                    const response = await fetch(`/variant-schemes/${modelKey}`);
                    if (response.ok) {
                        const data = await response.json();
                        variantsData = data.variants;
                    } else {
                        console.warn(`Схема вариантов не найдена для ${modelKey}`);
                    }
                } catch (error) {
                    console.warn('Ошибка получения схемы вариантов:', error);
                }
            }
            
            // Найти контейнер вариантов
            const variantsContainer = productCard.querySelector('.product-variants');
            if (!variantsContainer) return;
            
            // Если нет вариантов из API, создать базовый набор
            if (Object.keys(variantsData).length === 0) {
                variantsData = {
                    color: ["Black"],
                    capacity: ["128GB"]
                };
            }
            
            // Создать HTML для всех вариантов
            let variantsHtml = '';
            
            // Обработать каждый тип варианта
            for (const [variantType, options] of Object.entries(variantsData)) {
                if (variantType === 'color' && (options === 'dynamic' || Array.isArray(options))) {
                    // Для цветов используем динамическую загрузку из color schemes
                    variantsHtml += `
                        <div class="variant-group">
                            <label>Цвет:</label>
                            <div class="variant-buttons">
                                <!-- Цвета будут загружены через createColorButtonsForProduct -->
                                <div class="loading">Загрузка цветов...</div>
                            </div>
                        </div>
                    `;
                    continue;
                }
                
                // Определить метку для типа варианта
                const labels = {
                    memory: 'Память',
                    sim: 'Конфигурация SIM',
                    screen: 'Диагональ',
                    ram: 'RAM',
                    ssd: 'SSD',
                    color: 'Цвет',
                    capacity: 'Объем'
                };
                
                const label = labels[variantType] || variantType;
                
                // Создать кнопки для опций
                const buttons = Array.isArray(options) ? options : [];
                const buttonsHtml = buttons.map((option, index) => {
                    const isActive = index === 0 ? 'active' : '';
                    const dataAttr = variantType === 'color' ? `data-color-folder="${option.toLowerCase()}"` : '';
                    return `<button class="variant-btn ${isActive}" data-type="${variantType}" data-value="${option}" ${dataAttr}>${option}</button>`;
                }).join('');
                
                variantsHtml += `
                    <div class="variant-group">
                        <label>${label}:</label>
                        <div class="variant-buttons">${buttonsHtml}</div>
                    </div>
                `;
            }
            
            // Заменить содержимое контейнера
            variantsContainer.innerHTML = variantsHtml;
            
            // Переинициализировать обработчики событий
            initVariantButtons(variantsContainer);
            
            // Здесь также нужно создать кнопки цветов если это цветовой тип
            // Проверяем есть ли цветовые варианты (массив или 'dynamic')
            if (variantsData.color && (Array.isArray(variantsData.color) || variantsData.color === 'dynamic')) {
                await createColorButtonsForProduct(productCard, productId);
            }
        }
        
        function getModelKey(brandModel) {
            // Простая нормализация: нижний регистр + удаление пробелов, дефисов, кавычек и типографских тире
            const raw = String(brandModel || '');
            const key = raw
                .toLowerCase()
                .replace(/["'«»]/g, '')
                .replace(/[–—-]/g, '')
                .replace(/\s+/g, '');
            return key || null;
        }
        
        

        async function getDefaultColorForProduct(productCard) {
            // Получить модель товара из data-model атрибута
            const variantsElement = productCard.querySelector('.product-variants');
            if (!variantsElement || !variantsElement.dataset.model) return 'Black';
            
            const brandModel = variantsElement.dataset.model;
            
            const modelKey = getModelKey(brandModel);
            if (!modelKey) {
                return 'Black'; // Fallback цвет
            }
            
            try {
                const response = await fetch(`/color-schemes/${modelKey}`);
                if (response.ok) {
                    const data = await response.json();
                    return data.default_color || 'Black';
                }
            } catch (error) {
                console.warn('Ошибка получения цветовой схемы:', error);
            }
            
            return 'Black'; // Fallback цвет
        }
        
        // Управление каруселью изображений
        const productImages = {}; // Хранилище изображений для каждого товара
        
        function changeImage(productId, direction) {
            console.log('changeImage called:', productId, direction);
            const carousel = document.querySelector(`[data-product-id="${productId}"]`);
            if (!carousel) {
                console.log('Carousel not found for product:', productId);
                return;
            }
            
            // Найти карточку товара для определения текущего цвета
            const productCard = carousel.closest('.product-card');
            const variantsContainer = productCard?.querySelector('.product-variants');
            const activeColorButton = variantsContainer?.querySelector('.variant-btn[data-type="color"].active');
            
            let selectedColor = 'Black'; // По умолчанию черный
            
            if (activeColorButton) {
                selectedColor = activeColorButton.dataset.colorFolder || activeColorButton.dataset.value || activeColorButton.dataset.color || 'Black';
            }
            
            // Проверяем что selectedColor не undefined
            if (!selectedColor || selectedColor === 'undefined') {
                selectedColor = 'Black';
            }
            
            // Создать ключ для конкретного цвета и получить изображения
            const colorImagesKey = `${productId}-${selectedColor}`;
            
            if (!window[colorImagesKey]) {
                // Если изображения для этого цвета не загружены, создать их динамически
            
            const modelElement = productCard?.querySelector('.product-brand');
            const brandModel = modelElement?.textContent?.trim() || '';
            
            let modelFolder = 'iphone16'; // Дефолтная папка
            
            // Определяем папку изображений на основе модели
            if (brandModel.includes('16 Pro Max')) {
                modelFolder = 'iphone16promax';
            } else if (brandModel.includes('16 Pro')) {
                modelFolder = 'iphone16pro';
            } else if (brandModel.includes('16')) {
                modelFolder = 'iphone16';
            } else if (brandModel.includes('17 Pro Max')) {
                modelFolder = 'iphone17promax';
            } else if (brandModel.includes('17')) {
                modelFolder = 'iphone17';
            } else if (brandModel.includes('AirPods Pro 2')) {
                modelFolder = 'airpodspro2';
            } else if (brandModel.includes('HomePod mini')) {
                modelFolder = 'HOMEPODmini';
            } else if (brandModel.includes('iPad Air')) {
                modelFolder = 'IPADAir';
            }
            
            // Создаем список изображений только с ожидаемым количеством
            const colorImageList = [];
            
            // Определяем ожидаемое количество изображений для каждого цвета
            let expectedImageCount = 4; // По умолчанию 4 изображения
            
            // Специальные правила для разных цветов моделей
            if (selectedColor === 'White' && modelFolder === 'iphone16') {
                expectedImageCount = 3; // iPhone 16 White имеет только 3 изображения
            } else if (selectedColor === 'Silver' && modelFolder === 'iphone17promax') {
                expectedImageCount = 3; // iPhone 17 Pro Max Silver имеет 3 изображения
            } else if (selectedColor === 'Deep Blue' && modelFolder === 'iphone17promax') {
                expectedImageCount = 3; // iPhone 17 Pro Max Deep Blue имеет 3 изображения
            }
            
            // Сопоставление цветов из базы данных с названиями папок
            const colorFolderMapping = {
                'Teal': 'teal',
                'Pink': 'pink', 
                'White': 'white',
                'Black': 'black',
                'Default': 'black', // Дефолтный цвет
                'Titanium White': 'titanium-white',
                'Titanium Blue': 'titanium-blue', 
                'Titanium Natural': 'titanium-natural',
                'Titanium Black': 'titanium-black',
                'Titanium Desert': 'titanium-desert',
                'Space Black': 'space-black',
                'Silver': 'silver',
                'Deep Blue': 'deep-blue',
                'Cosmic Orange': 'cosmic-orange'
            };
            
            // Получаем правильное название папки для цвета
            const colorFolder = colorFolderMapping[selectedColor] || selectedColor.toLowerCase();
            
            // Сначала проверим есть ли уже изображения в cache от updateProductImage
            let cachedImages = window[colorImagesKey];
            if (cachedImages && cachedImages.length > 0) {
                console.log(`📸 Используем изображения из cache для ${selectedColor}:`, cachedImages);
                colorImageList = cachedImages;
            } else {
                // Если нет cached изображений, запрашиваем из API
                console.log('📸 Получаем изображения из API...');
                
                let modelKey = 'iphone16promax'; // Дефолтная папка
                if (brandModel.includes('16 Pro Max')) {
                    modelKey = 'iphone16promax';
                } else if (brandModel.includes('17 Pro Max')) {
                    modelKey = 'iphone17promax';
                }
                
                fetch(`/product-images/${modelKey}/${colorFolder}`)
                    .then(response => response.json())
                    .then(data => {
                        const timestampedImages = data.image_paths.map(img => `${img}?v=${Date.now()}`);
                        window[colorImagesKey] = timestampedImages;
                        console.log(`📸 Получены изображения из API для ${selectedColor}:`, timestampedImages);
                    })
                    .catch(error => {
                        console.error(`❌ Ошибка получения изображений для ${selectedColor}:`, error);
                        // Fallback на статические пути только если API недоступно
                        for (let i = 1; i <= expectedImageCount; i++) {
                            colorImageList.push(`/static/images/products/${modelFolder}/${colorFolder}/${i}.jpg`);
                        }
            const timestampedImages = colorImageList.map(img => `${img}?v=${Date.now()}`);
            window[colorImagesKey] = timestampedImages;
                    });
            }
            }
            
            const indicators = carousel.querySelectorAll('.indicator');
            const currentActive = carousel.querySelector('.indicator.active');
            const currentIndex = parseInt(currentActive.dataset.index);
            
            let newIndex = currentIndex + direction;
            
            // Циклическое переключение в пределах доступных изображений
            if (newIndex < 0) {
                newIndex = indicators.length - 1;
            } else if (newIndex >= indicators.length) {
                newIndex = 0;
            }
            
            // Дополнительная проверка: убедиться что для текущего цвета это изображение существует
            const currentColorImages = window[colorImagesKey];
            if (newIndex >= currentColorImages.length) {
                console.log(`Index ${newIndex} is out of range for color ${selectedColor} (only ${currentColorImages.length} images), adjusting...`);
                newIndex = Math.max(0, currentColorImages.length - 1); // перейти к последнему доступному изображению
            }
            
            console.log('Changing from index', currentIndex, 'to', newIndex);
            
            // Обновить активный индикатор
            currentActive.classList.remove('active');
            indicators[newIndex].classList.add('active');
            
            // Обновить изображение используя изображения текущего цвета (для карточки или детальной страницы)
            const img = carousel.querySelector('.product-img') || carousel.querySelector('.product-img-detail');
            const activeColorImages = window[colorImagesKey];
            
            if (activeColorImages && activeColorImages[newIndex]) {
                console.log('Changing image to:', activeColorImages[newIndex], 'color:', selectedColor);
                img.src = activeColorImages[newIndex];
            } else {
                console.log('No image found for product:', productId, 'index:', newIndex, 'color:', selectedColor);
                console.log('Available color images:', activeColorImages);
                
                // Fallback: попробовать первое доступное изображение или изображение из дефолтного цвета
                const firstImage = activeColorImages && activeColorImages.length > 0 ? activeColorImages[0] : null;
                const defaultImages = window[`${productId}-Black`];
                const fallbackImage = firstImage || (defaultImages && defaultImages[0]);
                
                if (fallbackImage) {
                    console.log('Using fallback image:', fallbackImage);
                    img.src = fallbackImage;
                } else {
                    console.warn('No fallback image available for product:', productId);
                }
            }
        }
        
        // Новая функция для смены изображений с анимацией слайда
        function changeImageWithSlide(productId, direction) {
            const carousel = document.querySelector(`[data-product-id="${productId}"]`);
            if (!carousel) {
                return;
            }
            
            // Найти карточку товара или детальную страницу для определения текущего цвета
            const productCard = carousel.closest('.product-card');
            const isDetailPage = !productCard && carousel.closest('.product-detail-page');
            
            let selectedColor = 'Black'; // По умолчанию черный
            
            if (productCard) {
                // Обычная карточка товара
                const variantsContainer = productCard.querySelector('.product-variants');
                const activeColorButton = variantsContainer?.querySelector('.variant-btn[data-type="color"].active');
                
                if (activeColorButton) {
                    selectedColor = activeColorButton.dataset.colorFolder || activeColorButton.dataset.value || activeColorButton.dataset.color || 'Black';
                }
            } else if (isDetailPage) {
                // Детальная страница - получаем цвет из выбранного варианта
                const colorInput = document.querySelector('input[name="color"]:checked');
                if (colorInput) {
                    selectedColor = colorInput.value || 'Black';
                }
            }
            
            // Проверяем что selectedColor не undefined
            if (!selectedColor || selectedColor === 'undefined') {
                selectedColor = 'Black';
            }
            
            // Создать ключ для конкретного цвета и получить изображения
            const colorImagesKey = `${productId}-${selectedColor}`;
            
            // Получаем изображения для текущего цвета
            const activeColorImages = window[colorImagesKey];
            
            if (!activeColorImages || activeColorImages.length === 0) {
                return;
            }
            
            const indicators = carousel.querySelectorAll('.indicator');
            const currentActive = carousel.querySelector('.indicator.active');
            const currentIndex = parseInt(currentActive.dataset.index);
            
            let newIndex = currentIndex + direction;
            
            // Циклическое переключение в пределах доступных изображений
            if (newIndex < 0) {
                newIndex = indicators.length - 1;
            } else if (newIndex >= indicators.length) {
                newIndex = 0;
            }
            
            // Дополнительная проверка: убедиться что для текущего цвета это изображение существует
            if (newIndex >= activeColorImages.length) {
                console.log(`Index ${newIndex} is out of range for color ${selectedColor} (only ${activeColorImages.length} images), adjusting...`);
                newIndex = Math.max(0, activeColorImages.length - 1);
            }
            
            console.log('Changing from index', currentIndex, 'to', newIndex);
            
            // Создаем или получаем контейнер для слайдов
            let slideContainer = carousel.querySelector('.image-slide-container');
            if (!slideContainer) {
                // Создаем структуру для слайдов (для карточки или детальной страницы)
                const currentImg = carousel.querySelector('.product-img') || carousel.querySelector('.product-img-detail');
                if (currentImg) {
                    slideContainer = document.createElement('div');
                    slideContainer.className = 'image-slide-container';
                    
                    const slideWrapper = document.createElement('div');
                    slideWrapper.className = 'image-slide-wrapper';
                    slideWrapper.style.transform = `translateX(-${currentIndex * 100}%)`;
                    
                    // Создаем слайды для всех изображений
                    activeColorImages.forEach((imageSrc, index) => {
                        const slideItem = document.createElement('div');
                        slideItem.className = 'image-slide-item';
                        if (index === currentIndex) {
                            slideItem.classList.add('fade-in');
                        }
                        
                        const img = document.createElement('img');
                        img.src = imageSrc;
                        img.alt = `Product image ${index + 1}`;
                        img.style.opacity = index === currentIndex ? '1' : '0';
                        
                        slideItem.appendChild(img);
                        slideWrapper.appendChild(slideItem);
                    });
                    
                    slideContainer.appendChild(slideWrapper);
                    
                    // Заменяем старое изображение на новую структуру
                    currentImg.parentNode.replaceChild(slideContainer, currentImg);
                }
            }
            
            if (slideContainer) {
                const slideWrapper = slideContainer.querySelector('.image-slide-wrapper');
                const slideItems = slideContainer.querySelectorAll('.image-slide-item');
                
                // Анимация перехода
                slideWrapper.style.transition = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                slideWrapper.style.transform = `translateX(-${newIndex * 100}%)`;
                
                // Обновляем видимость изображений
                slideItems.forEach((item, index) => {
                    const img = item.querySelector('img');
                    if (index === newIndex) {
                        img.style.opacity = '1';
                        item.classList.add('fade-in');
                        item.classList.remove('fade-out');
                    } else {
                        img.style.opacity = '0';
                        item.classList.remove('fade-in');
                        if (index === currentIndex) {
                            item.classList.add('fade-out');
                        }
                    }
                });
                
                // Убираем класс fade-out после анимации
                setTimeout(() => {
                    slideItems.forEach(item => {
                        item.classList.remove('fade-out');
                    });
                }, 300);
            }
            
            // Обновить активный индикатор
            currentActive.classList.remove('active');
            indicators[newIndex].classList.add('active');
        }
        
        // Добавляем поддержку свайпов только для мобильных устройств
        function addSwipeSupport() {
            // Проверяем, что это мобильное устройство
            const isMobile = window.innerWidth <= 768 || 
                            ('ontouchstart' in window) ||
                            /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (!isMobile) {
                console.log('Desktop device detected, skipping swipe support');
                return;
            }
            
            const carousels = document.querySelectorAll('.product-image-carousel, .product-image-carousel-detail');
            
            carousels.forEach(carousel => {
                // Проверяем, что обработчики еще не добавлены
                if (carousel.dataset.swipeInitialized === 'true') {
                    return;
                }
                
                let startX = 0;
                let startY = 0;
                let endX = 0;
                let endY = 0;
                let isSwipe = false;
                
                const handleTouchStart = (e) => {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    isSwipe = false;
                };
                
                const handleTouchMove = (e) => {
                    if (!isSwipe) {
                        endX = e.touches[0].clientX;
                        endY = e.touches[0].clientY;
                        
                        const deltaX = Math.abs(endX - startX);
                        const deltaY = Math.abs(endY - startY);
                        
                        // Определяем, что это горизонтальный свайп
                        // Только если горизонтальное движение значительно больше вертикального
                        if (deltaX > deltaY * 2 && deltaX > 30) {
                            isSwipe = true;
                        } else if (deltaY > deltaX * 2) {
                            // Если вертикальное движение значительно больше горизонтального,
                            // это явно вертикальная прокрутка - не обрабатываем
                            isSwipe = false;
                            return;
                        }
                    }
                };
                
                const handleTouchEnd = (e) => {
                    if (isSwipe) {
                        const deltaX = endX - startX;
                        const productId = carousel.dataset.productId;
                        
                        if (Math.abs(deltaX) > 20) { // Минимальное расстояние свайпа
                            if (deltaX > 0) {
                                // Свайп вправо - предыдущее изображение
                                changeImageWithSlide(parseInt(productId), -1);
                            } else {
                                // Свайп влево - следующее изображение
                                changeImageWithSlide(parseInt(productId), 1);
                            }
                        }
                    }
                };
                
                carousel.addEventListener('touchstart', handleTouchStart, { passive: true });
                carousel.addEventListener('touchmove', handleTouchMove, { passive: true });
                carousel.addEventListener('touchend', handleTouchEnd, { passive: true });
                
                // Отмечаем, что обработчики добавлены
                carousel.dataset.swipeInitialized = 'true';
            });
        }
        
        // Инициализация свайпов после загрузки контента
        function initializeSwipeSupport() {
            // Проверяем, что это мобильное устройство
            const isMobile = window.innerWidth <= 768 || 
                            ('ontouchstart' in window) ||
                            /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (!isMobile) {
                console.log('Desktop device detected, swipe support disabled');
                return;
            }
            
            console.log('Initializing swipe support for mobile device');
            
            // Добавляем поддержку свайпов для существующих каруселей
            addSwipeSupport();
            
            // Наблюдатель за изменениями DOM для новых каруселей
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === 1) { // Element node
                                if (node.classList && (node.classList.contains('product-image-carousel') || node.classList.contains('product-image-carousel-detail'))) {
                                    addSwipeSupport();
                                } else if (node.querySelectorAll) {
                                    const newCarousels = node.querySelectorAll('.product-image-carousel, .product-image-carousel-detail');
                                    if (newCarousels.length > 0) {
                                        addSwipeSupport();
                                    }
                                }
                            }
                        });
                    }
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }
        
        // Функция для проверки существования изображений
        async function checkAndFilterImages(colorImages, timestampedImages) {
            const existingImages = [];
            
            for (let i = 0; i < colorImages.length; i++) {
                try {
                    // Попробуем загрузить изображение
                    await new Promise((resolve, reject) => {
                        const img = new Image();
                        img.onload = () => resolve(colorImages[i]);
                        img.onerror = () => reject(new Error('Image not found'));
                        img.src = colorImages[i];
                    });
                    existingImages.push(timestampedImages[i]);
                } catch (error) {
                    // Изображение не существует, пропускаем
                    console.log(`Image ${i+1} not found for this color, skipping`);
                    break; // Предполагаем что после первого отсутствующего все остальные тоже отсутствуют
                }
            }
            
            return existingImages;
        }
        
        // Сохранить изображения товара при загрузке
        function storeProductImages(product) {
            if (product.images && product.images.length > 0) {
                productImages[product.id] = product.images;
                console.log('Stored images for product', product.id, ':', product.images);
            } else {
                console.log('No images for product', product.id);
            }
        }
        
        // Show loading state
        function showLoading() {
            document.getElementById('content').innerHTML = `
                <div class="page-loading">
                    <div class="spinner"><img src="/static/images/logo.jpg" alt="Loading..."></div>
                </div>
            `;
        }
        
        // Hide loading state - just clear loading indicator
        function hideLoading() {
            // Loading состояние должно очищаться автоматически когда контент обновляется
            // Эта функция служит как placeholder на случай если нужно явно скрыть loading
        }
        
        // Show error state
        function showError(message) {
            document.getElementById('content').innerHTML = `<div class="error">${message}</div>`;
        }
        
        // Telegram WebApp integration
        // Создание хлебных крошек навигации
        function createBreadcrumbs(brand = null) {
            let breadcrumbs = [];
            
            // Домашний уровень (категории)
            breadcrumbs.push(`
                <div class="breadcrumb-item">
                    <a href="javascript:void" class="breadcrumb-link" onclick="loadCategories()">Категории</a>
                </div>
            `);
            
            // Добавляем категорию (level0) - кликабельную
            if (currentLevel0Filter) {
                breadcrumbs.push(`
                    <span class="breadcrumb-separator">→</span>
                    <div class="breadcrumb-item">
                        <a href="javascript:void" class="breadcrumb-link" onclick="navigateToLevel0()">${currentLevel0Filter}</a>
                    </div>
                `);
            }
            
            // Добавляем бренд - кликабельный если есть level1 или level2
            if (brand) {
                const isClickable = currentLevel1Filter || currentLevel2Filter;
                if (isClickable) {
                    breadcrumbs.push(`
                        <span class="breadcrumb-separator">→</span>
                        <div class="breadcrumb-item">
                            <a href="javascript:void" class="breadcrumb-link" onclick="navigateToBrand('${brand}')">${brand}</a>
                        </div>
                    `);
                } else {
                    breadcrumbs.push(`
                        <span class="breadcrumb-separator">→</span>
                        <div class="breadcrumb-item">
                            <span class="breadcrumb-current">${brand}</span>
                        </div>
                    `);
                }
            }
            
            // Добавляем уровень 1 - кликабельный если есть level2
            if (currentLevel1Filter) {
                const isClickable = currentLevel2Filter !== null;
                if (isClickable) {
                    breadcrumbs.push(`
                        <span class="breadcrumb-separator">→</span>
                        <div class="breadcrumb-item">
                            <a href="javascript:void" class="breadcrumb-link" onclick="navigateToLevel1('${currentLevel1Filter}')">${currentLevel1Filter}</a>
                        </div>
                    `);
                } else {
                    breadcrumbs.push(`
                        <span class="breadcrumb-separator">→</span>
                        <div class="breadcrumb-item">
                            <span class="breadcrumb-current">${currentLevel1Filter}</span>
                        </div>
                    `);
                }
            }
            
            // Добавляем уровень 2 - всегда текущий (не кликабельный)
            if (currentLevel2Filter) {
                breadcrumbs.push(`
                    <span class="breadcrumb-separator">→</span>
                    <div class="breadcrumb-item">
                        <span class="breadcrumb-current">${currentLevel2Filter}</span>
                    </div>
                `);
            }
            
            return `
                <div class="breadcrumb-trail">
                    ${breadcrumbs.join('')}
                </div>
            `;
        }
        
        // Обновление хлебных крошек
        function updateBreadcrumbs() {
            const breadcrumbsContainer = document.getElementById('breadcrumbsContainer');
            if (breadcrumbsContainer) {
                breadcrumbsContainer.innerHTML = createBreadcrumbs(currentBrandFilter);
            }
        }
        
        // Навигация к уровню level0 (категории)
        async function navigateToLevel0() {
            if (currentCategoryId && currentCategoryName) {
                // Загружаем бренды текущей категории
                await loadSubcategories(currentCategoryId);
            } else {
                // Fallback: возвращаемся к главной странице категорий
                loadCategories();
            }
        }
        
        // Навигация к бренду (сброс level1 и level2)
        async function navigateToBrand(brand) {
            currentLevel1Filter = null;
            currentLevel2Filter = null;
            await loadFilteredProducts();
            updateBreadcrumbs();
            await createHierarchyFilters(currentBrandFilter, []);
        }
        
        // Навигация к level1 (сброс level2)
        async function navigateToLevel1(level1Value) {
            currentLevel1Filter = level1Value;
            currentLevel2Filter = null;
            await loadFilteredProducts();
            updateBreadcrumbs();
            await createHierarchyFilters(currentBrandFilter, []);
        }
        
        // Навигация к level2
        async function navigateToLevel2(level2Value) {
            currentLevel2Filter = level2Value;
            await loadFilteredProducts();
            updateBreadcrumbs();
            await createHierarchyFilters(currentBrandFilter, []);
        }

        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }

        // About modal controls
        function openAboutModal() {
            const el = document.getElementById('aboutBackdrop');
            if (el) el.style.display = 'flex';
        }
        function closeAboutModal() {
            const el = document.getElementById('aboutBackdrop');
            if (el) el.style.display = 'none';
        }
        function backdropAboutClick(event) {
            if (event.target && event.target.id === 'aboutBackdrop') {
                closeAboutModal();
            }
        }
        
        // Info modal controls (Гарантия / Доставка и оплата)
        function openInfoModal(section) {
            const backdrop = document.getElementById('infoBackdrop');
            const title = document.getElementById('infoModalTitle');
            const content = document.getElementById('infoModalContent');
            
            if (!backdrop || !title || !content) return;
            
            if (section === 'guarantee') {
                title.textContent = 'Гарантия';
                content.innerHTML = `
                    <div class="about-section">
                        <h4 style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">🛡️</span>
                            Заводской брак
                        </h4>
                        <div style="background: linear-gradient(135deg, #f0f7ff 0%, #ffffff 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #2d6cdf; margin-bottom: 16px;">
                            <p style="margin: 0 0 12px 0; font-weight: 600; color: #111827;">Гарантия на всю технику — 1 год с момента приобретения товара, от магазина. Гарантия на аксессуары, не содержащие электронные элементы — 14 дней с момента приобретения товара, от магазина.</p>
                            <p style="margin: 0;">Гарантия распространяется на заводской брак. Причину возникновения дефектов оборудования, а также их характер определяют специалисты собственного гарантийного обслуживания в ходе диагностики; срок проведения диагностики — до 21 дня. При несогласии покупателя с заключением может быть произведена независимая экспертиза в соответствии с законом «О защите прав потребителей». В течение 14 дней с момента покупки покупатель имеет право на обмен товара на новый или возврат денежных средств, но только в том случае, если по результатам диагностики было подтверждено наличие заводского брака.</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                            <p style="margin: 0 0 12px 0;">По истечении 14 дней с момента покупки неисправное оборудование с заводским браком принимается в гарантийный ремонт, срок проведения ремонта — не более 45 дней. Доставка оборудования на диагностику и гарантийный ремонт осуществляется в офис продавца силами покупателя. Если вы находитесь в другом городе, вам необходимо отправить товар к нам курьерской службой CDEK (доставка до двери или до пункта выдачи).</p>
                            <p style="margin: 0;">Доставка курьерскими службами не является услугой, связанной с заказом. Она не считается частью приобретаемого товара и заканчивается в момент получения товара. С момента передачи товара в курьерскую службу ответственность за сохранность товара также передается курьерской службе.</p>
                        </div>
                    </div>
                    <div class="about-section">
                        <h4 style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">⚠️</span>
                            На что не распространяется гарантия?
                        </h4>
                        <div style="background: #fff5f5; padding: 20px; border-radius: 12px; border-left: 4px solid #ef4444;">
                            <ul class="about-list" style="margin: 0;">
                                <li>со следами любого рода вмешательств (попыток вскрытия/разбора/ремонта и т. п.);</li>
                                <li>со следами попадания внутрь посторонних веществ/предметов/жидкостей и т. п.;</li>
                                <li>с механическими/тепловыми повреждениями;</li>
                                <li>с неисправностями, возникшими вследствие появившихся в ходе эксплуатации устройства загрязнений;</li>
                                <li>с повреждениями, вызванными неправильными подключением, эксплуатацией в нештатном режиме, либо в условиях, не предусмотренных производителем, а также произошедшими вследствие действия сторонних обстоятельств (скачков напряжения электропитания, стихийных бедствий и т. д.);</li>
                                <li>с неисправностями, возникшими вследствие внесения покупателем в устройство конструкционных, программных и иных изменений;</li>
                                <li>с «выпадением» точек ЖК-дисплея («битыми пикселями») количеством не более 4-х.</li>
                            </ul>
                        </div>
                    </div>
                    <div class="about-section">
                        <h4 style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">📋</span>
                            Какие правила сдачи и приёма устройств на диагностику или ремонт?
                        </h4>
                        <p style="margin-bottom: 16px;">Пожалуйста, выполните перечисленные ниже действия. Если устройство не включается или не реагирует на команды, постарайтесь выполнить как можно больше из этих действий. По гиперссылкам есть все необходимые инструкции.</p>
                        <div style="background: #f0fdf4; padding: 20px; border-radius: 12px; border-left: 4px solid #22c55e; margin-bottom: 16px;">
                            <ul class="about-list" style="margin: 0;">
                                <li>сохраните ваши данные* с устройства перед сдачей в ремонт, например, создайте резервную копию: <a href="https://support.apple.com/ru-ru/HT203977" target="_blank" style="color: #2d6cdf; text-decoration: none; font-weight: 600;">iPhone</a>, <a href="https://support.apple.com/ru-ru/HT203977" target="_blank" style="color: #2d6cdf; text-decoration: none; font-weight: 600;">iPad</a>, <a href="https://support.apple.com/ru-ru/HT201250" target="_blank" style="color: #2d6cdf; text-decoration: none; font-weight: 600;">Mac</a>, <a href="https://support.apple.com/ru-ru/HT205000" target="_blank" style="color: #2d6cdf; text-decoration: none; font-weight: 600;">Watch</a>.</li>
                                <li>отключите функцию локатор на устройстве, для этого потребуется пароль Apple ID**.</li>
                                <li>извлеките SIM-карту из устройства с iOS или устройства с iPadOS, если она есть, и храните её в надёжном месте.</li>
                                <li>снимите с устройства все аксессуары, чехлы, держатели, зарядки, провода, дополнительные накопители и прочее, если они не требуются для диагностики неисправности.</li>
                            </ul>
                        </div>
                        <div style="background: #fef3c7; padding: 16px; border-radius: 12px; border-left: 4px solid #f59e0b; margin-bottom: 16px;">
                            <p style="margin: 0 0 8px 0; font-size: 13px; color: #92400e; font-weight: 600;">*магазин и/или авторизованный сервисный центр не несут ответственность, если в ходе диагностики и ремонта данные, находящиеся на устройстве, будут утеряны.</p>
                            <p style="margin: 0; font-size: 13px; color: #92400e;">**если не удается отключить функцию Find My, магазин и/или компания Apple в лице авторизованного сервисного центра не смогут выполнить обслуживание устройства. Это правило установлено для того, чтобы не допустить сторонних лиц к обслуживанию устройства без вашего разрешения. Если вы забыли свой идентификатор Apple ID и пароль, перейдите на веб-сайт <a href="https://iforgot.apple.com" target="_blank" style="color: #2d6cdf; text-decoration: none; font-weight: 600;">iForgot</a>.</p>
                        </div>
                        <div style="background: linear-gradient(135deg, #2d6cdf 0%, #1f56bf 100%); padding: 16px; border-radius: 12px; text-align: center;">
                            <p style="margin: 0; font-weight: 600; color: #ffffff; font-size: 14px;">Совершение покупки означает согласие покупателя с настоящими правилами.</p>
                        </div>
                    </div>
                `;
            } else if (section === 'delivery') {
                title.textContent = 'Доставка и оплата';
                content.innerHTML = `
                    <div class="about-section">
                        <h4 style="text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <span style="font-size: 24px;">🚚</span>
                            С нами надежно
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px;">
                            <div class="info-card">
                                <h5>
                                    <span>📍</span>
                                    Самовывоз
                                </h5>
                                <p>Вы можете забрать свой заказ в нашем магазине с 10:00 до 21:00 ежедневно. Услуга действует при оформлении заказа с 10:00 до 20:00.</p>
                            </div>
                            <div class="info-card">
                                <h5>
                                    <span>🚚</span>
                                    Доставка по Москве
                                </h5>
                                <p>Доставка заказа в день обращения собственными сотрудниками компании. Обычно все заказы доставляются за 1-2 часа после оформления. Бесплатная доставка от 30 тыс. р., в других случаях — 500 р. За МКАД — рассчитывается индивидуально.</p>
                            </div>
                            <div class="info-card">
                                <h5>
                                    <span>📦</span>
                                    Доставка по России
                                </h5>
                                <p>Экспресс-доставка по России курьерской службой СДЭК. Бережная упаковка и возможность отслеживать заказ. Отправляем заказы при полной оплате. Стоимость доставки — от 500 р.</p>
                            </div>
                        </div>
                    </div>
                    <div class="about-section">
                        <h4 style="text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <span style="font-size: 24px;">💳</span>
                            Варианты оплаты
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 16px;">
                            <div class="info-card">
                                <h5>
                                    <span>💵</span>
                                    Наличный расчёт
                                </h5>
                                <p>На данный момент оплатить заказ как при самовывозе, так и при доставке по Москве и области можно только наличными. Рядом с нами есть много банкоматов (СБЕР, Альфа-Банк, Тинькофф, ВТБ, Русский Стандарт).</p>
                            </div>
                            <div class="info-card">
                                <h5>
                                    <span>🏦</span>
                                    Банковский перевод
                                </h5>
                                <p>Для клиентов из других регионов оплата возможна банковским переводом. Мы принимаем полную оплату до отправки заказа.</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            backdrop.style.display = 'flex';
        }
        
        function closeInfoModal() {
            const backdrop = document.getElementById('infoBackdrop');
            if (backdrop) backdrop.style.display = 'none';
        }
        
        function backdropInfoClick(event) {
            if (event.target && event.target.id === 'infoBackdrop') {
                closeInfoModal();
            }
        }
        
        // Cart functionality
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let appliedPromoCode = JSON.parse(localStorage.getItem('appliedPromoCode')) || null;
        let promoCodeInputValue = ''; // Сохраняем введенный текст промокода
        
        function openCart() {
            const modal = document.getElementById('cartModal');
            if (modal) {
                modal.classList.add('active');
                // Предотвращаем прокрутку body и html при открытой корзине
                document.body.style.overflow = 'hidden';
                document.documentElement.style.overflow = 'hidden';
                // Сохраняем текущую позицию скролла для восстановления
                const scrollY = window.scrollY;
                document.body.style.position = 'fixed';
                document.body.style.top = `-${scrollY}px`;
                document.body.style.width = '100%';
                // Восстанавливаем промокод из localStorage
                appliedPromoCode = JSON.parse(localStorage.getItem('appliedPromoCode')) || null;
                renderCart();
            }
        }
        
        function closeCart() {
            const modal = document.getElementById('cartModal');
            if (modal) {
                modal.classList.remove('active');
                // Восстанавливаем прокрутку body и html
                const scrollY = document.body.style.top;
                document.body.style.position = '';
                document.body.style.top = '';
                document.body.style.width = '';
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                // Восстанавливаем позицию скролла
                if (scrollY) {
                    window.scrollTo(0, parseInt(scrollY || '0') * -1);
                }
            }
        }
        
        function addToCart(productId, product) {
            // Сравниваем все варианты товара
            const existingItem = cart.find(item => {
                if (item.id !== productId) return false;
                
                // Сравниваем все варианты
                const variantsMatch = 
                    (item.color || '') === (product.selectedColor || '') &&
                    (item.memory || '') === (product.selectedMemory || '') &&
                    (item.sim || '') === (product.selectedSim || '') &&
                    (item.ram || '') === (product.selectedRam || '') &&
                    (item.ssd || '') === (product.selectedSsd || '') &&
                    (item.screen || '') === (product.selectedScreen || '') &&
                    (item.capacity || '') === (product.selectedCapacity || '');
                
                return variantsMatch;
            });
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                // Используем level_2 из продукта, если есть, иначе model, иначе name
                const level2Value = product.level_2 || product.model || product.name;
                cart.push({
                    id: productId,
                    name: level2Value,  // Используем level_2 вместо name (sku)
                    level_2: level2Value,
                    level_0: product.level_0 || null,
                    image: product.image || (product.images && product.images[0] ? product.images[0] : ''),
                    price: product.price,
                    color: product.selectedColor || '',
                    memory: product.selectedMemory || '',
                    sim: product.selectedSim || '',
                    ram: product.selectedRam || '',
                    ssd: product.selectedSsd || '',
                    screen: product.selectedScreen || '',
                    capacity: product.selectedCapacity || '',
                    quantity: 1,
                    specs: product.specs || {}
                });
            }
            
            saveCart();
            updateCartBadge();
            renderCart();
        }
        
        function removeFromCart(index) {
            cart.splice(index, 1);
            saveCart();
            updateCartBadge();
            renderCart();
        }
        
        function updateCartQty(index, delta) {
            const item = cart[index];
            item.quantity += delta;
            if (item.quantity <= 0) {
                removeFromCart(index);
            } else {
                saveCart();
                updateCartBadge();
                renderCart();
            }
        }
        
        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
        }
        
        function updateCartBadge() {
            const badge = document.getElementById('cartBadge');
            const badgeMobile = document.getElementById('cartBadgeMobile');
            const badgeFloating = document.getElementById('cartBadgeFloating');
            const totalQty = cart.reduce((sum, item) => sum + item.quantity, 0);
            if (badge) {
                if (totalQty > 0) {
                    badge.textContent = totalQty;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
            if (badgeMobile) {
                if (totalQty > 0) {
                    badgeMobile.textContent = totalQty;
                    badgeMobile.style.display = 'flex';
                } else {
                    badgeMobile.style.display = 'none';
                }
            }
            if (badgeFloating) {
                if (totalQty > 0) {
                    badgeFloating.textContent = totalQty;
                    badgeFloating.style.display = 'flex';
                } else {
                    badgeFloating.style.display = 'none';
                }
            }
        }
        
        function clearCart() {
            cart = [];
            appliedPromoCode = null;
            promoCodeInputValue = ''; // Очищаем введенный промокод при очистке корзины
            saveCart();
            savePromoCode();
            updateCartBadge();
            
            // Скрываем информацию о примененном промокоде
            const appliedInfo = document.getElementById('appliedPromoCodeInfo');
            if (appliedInfo) {
                appliedInfo.style.display = 'none';
            }
            
            // Показываем кнопку "Добавить промокод"
            const addBtn = document.getElementById('addPromoCodeBtn');
            if (addBtn) {
                addBtn.style.display = 'inline-flex';
            }
            
            // Скрываем поле ввода
            const inputSection = document.getElementById('promoCodeInputSection');
            if (inputSection) {
                inputSection.style.display = 'none';
            }
            
            // Очищаем сообщения
            const messageDiv = document.getElementById('promoCodeMessage');
            const infoDiv = document.getElementById('promoCodeInfo');
            if (messageDiv) messageDiv.textContent = '';
            if (infoDiv) infoDiv.style.display = 'none';
            
            // Очищаем поле ввода
            const input = document.getElementById('promoCodeInput');
            if (input) {
                input.value = '';
            }
            
            renderCart();
        }
        
        function savePromoCode() {
            localStorage.setItem('appliedPromoCode', JSON.stringify(appliedPromoCode));
        }
        
        function togglePromoCodeInput() {
            const inputSection = document.getElementById('promoCodeInputSection');
            const addBtn = document.getElementById('addPromoCodeBtn');
            const appliedInfo = document.getElementById('appliedPromoCodeInfo');
            
            // Если промокод уже применен, не показываем поле ввода
            if (appliedPromoCode) {
                return;
            }
            
            if (inputSection && addBtn) {
                if (inputSection.style.display === 'none') {
                    inputSection.style.display = 'block';
                    addBtn.style.display = 'none';
                    // Восстанавливаем сохраненное значение и фокусируемся на поле ввода
                    const input = document.getElementById('promoCodeInput');
                    if (input) {
                        if (promoCodeInputValue) {
                            input.value = promoCodeInputValue;
                        }
                        setTimeout(() => input.focus(), 100);
                    }
                } else {
                    inputSection.style.display = 'none';
                    addBtn.style.display = 'inline-flex';
                }
            }
        }
        
        function removePromoCode() {
            appliedPromoCode = null;
            savePromoCode();
            
            // Скрываем информацию о примененном промокоде
            const appliedInfo = document.getElementById('appliedPromoCodeInfo');
            if (appliedInfo) {
                appliedInfo.style.display = 'none';
            }
            
            // Показываем кнопку "Добавить промокод"
            const addBtn = document.getElementById('addPromoCodeBtn');
            if (addBtn) {
                addBtn.style.display = 'inline-flex';
            }
            
            // Скрываем поле ввода
            const inputSection = document.getElementById('promoCodeInputSection');
            if (inputSection) {
                inputSection.style.display = 'none';
            }
            
            // Очищаем сообщения
            const messageDiv = document.getElementById('promoCodeMessage');
            const infoDiv = document.getElementById('promoCodeInfo');
            if (messageDiv) messageDiv.textContent = '';
            if (infoDiv) infoDiv.style.display = 'none';
            
            // Сохраняем значение поля ввода (не очищаем, чтобы сохранить введенный текст)
            const input = document.getElementById('promoCodeInput');
            if (input) {
                promoCodeInputValue = input.value;
                // Не очищаем поле ввода, чтобы сохранить введенный текст
            }
            
            renderCart();
        }
        
        async function checkPromoCodeConditions() {
            // Проверяем условия промокода при обновлении корзины
            if (!appliedPromoCode) {
                return;
            }
            
            try {
                // Рассчитываем сумму корзины
                const cartTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                
                // Подготавливаем данные для проверки
                const checkData = {
                    code: appliedPromoCode.code,
                    cart_total: cartTotal,
                    items: cart.map(item => ({
                        product_id: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity,
                        color: item.color || null,
                        memory: item.memory || null,
                        sim: item.sim || null,
                        ram: item.ram || null
                    }))
                };
                
                const response = await fetch(`${API_BASE}/promo-codes/check`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(checkData)
                });
                
                const result = await response.json();
                
                if (!result.valid) {
                    // Условия не выполняются, удаляем промокод
                    appliedPromoCode = null;
                    savePromoCode();
                    
                    // Показываем сообщение
                    const messageDiv = document.getElementById('promoCodeMessage');
                    if (messageDiv) {
                        messageDiv.textContent = result.message || 'Промокод больше не действителен';
                        messageDiv.style.color = '#dc2626';
                    }
                } else {
                    // Условия выполняются, обновляем скидку
                    appliedPromoCode.discount_amount = result.discount_amount;
                    if (result.free_item_name) {
                        appliedPromoCode.free_item_name = result.free_item_name;
                    }
                    savePromoCode();
                }
            } catch (error) {
                console.error('Ошибка проверки условий промокода:', error);
            }
        }
        
        async function applyPromoCode() {
            const codeInput = document.getElementById('promoCodeInput');
            const messageDiv = document.getElementById('promoCodeMessage');
            const infoDiv = document.getElementById('promoCodeInfo');
            const btn = document.getElementById('promoCodeBtn');
            
            if (!codeInput || !messageDiv) return;
            
            const code = codeInput.value.trim().toUpperCase();
            
            if (!code) {
                messageDiv.textContent = 'Введите промокод';
                messageDiv.style.color = '#dc2626';
                infoDiv.style.display = 'none';
                return;
            }
            
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Проверка...';
            }
            
            try {
                // Рассчитываем сумму корзины
                const cartTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                
                // Подготавливаем данные для проверки
                const checkData = {
                    code: code,
                    cart_total: cartTotal,
                    items: cart.map(item => ({
                        product_id: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity,
                        color: item.color || null,
                        memory: item.memory || null,
                        sim: item.sim || null,
                        ram: item.ram || null
                    }))
                };
                
                const response = await fetch(`${API_BASE}/promo-codes/check`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(checkData)
                });
                
                const result = await response.json();
                
                if (result.valid) {
                    appliedPromoCode = {
                        code: code,
                        discount_type: result.discount_type,
                        discount_value: result.discount_value,
                        discount_amount: result.discount_amount,
                        description: result.description,
                        free_item_sku: result.free_item_sku,
                        free_item_name: result.free_item_name
                    };
                    savePromoCode();
                    
                    messageDiv.textContent = result.message || 'Промокод применен';
                    messageDiv.style.color = '#059669';
                    
                    if (result.free_item_name) {
                        infoDiv.textContent = `🎁 Бесплатно: ${result.free_item_name}`;
                        infoDiv.style.display = 'block';
                    } else {
                        infoDiv.style.display = 'none';
                    }
                    
                    // Скрываем поле ввода и показываем информацию о примененном промокоде
                    const inputSection = document.getElementById('promoCodeInputSection');
                    const addBtn = document.getElementById('addPromoCodeBtn');
                    if (inputSection) {
                        inputSection.style.display = 'none';
                    }
                    if (addBtn) {
                        addBtn.style.display = 'none';
                    }
                    
                    renderCart();
                } else {
                    appliedPromoCode = null;
                    savePromoCode();
                    
                    messageDiv.textContent = result.message || 'Промокод недействителен';
                    messageDiv.style.color = '#dc2626';
                    infoDiv.style.display = 'none';
                    
                    renderCart();
                }
            } catch (error) {
                console.error('Ошибка проверки промокода:', error);
                messageDiv.textContent = 'Ошибка проверки промокода';
                messageDiv.style.color = '#dc2626';
                infoDiv.style.display = 'none';
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Применить';
                }
            }
        }
        
        async function renderCart() {
            const itemsList = document.getElementById('cartItemsList');
            const cartTotal = document.getElementById('cartTotal');
            const cartTotalPrice = document.getElementById('cartTotalPrice');
            
            if (!itemsList) return;
            
            if (cart.length === 0) {
                itemsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">Корзина пуста</div>';
                if (cartTotal) cartTotal.style.display = 'none';
                // Очищаем промокод, если корзина пуста
                if (appliedPromoCode) {
                    appliedPromoCode = null;
                    savePromoCode();
                }
                return;
            }
            
            if (cartTotal) cartTotal.style.display = 'flex';
            
            // Проверяем условия промокода при каждом обновлении корзины
            await checkPromoCodeConditions();
            
            let total = 0;
            itemsList.innerHTML = cart.map((item, index) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                const specsText = [
                    item.color ? item.color : '',
                    item.memory ? item.memory : '',
                    item.sim ? item.sim : '',
                    item.ram ? item.ram : ''
                ].filter(s => s).join(', ');
                
                return `
                    <div class="cart-item">
                        <img src="${item.image}" alt="${item.name}" class="cart-item-image" onerror="this.src='/static/images/logo.jpg'">
                        <div class="cart-item-info">
                            <div class="cart-item-main">
                                <div class="cart-item-left">
                                    <div class="cart-item-name">${item.level_2 || item.name}</div>
                                    ${specsText ? `<div class="cart-item-specs">${specsText}</div>` : ''}
                                </div>
                                <div class="cart-item-price-qty">
                                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
                                        <span class="cart-item-price-per-unit">${Math.round(item.price).toLocaleString()} ₽ / шт.</span>
                                        <span class="cart-item-price">${Math.round(item.price * item.quantity).toLocaleString()} ₽</span>
                                    </div>
                                    <div class="qty-controls" style="margin-top: 4px;">
                                        <button class="qty-btn" onclick="updateCartQty(${index}, -1)">−</button>
                                        <span class="qty-value">${item.quantity}</span>
                                        <button class="qty-btn" onclick="updateCartQty(${index}, 1)">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('') + `
                <div style="margin-top: 16px; display: flex; justify-content: flex-end;">
                    <button class="clear-cart-btn" onclick="clearCart()">Очистить корзину</button>
                </div>
            `;
            
            const cartSubtotalPrice = document.getElementById('cartSubtotalPrice');
            const promoCodeDiscountItem = document.getElementById('promoCodeDiscountItem');
            const promoCodeDiscount = document.getElementById('promoCodeDiscount');
            const addBtn = document.getElementById('addPromoCodeBtn');
            const inputSection = document.getElementById('promoCodeInputSection');
            const appliedInfo = document.getElementById('appliedPromoCodeInfo');
            const appliedName = document.getElementById('appliedPromoCodeName');
            const appliedDesc = document.getElementById('appliedPromoCodeDesc');
            
            // Применяем промокод, если есть
            let discountAmount = 0;
            if (appliedPromoCode) {
                discountAmount = appliedPromoCode.discount_amount || 0;
                
                // Показываем информацию о примененном промокоде
                if (appliedInfo) {
                    appliedInfo.style.display = 'block';
                }
                if (appliedName) {
                    appliedName.textContent = appliedPromoCode.code;
                }
                if (appliedDesc) {
                    // Для промокодов с бесплатным товаром показываем только информацию о товаре
                    if (appliedPromoCode.free_item_name) {
                        appliedDesc.textContent = `🎁 Бесплатно: ${appliedPromoCode.free_item_name}`;
                    } else {
                        // Для других промокодов показываем описание
                        appliedDesc.textContent = appliedPromoCode.description || '';
                    }
                }
                
                // Скрываем кнопку "Добавить промокод" и поле ввода
                if (addBtn) {
                    addBtn.style.display = 'none';
                }
                if (inputSection) {
                    inputSection.style.display = 'none';
                }
            } else {
                // Скрываем информацию о примененном промокоде
                if (appliedInfo) {
                    appliedInfo.style.display = 'none';
                }
                
                // Проверяем, открыто ли поле ввода промокода
                // Используем computed style для более точной проверки
                let isInputSectionVisible = false;
                if (inputSection) {
                    const computedStyle = window.getComputedStyle(inputSection);
                    isInputSectionVisible = computedStyle.display !== 'none';
                }
                
                // Показываем кнопку "Добавить промокод" только если поле ввода закрыто
                if (addBtn) {
                    if (!isInputSectionVisible) {
                        addBtn.style.display = 'inline-flex';
                    } else {
                        // Если поле ввода открыто, скрываем кнопку
                        addBtn.style.display = 'none';
                    }
                }
                
                // Восстанавливаем введенный текст промокода (не очищаем)
                const promoCodeInput = document.getElementById('promoCodeInput');
                if (promoCodeInput && !appliedPromoCode) {
                    // Сохраняем текущее значение, если оно есть
                    if (promoCodeInput.value) {
                        promoCodeInputValue = promoCodeInput.value;
                    } else if (promoCodeInputValue) {
                        // Восстанавливаем сохраненное значение
                        promoCodeInput.value = promoCodeInputValue;
                    }
                }
            }
            
            // Показываем или скрываем строку со скидкой
            if (promoCodeDiscountItem) {
                if (discountAmount > 0) {
                    promoCodeDiscountItem.style.display = 'flex';
                    if (promoCodeDiscount) {
                        promoCodeDiscount.textContent = `-${Math.round(discountAmount).toLocaleString()} ₽`;
                    }
                } else {
                    promoCodeDiscountItem.style.display = 'none';
                }
            }
            
            // Доставка не включается в итоговую сумму
            const finalTotal = Math.max(0, total - discountAmount);
            
            if (cartSubtotalPrice) {
                cartSubtotalPrice.textContent = `${Math.round(total).toLocaleString()} ₽`;
            }
            if (cartTotalPrice) {
                cartTotalPrice.textContent = `${Math.round(finalTotal).toLocaleString()} ₽`;
            }
            
            // Загружаем рекомендации
            await loadCartRecommendations();
        }
        
        async function loadCartRecommendations() {
            const recommendationsSection = document.getElementById('cartRecommendations');
            const recommendationsList = document.getElementById('cartRecommendationsList');
            
            if (!recommendationsSection || !recommendationsList) return;
            
            // Показываем рекомендации только если в корзине есть товары
            if (cart.length === 0) {
                recommendationsSection.style.display = 'none';
                stopRecommendationsAutoSlide(); // Останавливаем автопереключение
                return;
            }
            
            try {
                // Получаем список всех товаров
                const response = await fetch(`${API_BASE}/products?limit=100`);
                if (!response.ok) {
                    recommendationsSection.style.display = 'none';
                    return;
                }
                
                const allProducts = await response.json();
                
                // Получаем ID товаров, которые уже в корзине
                const cartProductIds = new Set(cart.map(item => item.id));
                const cartLevel2s = new Set(cart.map(item => item.level_2).filter(Boolean));
                // Получаем категории товаров, которые уже в корзине
                const cartLevel0s = new Set(cart.map(item => item.level_0).filter(Boolean));
                
                // Фильтруем товары: исключаем те, что уже в корзине (по ID, по level_2 и по level_0)
                const availableProducts = allProducts.filter(product => {
                    // Исключаем товары с теми же ID
                    if (cartProductIds.has(product.id)) return false;
                    
                    // Исключаем товары с теми же level_2 (моделями)
                    if (product.level_2 && cartLevel2s.has(product.level_2)) return false;
                    
                    // Исключаем товары из тех же категорий (level_0)
                    if (product.level_0 && cartLevel0s.has(product.level_0)) return false;
                    
                    // Показываем только товары с ценой
                    if (!product.price || product.price <= 0) return false;
                    
                    return true;
                });
                
                // Если нет доступных товаров, скрываем секцию
                if (availableProducts.length === 0) {
                    recommendationsSection.style.display = 'none';
                    stopRecommendationsAutoSlide(); // Останавливаем автопереключение
                    return;
                }
                
                // Выбираем случайные 6 товаров (3 пары)
                const shuffled = availableProducts.sort(() => 0.5 - Math.random());
                const recommendations = shuffled.slice(0, Math.min(6, shuffled.length));
                
                // Получаем варианты для всех рекомендованных товаров параллельно
                const recommendationsWithVariants = await Promise.all(recommendations.map(async (product) => {
                    let specsText = '';
                    try {
                        // Используем level_2 (модель) для получения вариантов
                        const model = product.level_2 || product.model || '';
                        if (model) {
                            const variantsResponse = await fetch(`${API_BASE}/products/${encodeURIComponent(model)}/variants`);
                            if (variantsResponse.ok) {
                                const variantsData = await variantsResponse.json();
                                if (variantsData.variants && variantsData.variants.length > 0) {
                                    const firstVariant = variantsData.variants[0];
                                    const specs = [
                                        firstVariant.color || '',
                                        firstVariant.memory || '',
                                        firstVariant.sim_type || '',
                                        firstVariant.ram || ''
                                    ].filter(s => s);
                                    specsText = specs.join(', ');
                                }
                            }
                        }
                    } catch (error) {
                        console.warn('Ошибка получения вариантов для рекомендации:', error);
                    }
                    return { ...product, specsText };
                }));
                
                // Разделяем товары на пары (по 2 товара)
                const pairs = [];
                for (let i = 0; i < recommendationsWithVariants.length; i += 2) {
                    pairs.push(recommendationsWithVariants.slice(i, i + 2));
                }
                
                // Функция для создания HTML товара
                const createProductHTML = (product) => {
                    const price = Math.round(product.price || 0);
                    const oldPrice = product.old_price ? Math.round(product.old_price) : null;
                    const imageUrl = product.image_url || '/static/images/logo.jpg';
                    const productName = product.level_2 || product.name || 'Товар';
                    
                    return `
                        <div class="cart-recommendation-item">
                            <img src="${imageUrl}" alt="${productName}" class="cart-recommendation-image" onerror="this.src='/static/images/logo.jpg'">
                            <div class="cart-recommendation-info">
                                <div class="cart-recommendation-name">${productName}</div>
                                ${product.specsText ? `<div class="cart-item-specs">${product.specsText}</div>` : ''}
                                <div class="cart-recommendation-price">
                                    ${price.toLocaleString()} ₽
                                    ${oldPrice && oldPrice > price ? `<span style="font-size: 0.75rem; color: #6b7280; text-decoration: line-through; margin-left: 6px;">${oldPrice.toLocaleString()} ₽</span>` : ''}
                                </div>
                            </div>
                            <button class="cart-recommendation-add-btn" onclick="addRecommendedProductToCart(${product.id}, '${productName.replace(/'/g, "\\'")}', ${price}, '${imageUrl.replace(/'/g, "\\'")}', '${(product.level_2 || '').replace(/'/g, "\\'")}')">
                                Добавить
                            </button>
                        </div>
                    `;
                };
                
                // Создаем слайды для каждой пары
                const slidesHTML = pairs.map((pair, index) => `
                    <div class="cart-recommendations-slide" data-slide="${index}">
                        ${pair.map(createProductHTML).join('')}
                    </div>
                `).join('');
                
                // Создаем индикаторы (точки)
                const dotsHTML = pairs.map((_, index) => `
                    <div class="cart-recommendations-dot ${index === 0 ? 'active' : ''}" onclick="stopRecommendationsAutoSlide(); switchRecommendationSlide(${index}, true)"></div>
                `).join('');
                
                // Отображаем рекомендации со слайдером
                recommendationsList.innerHTML = `
                    <div class="cart-recommendations-slider" id="cartRecommendationsSlider">
                        ${slidesHTML}
                    </div>
                    <div class="cart-recommendations-dots">
                        ${dotsHTML}
                    </div>
                `;
                
                // Сбрасываем на первый слайд
                currentRecommendationSlide = 0;
                
                // Инициализируем свайп
                initRecommendationsSwipe();
                
                // Запускаем автоматическое переключение
                startRecommendationsAutoSlide();
                
                recommendationsSection.style.display = 'block';
            } catch (error) {
                console.error('Ошибка загрузки рекомендаций:', error);
                recommendationsSection.style.display = 'none';
                stopRecommendationsAutoSlide(); // Останавливаем автопереключение
            }
        }
        
        let currentRecommendationSlide = 0;
        let recommendationsSlider = null;
        let recommendationsStartX = 0;
        let recommendationsCurrentX = 0;
        let recommendationsIsDragging = false;
        let recommendationsAutoSlideInterval = null;
        
        function switchRecommendationSlide(slideIndex, restartAutoSlide = false) {
            const slider = document.getElementById('cartRecommendationsSlider');
            const dots = document.querySelectorAll('.cart-recommendations-dot');
            if (!slider) return;
            
            currentRecommendationSlide = slideIndex;
            slider.style.transform = `translateX(-${slideIndex * 100}%)`;
            
            // Обновляем активную точку
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === slideIndex);
            });
            
            // Перезапускаем автоматическое переключение только если явно указано
            if (restartAutoSlide) {
                startRecommendationsAutoSlide();
            }
        }
        
        function startRecommendationsAutoSlide() {
            // Останавливаем предыдущий интервал
            if (recommendationsAutoSlideInterval) {
                clearInterval(recommendationsAutoSlideInterval);
            }
            
            // Получаем количество слайдов
            const dots = document.querySelectorAll('.cart-recommendations-dot');
            const totalSlides = dots.length;
            if (totalSlides <= 1) return; // Не нужно автопереключение, если слайд один
            
            // Запускаем автоматическое переключение каждые 5 секунд
            recommendationsAutoSlideInterval = setInterval(() => {
                const nextSlide = (currentRecommendationSlide + 1) % totalSlides;
                switchRecommendationSlide(nextSlide, false); // Не перезапускаем интервал при автопереключении
            }, 5000);
        }
        
        function stopRecommendationsAutoSlide() {
            if (recommendationsAutoSlideInterval) {
                clearInterval(recommendationsAutoSlideInterval);
                recommendationsAutoSlideInterval = null;
            }
        }
        
        function initRecommendationsSwipe() {
            const slider = document.getElementById('cartRecommendationsSlider');
            if (!slider) return;
            
            recommendationsSlider = slider;
            
            // Touch events для мобильных устройств
            slider.addEventListener('touchstart', (e) => {
                recommendationsStartX = e.touches[0].clientX;
                recommendationsIsDragging = true;
                stopRecommendationsAutoSlide(); // Останавливаем автопереключение при взаимодействии
            });
            
            slider.addEventListener('touchmove', (e) => {
                if (!recommendationsIsDragging) return;
                recommendationsCurrentX = e.touches[0].clientX;
                const diff = recommendationsStartX - recommendationsCurrentX;
                slider.style.transform = `translateX(calc(-${currentRecommendationSlide * 100}% - ${diff}px))`;
            });
            
            slider.addEventListener('touchend', () => {
                if (!recommendationsIsDragging) return;
                recommendationsIsDragging = false;
                
                const diff = recommendationsStartX - recommendationsCurrentX;
                const threshold = 50; // Минимальное расстояние для свайпа
                
                if (Math.abs(diff) > threshold) {
                    if (diff > 0 && currentRecommendationSlide < 2) {
                        // Свайп влево - следующий слайд
                        switchRecommendationSlide(currentRecommendationSlide + 1, true);
                    } else if (diff < 0 && currentRecommendationSlide > 0) {
                        // Свайп вправо - предыдущий слайд
                        switchRecommendationSlide(currentRecommendationSlide - 1, true);
                    } else {
                        // Возвращаемся к текущему слайду
                        switchRecommendationSlide(currentRecommendationSlide, true);
                    }
                } else {
                    // Возвращаемся к текущему слайду
                    switchRecommendationSlide(currentRecommendationSlide, true);
                }
            });
            
            // Mouse events для десктопа
            slider.addEventListener('mousedown', (e) => {
                recommendationsStartX = e.clientX;
                recommendationsIsDragging = true;
                slider.style.cursor = 'grabbing';
                stopRecommendationsAutoSlide(); // Останавливаем автопереключение при взаимодействии
            });
            
            slider.addEventListener('mousemove', (e) => {
                if (!recommendationsIsDragging) return;
                e.preventDefault();
                recommendationsCurrentX = e.clientX;
                const diff = recommendationsStartX - recommendationsCurrentX;
                slider.style.transform = `translateX(calc(-${currentRecommendationSlide * 100}% - ${diff}px))`;
            });
            
            slider.addEventListener('mouseup', () => {
                if (!recommendationsIsDragging) return;
                recommendationsIsDragging = false;
                slider.style.cursor = 'grab';
                
                const diff = recommendationsStartX - recommendationsCurrentX;
                const threshold = 50;
                
                if (Math.abs(diff) > threshold) {
                    if (diff > 0 && currentRecommendationSlide < 2) {
                        switchRecommendationSlide(currentRecommendationSlide + 1, true);
                    } else if (diff < 0 && currentRecommendationSlide > 0) {
                        switchRecommendationSlide(currentRecommendationSlide - 1, true);
                    } else {
                        switchRecommendationSlide(currentRecommendationSlide, true);
                    }
                } else {
                    switchRecommendationSlide(currentRecommendationSlide, true);
                }
            });
            
            slider.addEventListener('mouseleave', () => {
                if (recommendationsIsDragging) {
                    recommendationsIsDragging = false;
                    slider.style.cursor = 'grab';
                    switchRecommendationSlide(currentRecommendationSlide, true);
                }
            });
            
            slider.style.cursor = 'grab';
        }
        
        async function addRecommendedProductToCart(productId, productName, price, imageUrl, level2) {
            try {
                // Получаем информацию о товаре для добавления в корзину
                const response = await fetch(`${API_BASE}/products/${productId}`);
                if (!response.ok) {
                    throw new Error('Товар не найден');
                }
                
                const product = await response.json();
                
                // Получаем варианты товара по модели (level_2)
                const model = level2 || product.level_2 || product.model || '';
                let variants = {};
                if (model) {
                    const variantsResponse = await fetch(`${API_BASE}/products/${encodeURIComponent(model)}/variants`);
                    if (variantsResponse.ok) {
                        const variantsData = await variantsResponse.json();
                        if (variantsData.variants && variantsData.variants.length > 0) {
                            // Берем первый вариант по умолчанию
                            const firstVariant = variantsData.variants[0];
                            variants = {
                                color: firstVariant.color || '',
                                memory: firstVariant.memory || '',
                                sim: firstVariant.sim_type || '',
                                ram: firstVariant.ram || '',
                                ssd: firstVariant.ssd || '',
                                screen: firstVariant.screen || '',
                                capacity: firstVariant.capacity || ''
                            };
                        }
                    }
                }
                
                // Добавляем товар в корзину
                const productData = {
                    id: productId,
                    name: productName,
                    level_2: level2 || product.level_2 || product.model || productName,
                    level_0: product.level_0 || null,
                    image: imageUrl,
                    price: price,
                    selectedColor: variants.color || '',
                    selectedMemory: variants.memory || '',
                    selectedSim: variants.sim || '',
                    selectedRam: variants.ram || '',
                    selectedSsd: variants.ssd || '',
                    selectedScreen: variants.screen || '',
                    selectedCapacity: variants.capacity || '',
                    specs: {}
                };
                
                addToCart(productId, productData);
                updateCartBadge();
                renderCart();
                
                // Показываем уведомление
                showNotification('success', 'Товар добавлен', `${productName} добавлен в корзину`);
            } catch (error) {
                console.error('Ошибка добавления товара в корзину:', error);
                showNotification('error', 'Ошибка', 'Не удалось добавить товар в корзину');
            }
        }
        
        async function submitCart(event) {
            event.preventDefault();
            const form = event.target;
            const submitBtn = document.getElementById('cartSubmitBtn');
            
            if (cart.length === 0) {
                alert('Корзина пуста');
                return;
            }
            
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Отправка...';
            }
            
            const formData = new FormData(form);
            const shippingType = formData.get('shipping_type') || 'delivery';
            const contactMethod = formData.get('contact_method') || '';
            
            // Получаем контактные данные в зависимости от выбранного способа связи
            let contactValue = '';
            if (contactMethod === 'phone') {
                contactValue = formData.get('contact_phone') || '';
                if (!contactValue) {
                    alert('Пожалуйста, укажите телефон для связи');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Оформить заказ';
                    }
                    return;
                }
            } else if (contactMethod === 'email') {
                contactValue = formData.get('contact_email') || '';
                if (!contactValue) {
                    alert('Пожалуйста, укажите email для связи');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Оформить заказ';
                    }
                    return;
                }
            } else if (contactMethod === 'telegram') {
                contactValue = formData.get('contact_telegram') || '';
                if (!contactValue) {
                    alert('Пожалуйста, укажите Telegram username');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Оформить заказ';
                    }
                    return;
                }
            } else if (contactMethod === 'whatsapp') {
                contactValue = formData.get('contact_whatsapp') || '';
                if (!contactValue) {
                    alert('Пожалуйста, укажите WhatsApp номер');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Оформить заказ';
                    }
                    return;
                }
            }
            
            const orderData = {
                customer: {
                    name: formData.get('name'),
                    contact_method: contactMethod,
                    contact_value: contactValue,
                    address: formData.get('address') || '',
                    comment: formData.get('comment') || ''
                },
                shipping: {
                    type: shippingType,
                    delivery_option: formData.get('delivery_option') || '',
                    pickup_address: shippingType === 'pickup' ? 'г. Москва, ул. Примерная, 10, офис 5' : ''
                },
                delivery_datetime: formData.get('delivery_datetime') || '',
                items: cart.map(item => ({
                    product_id: item.id,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity,
                    color: item.color || null,
                    memory: item.memory || null,
                    sim: item.sim || null,
                    ram: item.ram || null
                })),
                total: Math.max(0, cart.reduce((sum, item) => sum + (item.price * item.quantity), 0) - (appliedPromoCode ? (appliedPromoCode.discount_amount || 0) : 0)),
                promo_code: appliedPromoCode ? appliedPromoCode.code : null,
                discount_amount: appliedPromoCode ? (appliedPromoCode.discount_amount || 0) : 0
            };
            
            try {
                const response = await fetch(`${API_BASE}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                if (response.ok) {
                    const orderResponse = await response.json();
                    showNotification('success', 'Заказ успешно оформлен!', `Номер заказа: ${orderResponse.order_number}. Мы свяжемся с вами в ближайшее время.`);
                    cart = [];
                    appliedPromoCode = null;
                    saveCart();
                    savePromoCode();
                    updateCartBadge();
                    renderCart();
                    form.reset();
                    closeCart();
                } else {
                    const error = await response.text();
                    showNotification('error', 'Ошибка оформления заказа', error || 'Произошла ошибка при оформлении заказа. Попробуйте еще раз.');
                }
            } catch (error) {
                console.error('Ошибка отправки заказа:', error);
                showNotification('error', 'Ошибка отправки заказа', 'Не удалось отправить заказ. Попробуйте позже или свяжитесь с нами по телефону.');
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Оформить заказ';
                }
            }
        }
        
        // Show notification
        function showNotification(type, title, message) {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notif => {
                notif.classList.add('hiding');
                setTimeout(() => notif.remove(), 300);
            });
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const iconSvg = type === 'success' 
                ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>'
                : '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';
            
            notification.innerHTML = `
                <button class="notification-close" onclick="this.closest('.notification').classList.add('hiding'); setTimeout(() => this.closest('.notification').remove(), 300);">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
                <div class="notification-header">
                    <div class="notification-icon">
                        ${iconSvg}
                    </div>
                    <div class="notification-title">${title}</div>
                </div>
                <div class="notification-message">${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                notification.classList.add('hiding');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
        
        // Helper function to get selected variants from product card or details page
        function getSelectedVariants(productId) {
            // Ищем карточку товара
            const productCard = document.querySelector(`[data-product-id="${productId}"]`)?.closest('.product-card');
            
            if (!productCard) return { color: '', memory: '', sim: '', ram: '', ssd: '', screen: '', capacity: '' };
            
            const variantsContainer = productCard.querySelector('.product-variants');
            if (!variantsContainer) return { color: '', memory: '', sim: '', ram: '', ssd: '', screen: '', capacity: '' };
            
            const selectedVariants = {};
            const activeButtons = variantsContainer.querySelectorAll('.variant-btn.active');
            activeButtons.forEach(btn => {
                const type = btn.dataset.type;
                // Получаем значение в зависимости от типа варианта
                let value = '';
                if (type === 'color') {
                    value = btn.dataset.color || btn.dataset.value || '';
                } else if (type === 'memory') {
                    value = btn.dataset.memory || btn.dataset.value || '';
                } else if (type === 'sim') {
                    value = btn.dataset.sim || btn.dataset.value || '';
                } else if (type === 'ram') {
                    value = btn.dataset.ram || btn.dataset.value || '';
                } else if (type === 'ssd') {
                    value = btn.dataset.ssd || btn.dataset.value || '';
                } else if (type === 'screen') {
                    value = btn.dataset.screen || btn.dataset.value || '';
                } else if (type === 'capacity') {
                    value = btn.dataset.capacity || btn.dataset.value || '';
                } else {
                    value = btn.dataset.value || '';
                }
                
                if (type && value) {
                    selectedVariants[type] = value;
                }
            });
            
            return {
                color: selectedVariants.color || '',
                memory: selectedVariants.memory || '',
                sim: selectedVariants.sim || '',
                ram: selectedVariants.ram || '',
                ssd: selectedVariants.ssd || '',
                screen: selectedVariants.screen || '',
                capacity: selectedVariants.capacity || ''
            };
        }
        
        // Add product to cart from product card
        async function addProductToCart(productId, modelKey, clickEvent) {
            try {
                // Get product data
                const response = await fetch(`${API_BASE}/products/${productId}`);
                if (!response.ok) {
                    alert('Ошибка загрузки товара');
                    return;
                }
                
                const product = await response.json();
                
                // Get selected variants
                const variants = getSelectedVariants(productId);
                
                // Get current price (with variants)
                const priceElement = document.querySelector(`#price-${productId}`);
                let currentPrice = product.price;
                if (priceElement) {
                    const priceText = priceElement.textContent.replace(/[^\d]/g, '');
                    currentPrice = parseInt(priceText) || product.price;
                }
                
                // Получаем изображение для выбранного цвета
                let productImage = '';
                if (variants.color) {
                    try {
                        // Получаем modelKey для API запроса
                        const brandModel = product.model || product.name || '';
                        const modelKey = getModelKey(brandModel);
                        if (modelKey && variants.color) {
                            // Запрашиваем изображения для выбранного цвета
                            const imageResponse = await fetch(`/product-images/${modelKey}/${encodeURIComponent(variants.color)}`);
                            if (imageResponse.ok) {
                                const imageData = await imageResponse.json();
                                if (imageData.image_paths && imageData.image_paths.length > 0) {
                                    productImage = imageData.image_paths[0];
                                }
                            }
                        }
                    } catch (error) {
                        console.warn('Ошибка получения изображения для цвета:', error);
                    }
                }
                
                // Если изображение для цвета не найдено, используем первое доступное
                if (!productImage) {
                    if (product.images && product.images.length > 0) {
                        productImage = product.images[0];
                    } else if (product.image_url) {
                        productImage = product.image_url;
                    }
                }
                
                // Для одного товара level_2 может быть в поле model, так как ProductDetailResponse не имеет level_2
                const level2Value = product.level_2 || product.model || product.name;
                
                const productData = {
                    id: product.id,
                    level_2: level2Value,
                    level_0: product.level_0 || null,
                    name: product.name,
                    image: productImage,
                    price: currentPrice,
                    selectedColor: variants.color || '',
                    selectedMemory: variants.memory || '',
                    selectedSim: variants.sim || '',
                    selectedRam: variants.ram || '',
                    selectedSsd: variants.ssd || '',
                    selectedScreen: variants.screen || '',
                    selectedCapacity: variants.capacity || '',
                    specs: {}
                };
                
                addToCart(productId, productData);
                
                // Show confirmation with smooth animation
                if (clickEvent && clickEvent.target) {
                    const btn = clickEvent.target.closest('.add-to-cart-btn');
                    if (btn) {
                        const textSpan = btn.querySelector('.add-to-cart-btn-text');
                        const iconSvg = btn.querySelector('svg');
                        if (textSpan) {
                            // Fade out current text and icon
                            textSpan.classList.add('fade-out');
                            if (iconSvg) {
                                iconSvg.classList.add('hide-icon');
                            }
                            
                            setTimeout(() => {
                                // Replace with checkmark icon
                                textSpan.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                                // Center the checkmark
                                textSpan.classList.add('show-checkmark');
                                // Fade in new text (icon stays hidden)
                                textSpan.classList.remove('fade-out');
                                textSpan.classList.add('fade-in');
                                
                                setTimeout(() => {
                                    // Fade out checkmark icon
                                    textSpan.classList.remove('fade-in');
                                    textSpan.classList.add('fade-out');
                                    
                                    setTimeout(() => {
                                        // Restore original text and show icon
                                        textSpan.textContent = 'В корзину';
                                        // Remove checkmark centering
                                        textSpan.classList.remove('show-checkmark');
                                        // Fade in original text
                                        textSpan.classList.remove('fade-out');
                                        textSpan.classList.add('fade-in');
                                        if (iconSvg) {
                                            iconSvg.classList.remove('hide-icon');
                                        }
                                        
                                        setTimeout(() => {
                                            textSpan.classList.remove('fade-in');
                                        }, 300);
                                    }, 300);
                                }, 1500);
                            }, 300);
                        }
                    }
                }
                
            } catch (error) {
                console.error('Ошибка добавления в корзину:', error);
                alert('Ошибка добавления товара в корзину');
            }
        }
        
        // Add product to cart from product details page
        
        // Handle contact method change
        function handleContactMethodChange(method) {
            // Скрываем все поля контакта
            const contactFields = document.querySelectorAll('.contact-field');
            contactFields.forEach(field => {
                field.style.display = 'none';
                // Очищаем значения полей при скрытии
                const input = field.querySelector('input');
                if (input) {
                    input.value = '';
                    input.removeAttribute('required');
                }
            });
            
            // Показываем соответствующее поле в зависимости от выбора
            if (method === 'phone') {
                const phoneField = document.getElementById('contactPhoneField');
                if (phoneField) {
                    phoneField.style.display = 'block';
                    const input = phoneField.querySelector('input');
                    if (input) {
                        input.setAttribute('required', 'required');
                    }
                }
            } else if (method === 'email') {
                const emailField = document.getElementById('contactEmailField');
                if (emailField) {
                    emailField.style.display = 'block';
                    const input = emailField.querySelector('input');
                    if (input) {
                        input.setAttribute('required', 'required');
                    }
                }
            } else if (method === 'telegram') {
                const telegramField = document.getElementById('contactTelegramField');
                if (telegramField) {
                    telegramField.style.display = 'block';
                    const input = telegramField.querySelector('input');
                    if (input) {
                        input.setAttribute('required', 'required');
                    }
                }
            } else if (method === 'whatsapp') {
                const whatsappField = document.getElementById('contactWhatsAppField');
                if (whatsappField) {
                    whatsappField.style.display = 'block';
                    const input = whatsappField.querySelector('input');
                    if (input) {
                        input.setAttribute('required', 'required');
                    }
                }
            }
        }
        
        // Send order to Telegram
        function sendOrderToTelegram() {
            if (cart.length === 0) {
                alert('Корзина пуста');
                return;
            }
            
            // Получаем данные из формы (если форма заполнена)
            const form = document.getElementById('cartForm');
            let name = '';
            let contactMethod = '';
            let contactValue = '';
            let shippingType = 'delivery';
            let address = '';
            let comment = '';
            let deliveryDateTime = '';
            
            if (form) {
                const formData = new FormData(form);
                name = formData.get('name') || '';
                contactMethod = formData.get('contact_method') || '';
                
                // Получаем контактные данные в зависимости от выбранного способа связи
                if (contactMethod === 'phone') {
                    contactValue = formData.get('contact_phone') || '';
                } else if (contactMethod === 'email') {
                    contactValue = formData.get('contact_email') || '';
                } else if (contactMethod === 'telegram') {
                    contactValue = formData.get('contact_telegram') || '';
                } else if (contactMethod === 'whatsapp') {
                    contactValue = formData.get('contact_whatsapp') || '';
                }
                
                shippingType = formData.get('shipping_type') || 'delivery';
                address = formData.get('address') || '';
                comment = formData.get('comment') || '';
                deliveryDateTime = formData.get('delivery_datetime') || '';
            }
            
            // Формируем список товаров
            let itemsText = '';
            let totalPrice = 0;
            
            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                totalPrice += itemTotal;
                
                const specs = [];
                if (item.color) specs.push(item.color);
                if (item.memory) specs.push(item.memory);
                if (item.sim) specs.push(item.sim);
                const specsText = specs.length > 0 ? ` (${specs.join(', ')})` : '';
                
                itemsText += `${index + 1}. ${item.level_2 || item.name}${specsText}\n`;
                itemsText += `   Цена: ${Math.round(item.price).toLocaleString()} ₽ × ${item.quantity} = ${Math.round(itemTotal).toLocaleString()} ₽\n\n`;
            });
            
            // Рассчитываем скидку и конечную сумму
            let discountAmount = 0;
            let promoCodeText = '';
            if (appliedPromoCode) {
                discountAmount = appliedPromoCode.discount_amount || 0;
                promoCodeText = appliedPromoCode.code || '';
            }
            
            // Формируем сообщение
            // Доставка не включается в итоговую сумму
            const finalTotal = Math.max(0, totalPrice - discountAmount);
            
            let message = `Привет! Хочу сделать заказ\n\n`;
            
            // Добавляем информацию о клиенте только если она указана
            if (name) {
                message += `Имя: ${name}\n`;
            }
            
            if (contactMethod && contactValue) {
                const contactMethodText = {
                    'phone': 'Телефон',
                    'email': 'Email',
                    'telegram': 'Telegram',
                    'whatsapp': 'WhatsApp'
                }[contactMethod] || contactMethod;
                message += `Способ связи: ${contactMethodText}\n`;
                message += `Контакт: ${contactValue}\n`;
            }
            
            if (name || (contactMethod && contactValue)) {
                message += `\n`;
            }
            
            message += `Товары:\n${itemsText}`;
            
            message += `Сумма товаров: ${Math.round(totalPrice).toLocaleString()} ₽\n`;
            
            // Добавляем информацию о промокоде и скидке, если они есть
            if (appliedPromoCode) {
                message += `Промокод: ${promoCodeText}\n`;
                if (appliedPromoCode.free_item_name) {
                    message += `🎁 Бесплатно: ${appliedPromoCode.free_item_name}\n`;
                }
                if (discountAmount > 0) {
                    message += `Скидка: -${Math.round(discountAmount).toLocaleString()} ₽\n`;
                }
            }
            
            message += `Доставка: ⏤ (стоимость не включена в итоговую сумму)\n`;
            message += `Итого: ${Math.round(finalTotal).toLocaleString()} ₽\n`;
            
            if (shippingType) {
                const shippingText = shippingType === 'delivery' ? 'Доставка' : 'Самовывоз';
                message += `\nТип доставки: ${shippingText}\n`;
            }
            
            if (address) {
                message += `Адрес: ${address}\n`;
            }
            
            if (deliveryDateTime) {
                message += `Дата и время: ${deliveryDateTime}\n`;
            }
            
            if (comment) {
                message += `Комментарий: ${comment}\n`;
            }
            
            // URL-encode сообщение
            const encodedMessage = encodeURIComponent(message);
            
            // Открываем Telegram
            const telegramUrl = `https://t.me/yoo_manager?text=${encodedMessage}`;
            window.open(telegramUrl, '_blank');
        }
        
        // Shipping type toggle
        function initShippingToggle() {
            const shippingInputs = document.querySelectorAll('input[name="shipping_type"]');
            const deliverySection = document.getElementById('shippingDelivery');
            const pickupSection = document.getElementById('shippingPickup');
            const addressField = document.getElementById('customerAddress');
            const addressGroup = addressField ? addressField.closest('.form-group') : null;
            const deliveryDateTimeField = document.getElementById('deliveryDateTime');
            const deliveryDateTimeGroup = deliveryDateTimeField ? deliveryDateTimeField.closest('.form-group') : null;
            
            shippingInputs.forEach(input => {
                input.addEventListener('change', function() {
                    if (this.value === 'delivery') {
                        if (deliverySection) deliverySection.style.display = 'block';
                        if (pickupSection) pickupSection.style.display = 'none';
                        // Показываем поле адреса доставки
                        if (addressGroup) addressGroup.style.display = 'block';
                        if (deliveryDateTimeGroup) deliveryDateTimeGroup.style.display = 'block';
                    } else {
                        if (deliverySection) deliverySection.style.display = 'none';
                        if (pickupSection) pickupSection.style.display = 'block';
                        // Скрываем поле адреса доставки при самовывозе
                        if (addressGroup) addressGroup.style.display = 'none';
                        if (deliveryDateTimeGroup) deliveryDateTimeGroup.style.display = 'none';
                        // Очищаем поле адреса
                        if (addressField) addressField.value = '';
                    }
                });
            });
        }
        
        // Initialize cart badge on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateCartBadge();
        });
        
        // Initialize datetime picker
        let dateTimePicker = null;
        function initDateTimePicker() {
            const dateTimeInput = document.getElementById('deliveryDateTime');
            if (dateTimeInput) {
                // Destroy existing instance if any
                if (dateTimePicker) {
                    dateTimePicker.destroy();
                    dateTimePicker = null;
                }
                
                dateTimePicker = flatpickr(dateTimeInput, {
                    enableTime: true,
                    dateFormat: "Y-m-d H:i",
                    time_24hr: true,
                    locale: "ru",
                    minDate: "today",
                    allowInput: false,
                    clickOpens: true
                });
            }
        }
        
        // Re-initialize shipping toggle and datetime picker when cart opens
        const originalOpenCart = openCart;
        openCart = function() {
            originalOpenCart();
            setTimeout(() => {
                initShippingToggle();
                initDateTimePicker();
                
                // Инициализация формы контакта - восстановить состояние выбранного способа связи
                const contactMethodSelect = document.getElementById('contactMethod');
                if (contactMethodSelect && contactMethodSelect.value) {
                    handleContactMethodChange(contactMethodSelect.value);
                }
            }, 100);
        };
    </script>
</body>
</html>

